<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Settings - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>

    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- Container configuration (if in container mode) -->
    <script>
      // Load container config if in container environment
      if (window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1") {
        const script = document.createElement("script");
        script.src = "js/config-container.js";
        document.head.appendChild(script);
      }
    </script>
    <!-- API Manager -->
    <script src="js/api-manager.js"></script>
    <script>
      // Robust authentication check
      (function () {
        console.log("Checking authentication...");

        // Check if we have a valid token
        const token = localStorage.getItem("auth_token");
        console.log("Token found:", !!token);

        if (!token) {
          console.log("No token found, redirecting to login");
          // Use absolute path to ensure proper redirect
          window.location.href = "/login.html";
          return;
        }

        console.log("Token found, user authenticated");
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      // Initialize auth manager when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        window.authManager = new AuthManager();
        console.log("AuthManager initialized");
      });
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0">
              <a href="index.html" class="site_title"
                ><i class="fas fa-paw"></i> <span>Cockpit!</span></a
              >
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic"></div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li>
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-rocket"></i> Onboarding
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="onboard-device.html"
                          ><i class="fas fa-plus-circle"></i> Onboard Device</a
                        >
                      </li>
                      <li>
                        <a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a>
                      </li>
                      <li>
                        <a href="scan-and-add.html"
                          ><i class="fas fa-search-plus"></i> Scan & Add</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Configs <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="backup.html"><i class="fas fa-save"></i> Backup</a>
                      </li>
                      <li>
                        <a href="compare.html"><i class="fas fa-exchange-alt"></i> Compare</a>
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Ansible <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="ansible-inventory.html"><i class="fas fa-list"></i> Inventory</a>
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-wrench"></i> Settings
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a>
                      </li>
                      <li>
                        <a href="settings-templates.html"
                          ><i class="fas fa-file-code"></i> Templates</a
                        >
                      </li>
                      <li>
                        <a href="settings-git.html"
                          ><i class="fab fa-git-alt"></i> Git Management</a
                        >
                      </li>
                      <li>
                        <a href="settings-cache.html"><i class="fas fa-bolt"></i> Cache</a>
                      </li>
                      <li>
                        <a href="settings-credentials.html"
                          ><i class="fas fa-key"></i> Credentials</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a
                href="settings-nautobot.html"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Settings"
              >
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px">
                  <a
                    href="javascript:;"
                    class="user-profile dropdown-toggle"
                    aria-haspopup="true"
                    id="navbarDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <script>
                    // Immediate username update if user info is available
                    (function () {
                      const userInfo = localStorage.getItem("user_info");
                      if (userInfo) {
                        try {
                          const user = JSON.parse(userInfo);
                          const element = document.getElementById("navbar-username");
                          if (element && user) {
                            element.textContent = user.full_name || user.username || "User";
                          }
                        } catch (e) {
                          console.log("Error parsing user info:", e);
                        }
                      }
                    })();
                  </script>
                  <div
                    class="dropdown-menu dropdown-usermenu float-end"
                    aria-labelledby="navbarDropdown"
                  >
                    <a class="dropdown-item" href="javascript:;"> Profile</a>
                    <a class="dropdown-item" href="settings-nautobot.html">
                      <span class="badge bg-red float-end">50%</span>
                      <span>Settings</span>
                    </a>
                    <a class="dropdown-item" href="javascript:;">Help</a>
                    <a class="dropdown-item" href="login.html"
                      ><i class="fas fa-sign-out-alt float-end"></i> Log Out</a
                    >
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Settings Overview</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <!-- Settings Overview Content -->
            <div class="row">
              <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>
                      Configuration Settings <small>Choose a settings category to configure</small>
                    </h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li>
                        <a class="collapse-link"><i class="fas fa-chevron-up"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>

                  <div class="x_content">
                    <!-- Settings Categories -->
                    <div class="row">
                      <div class="col-md-4">
                        <div class="settings-card">
                          <a href="settings-nautobot.html" class="settings-link">
                            <div class="card">
                              <div class="card-body text-center">
                                <div class="settings-icon">
                                  <i class="fas fa-server fa-3x text-primary"></i>
                                </div>
                                <h4 class="card-title">Nautobot Settings</h4>
                                <p class="card-text">
                                  Configure your Nautobot server connection, API tokens, and
                                  authentication settings.
                                </p>
                                <div class="btn btn-primary">
                                  <i class="fas fa-cog"></i> Configure Nautobot
                                </div>
                              </div>
                            </div>
                          </a>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="settings-card">
                          <a href="settings-git.html" class="settings-link">
                            <div class="card">
                              <div class="card-body text-center">
                                <div class="settings-icon">
                                  <i class="fas fa-code-branch fa-3x text-success"></i>
                                </div>
                                <h4 class="card-title">Git Repository Settings</h4>
                                <p class="card-text">
                                  Configure Git repository settings for storing and managing device
                                  configurations.
                                </p>
                                <div class="btn btn-success">
                                  <i class="fas fa-code-branch"></i> Configure Git
                                </div>
                              </div>
                            </div>
                          </a>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="settings-card">
                          <a href="settings-templates.html" class="settings-link">
                            <div class="card">
                              <div class="card-body text-center">
                                <div class="settings-icon">
                                  <i class="fas fa-file-code fa-3x text-info"></i>
                                </div>
                                <h4 class="card-title">Template Configuration</h4>
                                <p class="card-text">
                                  Manage configuration templates from Git, file uploads, or web
                                  editor.
                                </p>
                                <div class="btn btn-info">
                                  <i class="fas fa-file-code"></i> Configure Templates
                                </div>
                              </div>
                            </div>
                          </a>
                        </div>
                      </div>
                    </div>

                    <!-- Quick Status Overview -->
                    <div class="row" style="margin-top: 40px">
                      <div class="col-md-12">
                        <h3 class="section-heading">
                          <i class="fas fa-info-circle"></i> Configuration Status
                        </h3>
                        <hr class="section-divider" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12">
                        <div class="table-responsive">
                          <table class="table table-striped">
                            <thead>
                              <tr>
                                <th>Component</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                                <th>Action</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td><i class="fas fa-server"></i> Nautobot Connection</td>
                                <td>
                                  <span class="badge badge-secondary" id="nautobot-status"
                                    >Not Configured</span
                                  >
                                </td>
                                <td id="nautobot-updated">-</td>
                                <td>
                                  <a href="settings-nautobot.html" class="btn btn-sm btn-primary"
                                    >Configure</a
                                  >
                                </td>
                              </tr>
                              <tr>
                                <td><i class="fas fa-code-branch"></i> Git Repository</td>
                                <td>
                                  <span class="badge badge-secondary" id="git-status"
                                    >Not Configured</span
                                  >
                                </td>
                                <td id="git-updated">-</td>
                                <td>
                                  <a href="settings-git.html" class="btn btn-sm btn-success"
                                    >Configure</a
                                  >
                                </td>
                              </tr>
                              <tr>
                                <td><i class="fas fa-file-code"></i> Templates</td>
                                <td>
                                  <span class="badge badge-secondary" id="templates-status"
                                    >Not Configured</span
                                  >
                                </td>
                                <td id="templates-updated">-</td>
                                <td>
                                  <a href="settings-templates.html" class="btn btn-sm btn-info"
                                    >Configure</a
                                  >
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /Settings Content -->
          </div>
        </div>
        <!-- /page content -->
      </div>
    </div>

    <!-- Custom styles for current page indication and settings cards -->
    <style>
      .current-page {
        background-color: #2a3f54 !important;
        color: #fff !important;
        border-radius: 3px;
      }

      .current-page:hover {
        background-color: #1e2b3a !important;
      }

      .section-heading {
        color: #2a3f54;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-divider {
        border-top: 2px solid #e6e9ed;
        margin-bottom: 25px;
      }

      .settings-card {
        margin-bottom: 30px;
      }

      .settings-link {
        text-decoration: none;
        color: inherit;
      }

      .settings-link:hover {
        text-decoration: none;
        color: inherit;
      }

      .settings-card .card {
        border: 1px solid #e6e9ed;
        border-radius: 10px;
        transition: all 0.3s ease;
        height: 100%;
      }

      .settings-card .card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
        transform: translateY(-2px);
      }

      .settings-icon {
        margin-bottom: 20px;
      }

      .card-title {
        color: #2a3f54;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .card-text {
        color: #6c757d;
        margin-bottom: 20px;
        min-height: 60px;
      }

      .table th {
        background-color: #f8f9fc;
        border-top: none;
        font-weight: 600;
        color: #2a3f54;
      }

      .badge {
        font-size: 0.875rem;
        padding: 0.5em 0.75em;
      }

      .badge-secondary {
        background-color: #6c757d;
      }

      .btn-sm {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
      }
    </style>

    <!-- JavaScript for Settings Overview -->
    <script>
      class SettingsOverview {
        constructor() {
          this.init();
        }

        init() {
          document.addEventListener("DOMContentLoaded", () => {
            this.loadConfigurationStatus();
            this.updateUsernameDisplay();
          });
        }

        async loadConfigurationStatus() {
          if (!window.authManager) {
            setTimeout(() => this.loadConfigurationStatus(), 500);
            return;
          }

          try {
            // Check Nautobot status
            const nautobotResponse = await window.authManager.apiRequest("/api/settings");
            if (nautobotResponse.success && nautobotResponse.data.nautobot_host) {
              this.updateStatus("nautobot-status", "Configured", "success");
            } else {
              this.updateStatus("nautobot-status", "Not Configured", "secondary");
            }

            // Check Git status
            if (nautobotResponse.success && nautobotResponse.data.git_repo_url) {
              this.updateStatus("git-status", "Configured", "success");
            } else {
              this.updateStatus("git-status", "Not Configured", "secondary");
            }

            // Check Templates status
            const templatesResponse =
              await window.authManager.apiRequest("/api/settings/templates");
            if (templatesResponse.success && templatesResponse.data.template_source) {
              this.updateStatus("templates-status", "Configured", "success");
            } else {
              this.updateStatus("templates-status", "Not Configured", "secondary");
            }
          } catch (error) {
            console.error("Error loading configuration status:", error);
          }
        }

        updateStatus(elementId, text, type) {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = text;
            element.className = `badge badge-${type}`;
          }
        }

        updateUsernameDisplay() {
          const userInfo = localStorage.getItem("user_info");
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              const sidebarElement = document.getElementById("sidebar-username");
              const navbarElement = document.getElementById("navbar-username");

              const displayName = user.full_name || user.username || "User";

              if (sidebarElement) sidebarElement.textContent = displayName;
              if (navbarElement) navbarElement.textContent = displayName;
            } catch (e) {
              console.log("Error parsing user info:", e);
            }
          }
        }
      }

      // Initialize settings overview when page loads
      const settingsOverview = new SettingsOverview();

      function logout() {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("user_info");
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>
