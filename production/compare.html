<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Config Compare - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    <script>
      // Robust authentication check
      (function() {
        console.log('Checking authentication...');
        
        // Check if we have a valid token
        const token = localStorage.getItem('auth_token');
        console.log('Token found:', !!token);
        
        if (!token) {
          console.log('No token found, redirecting to login');
          // Use correct path for Vite dev server on port 3000
          window.location.href = '/production/login.html';
          return;
        }
        
        console.log('Token found, user authenticated');
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      // Initialize auth manager when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        window.authManager = new AuthManager();
        console.log('AuthManager initialized');
        
        // Force update display after a short delay to ensure DOM is ready
        setTimeout(function() {
          if (window.authManager && window.authManager.user) {
            window.authManager.updateUserDisplay();
            console.log('Force updated user display');
          }
        }, 500);
        
        // Listen for storage changes (when user logs in from another tab/window)
        window.addEventListener('storage', function(e) {
          if (e.key === 'user_info' || e.key === 'auth_token') {
            console.log('Storage changed, refreshing auth manager');
            // Reinitialize auth manager to pick up new user data
            window.authManager = new AuthManager();
            if (window.authManager.user) {
              window.authManager.updateUserDisplay();
              console.log('Updated display after storage change');
            }
          }
        });
        
        // Check for recent login and refresh display
        const checkRecentLogin = () => {
          const userInfo = localStorage.getItem('user_info');
          const token = localStorage.getItem('auth_token');
          
          if (userInfo && token && window.authManager) {
            try {
              const user = JSON.parse(userInfo);
              if (user && (user.username !== 'Guest' && user.username !== '')) {
                // Update auth manager with fresh data
                window.authManager.user = user;
                window.authManager.token = token;
                window.authManager.updateUserDisplay();
                console.log('Refreshed display with login data:', user.username);
              }
            } catch (e) {
              console.log('Error parsing fresh user info:', e);
            }
          }
        };
        
        // Check periodically for login updates
        setTimeout(checkRecentLogin, 1000);
        setTimeout(checkRecentLogin, 2000);
        setTimeout(checkRecentLogin, 3000);
      });
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><i class="fas fa-paw"></i> <span>Cockpit!</span></a>
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
                <!-- Profile image removed -->
              </div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <script>
              // Immediate sidebar username update if user info is available
              (function() {
                console.log('=== SIDEBAR UPDATE DEBUG ===');
                
                const updateSidebar = () => {
                  const userInfo = localStorage.getItem('user_info');
                  console.log('User info for sidebar:', userInfo);
                  
                  const sidebarElement = document.getElementById('sidebar-username');
                  const welcomeElement = document.getElementById('welcome-message');
                  console.log('Sidebar element found:', !!sidebarElement);
                  console.log('Welcome element found:', !!welcomeElement);
                  
                  if (userInfo && sidebarElement) {
                    try {
                      const user = JSON.parse(userInfo);
                      console.log('Parsed user for sidebar:', user);
                      sidebarElement.textContent = user.full_name || user.username || 'User';
                      if (welcomeElement) {
                        welcomeElement.textContent = `Welcome, ${user.username || 'User'}!`;
                      }
                      console.log('Updated sidebar successfully');
                    } catch (e) {
                      console.log('Error parsing user info for sidebar:', e);
                      sidebarElement.textContent = 'Guest';
                      if (welcomeElement) {
                        welcomeElement.textContent = 'Welcome, Guest!';
                      }
                    }
                  } else if (sidebarElement) {
                    sidebarElement.textContent = 'Guest';
                    if (welcomeElement) {
                      welcomeElement.textContent = 'Welcome, Guest!';
                    }
                    console.log('No user info, set sidebar to Guest');
                  }
                };
                
                // Update immediately
                updateSidebar();
                
                // Update again after short delays to catch login updates
                setTimeout(updateSidebar, 1000);
                setTimeout(updateSidebar, 2000);
                setTimeout(updateSidebar, 3000);
              })();
            </script>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                  <li><a><i class="fas fa-rocket"></i> Onboarding <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="onboard-device.html"><i class="fas fa-plus-circle"></i> Onboard Device</a></li>
                      <li><a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-cogs"></i> Configs <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="backup.html">Backup</a></li>
                      <li><a href="compare.html" class="current-page">Compare</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
              <div class="menu_section">
                <!-- Live On section removed as requested -->
              </div>

            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Settings">
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fas fa-bars"></i></a>
              </div>
              <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px;">
                  <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <script>
                    // Immediate username update if user info is available
                    (function() {
                      console.log('=== USERNAME UPDATE DEBUG ===');
                      
                      const updateNavbar = () => {
                        const userInfo = localStorage.getItem('user_info');
                        const token = localStorage.getItem('auth_token');
                        console.log('User info:', userInfo);
                        console.log('Token:', token);
                        
                        const element = document.getElementById('navbar-username');
                        console.log('Element found:', !!element);
                        
                        if (userInfo && element) {
                          try {
                            const user = JSON.parse(userInfo);
                            console.log('Parsed user:', user);
                            const displayName = user.full_name || user.username || 'User';
                            element.textContent = displayName;
                            console.log('Set username to:', displayName);
                          } catch (e) {
                            console.log('Error parsing user info:', e);
                            element.textContent = 'Guest';
                          }
                        } else if (element) {
                          element.textContent = 'Guest';
                          console.log('No user info, set to Guest');
                        }
                      };
                      
                      // Update immediately
                      updateNavbar();
                      
                      // Update again after short delays to catch login updates
                      setTimeout(updateNavbar, 1000);
                      setTimeout(updateNavbar, 2000);
                      setTimeout(updateNavbar, 3000);
                    })();
                  </script>
                  <div class="dropdown-menu dropdown-usermenu float-end" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item"  href="javascript:;"> Profile</a>
                      <a class="dropdown-item"  href="javascript:;">
                        <span class="badge bg-red float-end">50%</span>
                        <span>Settings</span>
                      </a>
                  <a class="dropdown-item"  href="javascript:;">Help</a>
                    <a class="dropdown-item"  href="login.html"><i class="fas fa-sign-out-alt float-end"></i> Log Out</a>
                  </div>
                </li>

                <li role="presentation" class="nav-item dropdown open">
                  <a href="javascript:;" class="dropdown-toggle info-number" id="navbarDropdown1" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-envelope"></i>
                    <span class="badge bg-green">6</span>
                  </a>
                  <ul class="dropdown-menu list-unstyled msg_list" role="menu" aria-labelledby="navbarDropdown1">
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <div class="text-center">
                        <a class="dropdown-item">
                          <strong>See All Alerts</strong>
                          <i class="fas fa-angle-right"></i>
                        </a>
                      </div>
                    </li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main" style="height: 100vh; overflow-y: auto;">
          <!-- page title -->
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Compare configurations</h3>
              </div>

              <div class="title_right">
                <div class="col-md-5 col-sm-5 form-group float-end top_search">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search for configurations...">
                    <span class="input-group-btn">
                      <button class="btn btn-secondary" type="button">Go!</button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="clearfix"></div>

          <!-- File Selection Section -->
          <div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>Configuration Comparison <small>Choose files or Git commits to compare</small></h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li><a class="collapse-link"><i class="fas fa-chevron-down"></i></a></li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content" style="display: none;">
                  
                  <!-- Comparison Mode Selection -->
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label class="control-label">Comparison Mode</label>
                        <div class="btn-group w-100" role="group" id="comparisonModeToggle">
                          <input type="radio" class="btn-check" name="comparisonMode" id="fileMode" value="files" checked>
                          <label class="btn btn-outline-primary" for="fileMode">
                            <i class="fas fa-folder"></i> Files
                          </label>
                          <input type="radio" class="btn-check" name="comparisonMode" id="gitMode" value="git">
                          <label class="btn btn-outline-primary" for="gitMode">
                            <i class="fas fa-code-branch"></i> Git Commits
                          </label>
                          <input type="radio" class="btn-check" name="comparisonMode" id="historyMode" value="history">
                          <label class="btn btn-outline-primary" for="historyMode">
                            <i class="fas fa-history"></i> File History
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- File Comparison Mode -->
                  <div id="fileComparisonMode">
                    <div class="row">
                      <!-- Left File Selection -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="leftFileSelect">Source File (Left)</label>
                          <div class="input-group">
                            <select class="form-control" id="leftFileSelect">
                              <option value="">Select a file...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-folder"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Right File Selection -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="rightFileSelect">Target File (Right)</label>
                          <div class="input-group">
                            <select class="form-control" id="rightFileSelect">
                              <option value="">Select a file...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-folder"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Git Comparison Mode -->
                  <div id="gitComparisonMode" style="display: none;">
                    <div class="row">
                      <!-- Git Branch Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="gitBranchSelect">Branch</label>
                          <div class="input-group">
                            <select class="form-control" id="gitBranchSelect">
                              <option value="">Select branch...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-branch"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Left Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="leftCommitSelect">Source Commit (Left)</label>
                          <div class="input-group">
                            <select class="form-control" id="leftCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Right Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="rightCommitSelect">Target Commit (Right)</label>
                          <div class="input-group">
                            <select class="form-control" id="rightCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- File Selection within Git Mode -->
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="gitFileSelect">File to Compare (from selected commits)</label>
                          <div class="input-group">
                            <select class="form-control" id="gitFileSelect">
                              <option value="">Select a file to compare between commits...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-file-code"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- File History Mode -->
                  <div id="fileHistoryMode" style="display: none;">
                    <div class="row">
                      <!-- Branch Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyBranchSelect">Branch</label>
                          <div class="input-group">
                            <select class="form-control" id="historyBranchSelect">
                              <option value="main">main</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-branch"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyCommitSelect">Commit</label>
                          <div class="input-group">
                            <select class="form-control" id="historyCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- File Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyFileSelect">File</label>
                          <div class="input-group">
                            <select class="form-control" id="historyFileSelect">
                              <option value="">Select file...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-file-code"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Show History Button -->
                    <div class="row">
                      <div class="col-md-12">
                        <div class="text-center" style="margin-top: 15px;">
                          <button class="btn btn-primary" id="showHistoryBtn" disabled>
                            <i class="fas fa-history"></i> Show History
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- File History Display -->
                    <div class="row" id="fileHistoryDisplay" style="display: none; margin-top: 20px;">
                      <div class="col-md-12">
                        <div class="card">
                          <div class="card-header">
                            <h6 class="mb-0">
                              <i class="fas fa-clock"></i> File History: <span id="historyFileName"></span>
                            </h6>
                          </div>
                          <div class="card-body">
                            <div id="historyContent">
                              <!-- History timeline will be populated here -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- File History Information - Shared between both modes -->
                  <div class="row" id="fileHistorySection" style="display: none; margin-top: 15px;">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <h6 class="mb-0">
                            <i class="fas fa-clock"></i> File History Information
                          </h6>
                          <button type="button" class="btn btn-sm btn-outline-secondary" id="closeHistoryBtn" title="Close History">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                        <div class="card-body">
                          <div class="row">
                            <div class="col-md-6">
                              <div id="leftFileHistory">
                                <h6 class="text-muted">Source File</h6>
                                <div id="leftFileHistoryContent">
                                  <p class="text-muted"><i>Select a file to view its history</i></p>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div id="rightFileHistory">
                                <h6 class="text-muted">Target File</h6>
                                <div id="rightFileHistoryContent">
                                  <p class="text-muted"><i>Select a file to view its history</i></p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Compare Button and Controls -->
                  <div class="row">
                    <div class="col-md-12">
                      <div class="text-center" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="compareBtn" disabled>
                          <i class="fas fa-exchange-alt"></i> Compare
                        </button>
                        <button class="btn btn-secondary ms-2" id="refreshBtn">
                          <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-success ms-2" id="exportBtn" disabled>
                          <i class="fas fa-download"></i> Export Diff
                        </button>
                        <button class="btn btn-info ms-2" id="gitStatusBtn" style="display: none;">
                          <i class="fas fa-info-circle"></i> Git Status
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Comparison Results Section -->
          <div class="row" id="comparisonSection" style="display: none;">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>Comparison Results <small id="comparisonStats">Comparing files...</small></h2>
                  <ul class="nav navbar-right panel_toolbox" style="display: flex; align-items: center; gap: 8px;">
                    <li>
                      <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" id="prevDiffBtn" disabled>
                          <i class="fas fa-chevron-up"></i> Previous
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="nextDiffBtn" disabled>
                          <i class="fas fa-chevron-down"></i> Next
                        </button>
                      </div>
                    </li>
                    <li>
                      <button class="btn btn-sm btn-outline-secondary" id="toggleUnchangedBtn">
                        <i class="fas fa-eye-slash"></i> Hide Unchanged
                      </button>
                    </li>
                    <li>
                      <div class="btn-group" role="group" style="display: flex; align-items: center;">
                        <label class="btn btn-sm btn-outline-secondary" style="font-size: 11px; padding: 6px 8px; margin: 0; border-right: none; display: flex; align-items: center; height: 31px;">
                          <i class="fas fa-text-height me-1"></i> Size:
                        </label>
                        <select class="form-select btn-sm" id="fontSizeSelect" style="font-size: 11px; padding: 6px 8px; height: 31px; border-left: 1px solid #dee2e6;">
                          <option value="10">XS</option>
                          <option value="11">S</option>
                          <option value="12" selected>M</option>
                          <option value="13">L</option>
                          <option value="14">XL</option>
                        </select>
                      </div>
                    </li>
                    <li>
                      <a class="collapse-link"><i class="fas fa-chevron-up"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <!-- Diff Display Container -->
                  <div class="diff-container">
                    <div class="diff-header">
                      <div class="diff-column diff-left">
                        <h5 id="leftFileName">Source File</h5>
                      </div>
                      <div class="diff-column diff-right">
                        <h5 id="rightFileName">Target File</h5>
                      </div>
                    </div>
                    
                    <div class="diff-content" id="diffContent">
                      <div class="diff-loading text-center" style="padding: 50px;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-3">Select files to start comparison...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Custom CSS for Diff Display -->
          <style>
            .diff-container {
              border: 1px solid #e6e9ed;
              border-radius: 5px;
              overflow: hidden;
              height: calc(100vh - 80px);
            }
            
            .diff-header {
              display: flex;
              background: #f8f9fa;
              border-bottom: 1px solid #e6e9ed;
            }
            
            .diff-column {
              flex: 1;
              padding: 4px 10px;
              border-right: 1px solid #e6e9ed;
            }
            
            .diff-column:last-child {
              border-right: none;
            }
            
            .diff-column h5 {
              margin: 0;
              font-size: 13px;
              font-weight: 600;
              color: #495057;
            }
            
            .diff-content {
              height: calc(100vh - 120px);
              max-height: none;
              min-height: calc(100vh - 120px);
              overflow-y: auto;
              position: relative;
            }
            
            .diff-row {
              display: flex;
              font-family: 'Courier New', monospace;
              font-size: var(--diff-font-size, 12px);
              line-height: var(--diff-line-height, 1.1);
              border-bottom: 1px solid #f1f3f4;
            }
            
            .diff-line {
              flex: 1;
              padding: 1px 6px;
              white-space: pre;
              border-right: 1px solid #f1f3f4;
              position: relative;
            }
            
            .diff-line:last-child {
              border-right: none;
            }
            
            .diff-line-number {
              display: inline-block;
              width: 40px;
              color: #6c757d;
              text-align: right;
              margin-right: 6px;
              user-select: none;
              font-size: calc(var(--diff-font-size, 12px) - 1px);
            }
            
            .diff-line-content {
              display: inline;
            }
            
            /* Diff Colors */
            .diff-added {
              background-color: #d4edda;
              border-left: 3px solid #28a745;
            }
            
            .diff-removed {
              background-color: #f8d7da;
              border-left: 3px solid #dc3545;
            }
            
            .diff-modified {
              background-color: #e2e3e5;
              border-left: 3px solid #6c757d;
            }
            
            .diff-unchanged {
              background-color: #ffffff;
            }
            
            .diff-char-added {
              background-color: #28a745;
              color: white;
              padding: 1px 2px;
              border-radius: 2px;
            }
            
            .diff-char-removed {
              background-color: #dc3545;
              color: white;
              padding: 1px 2px;
              border-radius: 2px;
            }
            
            .diff-hidden {
              display: none;
            }
            
            .diff-expand {
              background-color: #f8f9fa;
              text-align: center;
              cursor: pointer;
              color: #007bff;
              font-style: italic;
              padding: 8px;
            }
            
            .diff-expand:hover {
              background-color: #e9ecef;
            }
            
            /* Sync Scrolling */
            .diff-content::-webkit-scrollbar {
              width: 8px;
            }
            
            .diff-content::-webkit-scrollbar-track {
              background: #f1f1f1;
            }
            
            .diff-content::-webkit-scrollbar-thumb {
              background: #c1c1c1;
              border-radius: 4px;
            }
            
            .diff-content::-webkit-scrollbar-thumb:hover {
              background: #a8a8a8;
            }
            
            /* File History Styles */
            .file-history-info {
              font-size: 13px;
            }
            
            .file-history-info p {
              margin-bottom: 5px;
            }
            
            .file-history-info strong {
              color: #495057;
            }
            
            .file-history-info code {
              background-color: #f8f9fa;
              padding: 2px 4px;
              border-radius: 3px;
              font-size: 12px;
            }
            
            #fileHistorySection .card {
              border: 1px solid #e3e6f0;
              box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            }
            
            #fileHistorySection .card-header {
              background-color: #f8f9fc;
              border-bottom: 1px solid #e3e6f0;
              padding: 0.75rem 1.25rem;
            }
            
            /* Timeline styles for File History mode */
            .timeline {
              position: relative;
              padding: 0;
              margin: 0;
            }
            
            .timeline-header {
              margin-bottom: 1rem;
              padding-bottom: 0.5rem;
              border-bottom: 1px solid #e3e6f0;
            }
            
            .timeline-item {
              position: relative;
              padding: 1rem 0 1rem 3rem;
              border-left: 2px solid #e3e6f0;
            }
            
            .timeline-item:last-child {
              border-left-color: transparent;
            }
            
            .timeline-item.timeline-current {
              border-left-color: #007bff;
            }
            
            .timeline-marker {
              position: absolute;
              left: -0.6rem;
              top: 1.2rem;
              width: 1.2rem;
              height: 1.2rem;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 0.6rem;
              border: 2px solid white;
              box-shadow: 0 0 0 2px #e3e6f0;
            }
            
            .timeline-item.timeline-current .timeline-marker {
              box-shadow: 0 0 0 2px #007bff;
            }
            
            .timeline-content {
              background: #f8f9fc;
              border: 1px solid #e3e6f0;
              border-radius: 0.35rem;
              padding: 1rem;
              margin-left: 0.5rem;
            }
            
            .timeline-item.timeline-current .timeline-content {
              background: #e7f3ff;
              border-color: #007bff;
            }
            
            .timeline-title {
              color: #5a5c69;
              font-weight: 600;
            }
            
            .timeline-time {
              font-size: 0.875rem;
            }
            
            .timeline-body {
              color: #6c757d;
            }
            
            .timeline-body p {
              margin-bottom: 0.5rem;
            }
            
            .timeline-body p:last-child {
              margin-bottom: 0;
            }
            
            .timeline-actions {
              margin-top: 0.75rem;
              padding-top: 0.75rem;
              border-top: 1px solid #e3e6f0;
            }
            
            .timeline-actions .btn {
              font-size: 0.75rem;
              padding: 0.25rem 0.5rem;
            }
          </style>

          <!-- JavaScript for Compare Functionality -->
          <script>
            class ConfigCompare {
              constructor() {
                this.files = [];
                this.currentDiffs = [];
                this.currentDiffIndex = 0;
                this.hideUnchanged = false;
                this.gitData = {
                  branches: [],
                  commits: [],
                  currentBranch: null,
                  status: null
                };
                this.init();
              }

              init() {
                // Initialize event listeners
                document.getElementById('refreshBtn').addEventListener('click', () => this.handleRefresh());
                document.getElementById('compareBtn').addEventListener('click', () => this.handleCompare());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportDiff());
                document.getElementById('prevDiffBtn').addEventListener('click', () => this.navigateDiff(-1));
                document.getElementById('nextDiffBtn').addEventListener('click', () => this.navigateDiff(1));
                document.getElementById('toggleUnchangedBtn').addEventListener('click', () => this.toggleUnchanged());
                document.getElementById('fontSizeSelect').addEventListener('change', (e) => this.changeFontSize(e.target.value));
                document.getElementById('gitStatusBtn').addEventListener('click', () => this.showGitStatus());
                document.getElementById('closeHistoryBtn').addEventListener('click', () => this.closeFileHistory());
                
                // File selection change handlers
                document.getElementById('leftFileSelect').addEventListener('change', () => {
                  this.updateCompareButton();
                  this.loadFileHistory('left');
                });
                document.getElementById('rightFileSelect').addEventListener('change', () => {
                  this.updateCompareButton();
                  this.loadFileHistory('right');
                });

                // Git selection change handlers
                document.getElementById('leftCommitSelect').addEventListener('change', () => {
                  this.populateGitFiles();
                  this.updateCompareButton();
                  this.loadGitFileHistory();
                });
                document.getElementById('rightCommitSelect').addEventListener('change', () => {
                  this.populateGitFiles();
                  this.updateCompareButton();
                  this.loadGitFileHistory();
                });
                document.getElementById('gitFileSelect').addEventListener('change', () => {
                  this.updateCompareButton();
                  this.loadGitFileHistory();
                });
                
                document.getElementById('gitBranchSelect').addEventListener('change', async (e) => {
                  const selectedBranch = e.target.value;
                  if (selectedBranch) {
                    await this.loadCommitsForBranch(selectedBranch);
                  }
                });

                // File History mode selection change handlers
                document.getElementById('historyBranchSelect').addEventListener('change', async (e) => {
                  const selectedBranch = e.target.value;
                  if (selectedBranch) {
                    await this.loadHistoryCommitsForBranch(selectedBranch);
                  }
                });
                document.getElementById('historyCommitSelect').addEventListener('change', () => {
                  this.populateHistoryFiles();
                  this.updateShowHistoryButton();
                });
                document.getElementById('historyFileSelect').addEventListener('change', () => {
                  this.updateShowHistoryButton();
                });
                document.getElementById('showHistoryBtn').addEventListener('click', () => {
                  this.showFileHistory();
                });

                // Comparison mode toggle
                document.querySelectorAll('input[name="comparisonMode"]').forEach(radio => {
                  radio.addEventListener('change', (e) => this.handleModeChange(e.target.value));
                });

                // Auto-expand file selection on load
                setTimeout(() => {
                  const collapseLink = document.querySelector('.collapse-link');
                  if (collapseLink) {
                    collapseLink.click();
                  }
                }, 100);

                // Load files and Git data on page load
                this.loadFiles();
                this.loadGitStatus();
                
                // Load saved font size preference
                this.loadFontSizePreference();
              }

              handleModeChange(mode) {
                console.log('Mode changed to:', mode);
                
                const fileMode = document.getElementById('fileComparisonMode');
                const gitMode = document.getElementById('gitComparisonMode');
                const historyMode = document.getElementById('fileHistoryMode');
                const gitStatusBtn = document.getElementById('gitStatusBtn');

                if (mode === 'files') {
                  fileMode.style.display = 'block';
                  gitMode.style.display = 'none';
                  historyMode.style.display = 'none';
                  gitStatusBtn.style.display = 'none';
                  this.updateFileHistoryVisibility();
                } else if (mode === 'git') {
                  fileMode.style.display = 'none';
                  gitMode.style.display = 'block';
                  historyMode.style.display = 'none';
                  gitStatusBtn.style.display = 'inline-block';
                  this.updateGitFileHistoryVisibility();
                } else if (mode === 'history') {
                  fileMode.style.display = 'none';
                  gitMode.style.display = 'none';
                  historyMode.style.display = 'block';
                  gitStatusBtn.style.display = 'none';
                  
                  // Add small delay to ensure DOM is ready
                  setTimeout(() => {
                    this.initializeHistoryMode();
                  }, 100);
                }
                this.updateCompareButton();
              }

              handleRefresh() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                if (mode === 'files') {
                  this.loadFiles();
                } else {
                  this.loadGitStatus();
                }
              }

              handleCompare() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                if (mode === 'files') {
                  this.compareFiles();
                } else {
                  this.compareGitCommits();
                }
              }

              async loadGitStatus() {
                try {
                  const token = localStorage.getItem('auth_token');
                  if (!token) return;
                  
                  const response = await fetch('http://localhost:8000/api/git/status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  
                  if (response.ok) {
                    this.gitData.status = await response.json();
                    this.gitData.currentBranch = this.gitData.status.current_branch;
                    this.gitData.commits = this.gitData.status.commits || [];
                    
                    await this.populateGitBranches();
                    this.populateGitCommits();
                    
                    console.log('Git status loaded:', this.gitData.status);
                  } else {
                    // Git not available, disable Git mode
                    const gitModeRadio = document.getElementById('gitMode');
                    gitModeRadio.disabled = true;
                    gitModeRadio.parentElement.classList.add('disabled');
                  }
                } catch (error) {
                  console.error('Error loading Git status:', error);
                }
              }

              async populateGitBranches() {
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch('http://localhost:8000/api/git/branches', {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });

                  if (response.ok) {
                    const data = await response.json();
                    console.log('Git branches data:', data);
                    
                    // Handle different response formats
                    let branches = [];
                    if (Array.isArray(data)) {
                      // Direct array of strings
                      branches = data;
                    } else if (data.branches && Array.isArray(data.branches)) {
                      // Array of branch objects with name property
                      branches = data.branches.map(branch => 
                        typeof branch === 'string' ? branch : branch.name
                      );
                    } else {
                      // Fallback to empty array
                      branches = [];
                    }
                    
                    this.gitData.branches = branches;
                    
                    const branchSelect = document.getElementById('gitBranchSelect');
                    
                    branchSelect.innerHTML = '<option value="">Select branch...</option>';
                    branches.forEach(branch => {
                      const option = new Option(branch, branch);
                      branchSelect.add(option);
                    });
                    
                    // Auto-select the main branch if available
                    if (branches.includes('main')) {
                      branchSelect.value = 'main';
                      await this.loadCommitsForBranch('main');
                    } else if (branches.length > 0) {
                      branchSelect.value = branches[0];
                      await this.loadCommitsForBranch(branches[0]);
                    }
                  }
                } catch (error) {
                  console.error('Error loading Git branches:', error);
                }
              }

              populateGitCommits() {
                const leftSelect = document.getElementById('leftCommitSelect');
                const rightSelect = document.getElementById('rightCommitSelect');
                
                leftSelect.innerHTML = '<option value="">Select commit...</option>';
                rightSelect.innerHTML = '<option value="">Select commit...</option>';

                if (this.gitData.commits && this.gitData.commits.length > 0) {
                  this.gitData.commits.forEach(commit => {
                    const shortHash = commit.hash.substring(0, 8);
                    const shortMessage = commit.message.length > 50 
                      ? commit.message.substring(0, 50) + '...' 
                      : commit.message;
                    const optionText = `${shortHash} - ${shortMessage}`;
                    
                    const option1 = new Option(optionText, commit.hash);
                    const option2 = new Option(optionText, commit.hash);
                    option1.title = commit.message;
                    option2.title = commit.message;
                    
                    leftSelect.add(option1);
                    rightSelect.add(option2);
                  });

                  // Auto-select first two commits for comparison
                  if (this.gitData.commits.length >= 2) {
                    leftSelect.value = this.gitData.commits[1].hash; // Older commit
                    rightSelect.value = this.gitData.commits[0].hash; // Newer commit
                    
                    // Populate files after selecting commits
                    this.populateGitFiles();
                  }
                }
                
                this.updateCompareButton();
              }

              async loadCommitsForBranch(branch) {
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/commits/${branch}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });

                  if (response.ok) {
                    this.gitData.commits = await response.json();
                    this.populateGitCommits();
                  }
                } catch (error) {
                  console.error('Error loading commits for branch:', error);
                }
              }

              async populateGitFiles() {
                try {
                  const leftCommit = document.getElementById('leftCommitSelect').value;
                  const rightCommit = document.getElementById('rightCommitSelect').value;
                  const gitFileSelect = document.getElementById('gitFileSelect');
                  
                  if (!leftCommit && !rightCommit) return;

                  const commitHash = rightCommit || leftCommit || 'HEAD';
                  const token = localStorage.getItem('auth_token');
                  
                  const response = await fetch(`http://localhost:8000/api/git/files/${commitHash}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });

                  if (response.ok) {
                    const files = await response.json();
                    gitFileSelect.innerHTML = '<option value="">Select a file to compare between commits...</option>';
                    
                    files.forEach(file => {
                      const option = new Option(file, file);
                      gitFileSelect.add(option);
                    });
                  }
                } catch (error) {
                  console.error('Error loading Git files:', error);
                }
              }

              loadFontSizePreference() {
                const savedSize = localStorage.getItem('diff_font_size') || '12';
                document.getElementById('fontSizeSelect').value = savedSize;
                this.changeFontSize(savedSize);
              }

              changeFontSize(size) {
                const fontSize = parseInt(size);
                const lineHeight = fontSize <= 11 ? 1.0 : (fontSize <= 12 ? 1.1 : 1.2);
                
                // Update CSS custom properties
                document.documentElement.style.setProperty('--diff-font-size', fontSize + 'px');
                document.documentElement.style.setProperty('--diff-line-height', lineHeight);
                
                // Save preference
                localStorage.setItem('diff_font_size', size);
                
                console.log(`Font size changed to ${fontSize}px with line-height ${lineHeight}`);
              }

              async loadFiles() {
                try {
                  const token = localStorage.getItem('auth_token');
                  if (!token) {
                    this.showError('Please log in to access files');
                    setTimeout(() => {
                      window.location.href = '/login.html';
                    }, 2000);
                    return;
                  }
                  
                  const response = await fetch('http://localhost:8000/api/files/list', {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });
                  const data = await response.json();
                  
                  if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    this.showError('Session expired. Please log in again.');
                    setTimeout(() => {
                      window.location.href = '/login.html';
                    }, 2000);
                    return;
                  }
                  
                  if (response.ok) {
                    this.files = data.files || data;
                    this.populateFileSelects();
                    console.log('Files loaded:', this.files.length);
                  } else {
                    this.showError('Failed to load files: ' + (data.detail || 'Unknown error'));
                  }
                } catch (error) {
                  this.showError('Error loading files: ' + error.message);
                }
              }

              async loadFileHistory(side) {
                const fileSelect = document.getElementById(side === 'left' ? 'leftFileSelect' : 'rightFileSelect');
                const historyContent = document.getElementById(side === 'left' ? 'leftFileHistoryContent' : 'rightFileHistoryContent');
                const selectedFile = fileSelect.value;

                if (!selectedFile) {
                  historyContent.innerHTML = '<p class="text-muted"><i>Select a file to view its history</i></p>';
                  this.updateFileHistoryVisibility();
                  return;
                }

                // Show loading state
                historyContent.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';

                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/file-history/${encodeURIComponent(selectedFile)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  const data = await response.json();

                  if (response.ok) {
                    const commit = data.last_commit;
                    const commitDate = new Date(commit.date);
                    const timeAgo = this.getTimeAgo(commitDate);

                    historyContent.innerHTML = `
                      <div class="file-history-info">
                        <p><strong>Last Modified:</strong> ${timeAgo}</p>
                        <p><strong>Date:</strong> ${commitDate.toLocaleString()}</p>
                        <p><strong>Author:</strong> ${commit.author.name}</p>
                        <p><strong>Commit:</strong> <code>${commit.short_hash}</code></p>
                        <p><strong>Message:</strong> ${commit.message}</p>
                        ${!data.file_exists ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> File was deleted in this commit</p>' : ''}
                      </div>
                    `;
                  } else {
                    historyContent.innerHTML = `<p class="text-warning">Could not load history: ${data.detail}</p>`;
                  }
                } catch (error) {
                  historyContent.innerHTML = `<p class="text-danger">Error loading history: ${error.message}</p>`;
                }

                this.updateFileHistoryVisibility();
              }

              updateFileHistoryVisibility() {
                const leftFile = document.getElementById('leftFileSelect').value;
                const rightFile = document.getElementById('rightFileSelect').value;
                const historySection = document.getElementById('fileHistorySection');
                
                // Reset headers for file mode
                const leftHeader = document.querySelector('#leftFileHistory h6');
                const rightHeader = document.querySelector('#rightFileHistory h6');
                leftHeader.textContent = 'Source File';
                rightHeader.textContent = 'Target File';
                
                // Show history section if at least one file is selected
                if (leftFile || rightFile) {
                  historySection.style.display = 'block';
                } else {
                  historySection.style.display = 'none';
                }
              }

              async loadGitFileHistory() {
                const leftCommit = document.getElementById('leftCommitSelect').value;
                const rightCommit = document.getElementById('rightCommitSelect').value;
                const gitFile = document.getElementById('gitFileSelect').value;
                
                // Update the section headers for Git mode
                const leftHeader = document.querySelector('#leftFileHistory h6');
                const rightHeader = document.querySelector('#rightFileHistory h6');
                leftHeader.textContent = leftCommit ? `Source Commit (${leftCommit.substring(0, 8)})` : 'Source Commit';
                rightHeader.textContent = rightCommit ? `Target Commit (${rightCommit.substring(0, 8)})` : 'Target Commit';
                
                // Clear both sides first
                this.clearFileHistory('left');
                this.clearFileHistory('right');
                
                if (!gitFile) {
                  this.updateGitFileHistoryVisibility();
                  return;
                }

                // Load history for both commits if they're selected
                if (leftCommit) {
                  await this.loadGitCommitFileHistory('left', leftCommit, gitFile);
                }
                if (rightCommit) {
                  await this.loadGitCommitFileHistory('right', rightCommit, gitFile);
                }
                
                this.updateGitFileHistoryVisibility();
              }

              async loadGitCommitFileHistory(side, commitHash, filePath) {
                const historyContent = document.getElementById(side === 'left' ? 'leftFileHistoryContent' : 'rightFileHistoryContent');
                
                // Show loading state
                historyContent.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';

                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/file-history/${encodeURIComponent(filePath)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  const data = await response.json();

                  if (response.ok) {
                    const commit = data.last_commit;
                    const commitDate = new Date(commit.date);
                    const timeAgo = this.getTimeAgo(commitDate);

                    // Check if the selected commit is the same as the last commit that modified the file
                    // Compare both full hash and short hash, handling both directions
                    const selectedShort = commitHash.substring(0, 8);
                    const lastCommitShort = commit.short_hash || commit.hash.substring(0, 8);
                    const isSelectedCommit = (
                      commitHash === commit.hash || 
                      selectedShort === lastCommitShort ||
                      commitHash === commit.short_hash ||
                      (commit.hash && commit.hash.startsWith(commitHash))
                    );
                    
                    const commitLabel = isSelectedCommit ? 'Selected Commit' : 'Last Modified';

                    historyContent.innerHTML = `
                      <div class="file-history-info">
                        <p><strong>${commitLabel}:</strong> ${timeAgo}</p>
                        <p><strong>Date:</strong> ${commitDate.toLocaleString()}</p>
                        <p><strong>Author:</strong> ${commit.author.name}</p>
                        <p><strong>Commit:</strong> <code>${commit.short_hash}</code></p>
                        <p><strong>Message:</strong> ${commit.message}</p>
                        ${!data.file_exists ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> File was deleted in this commit</p>' : ''}
                        ${!isSelectedCommit ? `<p class="text-info"><i class="fas fa-info-circle"></i> Note: File unchanged in selected commit (${selectedShort}). Showing last modification.</p>` : ''}
                      </div>
                    `;
                  } else {
                    historyContent.innerHTML = `<p class="text-warning">Could not load history: ${data.detail}</p>`;
                  }
                } catch (error) {
                  historyContent.innerHTML = `<p class="text-danger">Error loading history: ${error.message}</p>`;
                }
              }

              clearFileHistory(side) {
                const historyContent = document.getElementById(side === 'left' ? 'leftFileHistoryContent' : 'rightFileHistoryContent');
                historyContent.innerHTML = '<p class="text-muted"><i>Select a file to view its history</i></p>';
              }

              closeFileHistory() {
                const historySection = document.getElementById('fileHistorySection');
                historySection.style.display = 'none';
                
                // Clear both sides
                this.clearFileHistory('left');
                this.clearFileHistory('right');
              }

              updateGitFileHistoryVisibility() {
                const gitFile = document.getElementById('gitFileSelect').value;
                const historySection = document.getElementById('fileHistorySection');
                
                // Show history section if a Git file is selected
                if (gitFile) {
                  historySection.style.display = 'block';
                } else {
                  historySection.style.display = 'none';
                }
              }

              getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                const weeks = Math.floor(days / 7);
                const months = Math.floor(days / 30);
                const years = Math.floor(days / 365);

                if (years > 0) return `${years} year${years > 1 ? 's' : ''} ago`;
                if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
                if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
                if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                return 'Just now';
              }

              // File History Mode Methods
              async initializeHistoryMode() {
                console.log('Initializing File History mode...');
                
                // Load branches for history mode
                await this.loadHistoryBranches();
                // Note: loadHistoryBranches now handles loading commits for the selected branch
                
                console.log('File History mode initialization complete');
              }

              async loadHistoryBranches() {
                console.log('Loading branches for history mode...');
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch('http://localhost:8000/api/git/branches', {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded branches data:', data);
                    
                    // Handle different response formats
                    let branches = [];
                    if (Array.isArray(data)) {
                      // Direct array of strings
                      branches = data;
                    } else if (data.branches && Array.isArray(data.branches)) {
                      // Array of branch objects with name property
                      branches = data.branches.map(branch => 
                        typeof branch === 'string' ? branch : branch.name
                      );
                    } else {
                      // Fallback to empty array
                      branches = [];
                    }
                    console.log('Processing branches:', branches);
                    
                    const branchSelect = document.getElementById('historyBranchSelect');
                    
                    // Clear existing options
                    branchSelect.innerHTML = '';
                    
                    // Add branch options
                    let defaultBranch = 'main';
                    branches.forEach(branch => {
                      const option = new Option(branch, branch);
                      branchSelect.add(option);
                    });
                    
                    // Set default branch value explicitly
                    if (branches.includes('main')) {
                      branchSelect.value = 'main';
                      console.log('Set branch to main');
                    } else if (branches.length > 0) {
                      branchSelect.value = branches[0];
                      defaultBranch = branches[0];
                      console.log('Set branch to:', branches[0]);
                    }
                    
                    // Load commits for the selected branch
                    if (branchSelect.value) {
                      await this.loadHistoryCommitsForBranch(branchSelect.value);
                    }
                  }
                } catch (error) {
                  console.error('Error loading branches for history mode:', error);
                }
              }

              async loadHistoryCommitsForBranch(branch) {
                console.log('Loading commits for branch:', branch);
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/commits?branch=${encodeURIComponent(branch)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  if (response.ok) {
                    const commits = await response.json();
                    console.log('Loaded commits:', commits.length);
                    const commitSelect = document.getElementById('historyCommitSelect');
                    
                    // Clear existing options
                    commitSelect.innerHTML = '<option value="">Select commit...</option>';
                    
                    // Add commit options
                    let latestCommitHash = null;
                    commits.forEach((commit, index) => {
                      const shortMessage = commit.message.length > 50 ? 
                        commit.message.substring(0, 50) + '...' : 
                        commit.message;
                      const option = new Option(
                        `${commit.short_hash} - ${shortMessage}`, 
                        commit.hash
                      );
                      commitSelect.add(option);
                      
                      // Store the latest commit hash for selection
                      if (index === 0) {
                        latestCommitHash = commit.hash;
                      }
                    });
                    
                    // Select the latest commit explicitly
                    if (latestCommitHash) {
                      commitSelect.value = latestCommitHash;
                      console.log('Set commit to:', latestCommitHash);
                      
                      // Auto-populate files for the latest commit
                      await this.populateHistoryFiles();
                    }
                  }
                } catch (error) {
                  console.error('Error loading commits for history mode:', error);
                }
              }

              async populateHistoryFiles() {
                const commitHash = document.getElementById('historyCommitSelect').value;
                console.log('Populating files for commit:', commitHash);
                if (!commitHash) return;

                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/files/${encodeURIComponent(commitHash)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  if (response.ok) {
                    const files = await response.json();
                    console.log('Loaded files:', files.length);
                    const fileSelect = document.getElementById('historyFileSelect');
                    
                    // Clear existing options
                    fileSelect.innerHTML = '<option value="">Select file...</option>';
                    
                    // Add file options
                    files.forEach(file => {
                      const option = new Option(file, file);
                      fileSelect.add(option);
                    });
                    
                    console.log('File select populated with', files.length, 'files');
                  }
                } catch (error) {
                  console.error('Error loading files for history mode:', error);
                }
                
                this.updateShowHistoryButton();
              }

              updateShowHistoryButton() {
                const branch = document.getElementById('historyBranchSelect').value;
                const commit = document.getElementById('historyCommitSelect').value;
                const file = document.getElementById('historyFileSelect').value;
                const button = document.getElementById('showHistoryBtn');
                
                button.disabled = !(branch && commit && file);
              }

              async showFileHistory() {
                const branch = document.getElementById('historyBranchSelect').value;
                const commit = document.getElementById('historyCommitSelect').value;
                const filePath = document.getElementById('historyFileSelect').value;
                
                if (!branch || !commit || !filePath) return;

                const historyDisplay = document.getElementById('fileHistoryDisplay');
                const historyContent = document.getElementById('historyContent');
                const fileName = document.getElementById('historyFileName');
                
                fileName.textContent = filePath;
                historyContent.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';
                historyDisplay.style.display = 'block';

                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch(`http://localhost:8000/api/git/file-complete-history/${encodeURIComponent(filePath)}?from_commit=${encodeURIComponent(commit)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  if (response.ok) {
                    const history = await response.json();
                    // Pass the selected commit hash to the render function
                    this.renderFileHistory(history, commit);
                  } else {
                    const error = await response.json();
                    historyContent.innerHTML = `<p class="text-danger">Error loading file history: ${error.detail}</p>`;
                  }
                } catch (error) {
                  historyContent.innerHTML = `<p class="text-danger">Error loading file history: ${error.message}</p>`;
                }
              }

              renderFileHistory(history, selectedCommitHash) {
                const historyContent = document.getElementById('historyContent');
                
                if (!history.commits || history.commits.length === 0) {
                  historyContent.innerHTML = '<p class="text-muted">No history found for this file.</p>';
                  return;
                }

                let historyHtml = `
                  <div class="timeline">
                    <div class="timeline-header">
                      <p class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> 
                        Showing ${history.commits.length} commit${history.commits.length > 1 ? 's' : ''} 
                        from <strong>${history.from_commit.substring(0, 8)}</strong> backwards to file creation
                      </p>
                    </div>
                `;

                history.commits.forEach((commit, index) => {
                  const commitDate = new Date(commit.date);
                  const timeAgo = this.getTimeAgo(commitDate);
                  const isLast = index === history.commits.length - 1;
                  
                  // Check if this commit is the selected one
                  const isSelectedCommit = (
                    commit.hash === selectedCommitHash ||
                    commit.short_hash === selectedCommitHash.substring(0, 8) ||
                    selectedCommitHash.startsWith(commit.hash) ||
                    selectedCommitHash.startsWith(commit.short_hash)
                  );
                  
                  let changeType = 'modified';
                  let changeIcon = 'fas fa-edit';
                  let changeColor = 'primary';
                  
                  if (isLast) {
                    changeType = 'added';
                    changeIcon = 'fas fa-plus';
                    changeColor = 'success';
                  }
                  
                  if (commit.change_type === 'D') {
                    changeType = 'deleted';
                    changeIcon = 'fas fa-trash';
                    changeColor = 'danger';
                  }

                  historyHtml += `
                    <div class="timeline-item ${isSelectedCommit ? 'timeline-current' : ''}">
                      <div class="timeline-marker bg-${changeColor}">
                        <i class="${changeIcon}"></i>
                      </div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <h6 class="timeline-title mb-1">
                            File ${changeType} 
                            ${isSelectedCommit ? '<span class="badge bg-info ms-2">Selected Commit</span>' : ''}
                          </h6>
                          <p class="timeline-time text-muted mb-2">
                            <i class="fas fa-clock"></i> ${timeAgo} (${commitDate.toLocaleString()})
                          </p>
                        </div>
                        <div class="timeline-body">
                          <p class="mb-1"><strong>Commit:</strong> <code>${commit.short_hash}</code></p>
                          <p class="mb-1"><strong>Author:</strong> ${commit.author.name}</p>
                          <p class="mb-2"><strong>Message:</strong> ${commit.message}</p>
                          <div class="timeline-actions">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="configCompare.compareHistoryCommit('${commit.hash}', '${commit.short_hash}')"
                                    title="Show changes made in this commit">
                              <i class="fas fa-exchange-alt"></i> Compare
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                });

                historyHtml += '</div>';
                historyContent.innerHTML = historyHtml;
              }

              async compareHistoryCommit(commitHash, shortHash) {
                // Get the current file path from the history display
                const fileName = document.getElementById('historyFileName').textContent;
                if (!fileName) {
                  this.showError('No file selected for comparison');
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  const token = localStorage.getItem('auth_token');
                  
                  // Get the file history to find the parent commit
                  const historyResponse = await fetch(`http://localhost:8000/api/git/file-complete-history/${encodeURIComponent(fileName)}?from_commit=${encodeURIComponent(commitHash)}`, {
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });

                  if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    
                    // Find the current commit and the next one (parent) in the history
                    let currentIndex = -1;
                    for (let i = 0; i < historyData.commits.length; i++) {
                      if (historyData.commits[i].hash === commitHash || historyData.commits[i].short_hash === shortHash) {
                        currentIndex = i;
                        break;
                      }
                    }
                    
                    if (currentIndex === -1) {
                      this.showError('Could not find commit in history');
                      return;
                    }
                    
                    // Get parent commit (next in history array, or create empty for first commit)
                    let parentCommit = null;
                    if (currentIndex < historyData.commits.length - 1) {
                      parentCommit = historyData.commits[currentIndex + 1].hash;
                    } else {
                      // This is the first commit for this file, compare with empty
                      parentCommit = null;
                    }
                    
                    // Use the existing diff API
                    const diffResponse = await fetch('http://localhost:8000/api/git/diff', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                      },
                      body: JSON.stringify({
                        commit1: parentCommit, // Parent (older)
                        commit2: commitHash,   // Current (newer)
                        file_path: fileName
                      })
                    });

                    if (diffResponse.ok) {
                      const diffData = await diffResponse.json();
                      
                      // Format the diff data for display
                      const formattedDiff = this.formatGitDiff(diffData, fileName, parentCommit || 'empty', commitHash);
                      
                      // Display the comparison
                      this.displayComparison(formattedDiff, `Commit ${shortHash}: ${fileName}`);
                      
                      // Scroll to comparison section
                      document.getElementById('comparisonSection').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                      });
                    } else {
                      const error = await diffResponse.json();
                      this.showError(`Failed to load commit diff: ${error.detail || 'Unknown error'}`);
                    }
                  } else {
                    const error = await historyResponse.json();
                    this.showError(`Failed to load file history for diff: ${error.detail || 'Unknown error'}`);
                  }
                } catch (error) {
                  this.showError(`Error loading commit diff: ${error.message}`);
                }
              }

              populateFileSelects() {
                const leftSelect = document.getElementById('leftFileSelect');
                const rightSelect = document.getElementById('rightFileSelect');
                
                // Clear existing options
                leftSelect.innerHTML = '<option value="">Select a file...</option>';
                rightSelect.innerHTML = '<option value="">Select a file...</option>';
                
                // Add file options - handle both old and new API response formats
                this.files.forEach(file => {
                  const filename = file.filename || file;
                  const filepath = file.path || file;
                  const option1 = new Option(filename, filepath);
                  const option2 = new Option(filename, filepath);
                  leftSelect.add(option1);
                  rightSelect.add(option2);
                });
              }

              async compareFiles() {
                const leftFile = document.getElementById('leftFileSelect').value;
                const rightFile = document.getElementById('rightFileSelect').value;
                
                if (!leftFile || !rightFile) {
                  this.showError('Please select both files to compare');
                  return;
                }

                // Show loading state
                this.showLoading();
                
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch('http://localhost:8000/api/files/compare', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                      file1: leftFile,
                      file2: rightFile
                    })
                  });
                  
                  const data = await response.json();
                  
                  if (response.ok) {
                    this.displayComparison(data, `${leftFile} vs ${rightFile}`);
                  } else {
                    this.showError('Comparison failed: ' + (data.detail || 'Unknown error'));
                  }
                } catch (error) {
                  this.showError('Error comparing files: ' + error.message);
                }
              }

              async compareGitCommits() {
                const leftCommit = document.getElementById('leftCommitSelect').value;
                const rightCommit = document.getElementById('rightCommitSelect').value;
                const gitFile = document.getElementById('gitFileSelect').value;

                if (!leftCommit || !rightCommit || !gitFile) {
                  this.showError('Please select both commits and a file to compare');
                  return;
                }

                // Show loading state
                this.showLoading();
                
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch('http://localhost:8000/api/git/diff', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                      commit1: leftCommit,
                      commit2: rightCommit,
                      file_path: gitFile
                    })
                  });
                  
                  const result = await response.json();
                  
                  if (response.ok) {
                    // Convert Git diff format to comparison format
                    const formattedResult = this.formatGitDiff(result, gitFile, leftCommit, rightCommit);
                    const leftCommitShort = leftCommit.substring(0, 8);
                    const rightCommitShort = rightCommit.substring(0, 8);
                    this.displayComparison(formattedResult, `${gitFile}: ${leftCommitShort}  ${rightCommitShort}`);
                  } else {
                    this.showError('Git comparison failed: ' + (result.detail || 'Unknown error'));
                  }
                } catch (error) {
                  this.showError('Error comparing Git commits: ' + error.message);
                }
              }

              formatGitDiff(gitResult, fileName, leftCommit, rightCommit) {
                // The backend now returns data in the same format as file comparison
                // Check if we have the new format with left_lines and right_lines
                if (gitResult.left_lines && gitResult.right_lines) {
                  // New format - use directly
                  return {
                    left_file: gitResult.left_file,
                    right_file: gitResult.right_file,
                    left_lines: gitResult.left_lines,
                    right_lines: gitResult.right_lines
                  };
                }
                
                // Fallback to old format processing for backward compatibility
                const leftLines = [];
                const rightLines = [];
                
                if (gitResult.diff_lines && Array.isArray(gitResult.diff_lines)) {
                  let leftLineNum = 1;
                  let rightLineNum = 1;
                  
                  gitResult.diff_lines.forEach(line => {
                    if (line.startsWith('-')) {
                      // Deleted line
                      leftLines.push({
                        line_number: leftLineNum++,
                        content: line.substring(1),
                        type: 'delete'
                      });
                      rightLines.push({
                        line_number: null,
                        content: '',
                        type: 'empty'
                      });
                    } else if (line.startsWith('+')) {
                      // Added line
                      leftLines.push({
                        line_number: null,
                        content: '',
                        type: 'empty'
                      });
                      rightLines.push({
                        line_number: rightLineNum++,
                        content: line.substring(1),
                        type: 'insert'
                      });
                    } else if (line.startsWith(' ')) {
                      // Unchanged line
                      leftLines.push({
                        line_number: leftLineNum++,
                        content: line.substring(1),
                        type: 'equal'
                      });
                      rightLines.push({
                        line_number: rightLineNum++,
                        content: line.substring(1),
                        type: 'equal'
                      });
                    }
                  });
                } else {
                  // No differences or files are identical
                  leftLines.push({
                    line_number: 1,
                    content: 'Files are identical or no differences found',
                    type: 'equal'
                  });
                  rightLines.push({
                    line_number: 1,
                    content: 'Files are identical or no differences found',
                    type: 'equal'
                  });
                }
                
                return {
                  left_file: `${fileName} (${leftCommit.substring(0, 8)})`,
                  right_file: `${fileName} (${rightCommit.substring(0, 8)})`,
                  left_lines: leftLines,
                  right_lines: rightLines
                };
              }

              populateFileSelects() {
                const leftSelect = document.getElementById('leftFileSelect');
                const rightSelect = document.getElementById('rightFileSelect');
                
                // Clear existing options
                leftSelect.innerHTML = '<option value="">Select a file...</option>';
                rightSelect.innerHTML = '<option value="">Select a file...</option>';
                
                // Add file options
                this.files.forEach(file => {
                  const option1 = new Option(file.filename, file.path);
                  const option2 = new Option(file.filename, file.path);
                  leftSelect.add(option1);
                  rightSelect.add(option2);
                });
              }

              updateCompareButton() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                const compareBtn = document.getElementById('compareBtn');
                let canCompare = false;

                if (mode === 'files') {
                  const leftFile = document.getElementById('leftFileSelect').value;
                  const rightFile = document.getElementById('rightFileSelect').value;
                  canCompare = leftFile && rightFile && leftFile !== rightFile;
                  compareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare Files';
                } else if (mode === 'git') {
                  const leftCommit = document.getElementById('leftCommitSelect').value;
                  const rightCommit = document.getElementById('rightCommitSelect').value;
                  const gitFile = document.getElementById('gitFileSelect').value;
                  canCompare = leftCommit && rightCommit && gitFile && leftCommit !== rightCommit;
                  compareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare Commits';
                } else if (mode === 'history') {
                  // In history mode, the compare button is not used (Show History button is used instead)
                  canCompare = false;
                  compareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare';
                }
                
                compareBtn.disabled = !canCompare;
                
                // Hide compare button in history mode
                if (mode === 'history') {
                  compareBtn.style.display = 'none';
                } else {
                  compareBtn.style.display = 'inline-block';
                }
              }

              async compareFiles() {
                const leftFile = document.getElementById('leftFileSelect').value;
                const rightFile = document.getElementById('rightFileSelect').value;
                
                if (!leftFile || !rightFile) {
                  this.showError('Please select both files to compare');
                  return;
                }

                // Show loading state
                this.showLoading();
                
                try {
                  const token = localStorage.getItem('auth_token');
                  const response = await fetch('/api/files/compare', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                      left_file: leftFile,
                      right_file: rightFile
                    })
                  });
                  
                  const data = await response.json();
                  
                  if (response.ok) {
                    this.displayComparison(data);
                  } else {
                    this.showError('Comparison failed: ' + (data.detail || 'Unknown error'));
                  }
                } catch (error) {
                  this.showError('Error comparing files: ' + error.message);
                }
              }

              displayComparison(comparison, title = null) {
                // Update file names
                document.getElementById('leftFileName').textContent = title ? title.split(' vs ')[0] || title.split(': ')[0] : comparison.left_file;
                document.getElementById('rightFileName').textContent = title ? title.split(' vs ')[1] || title.split(': ')[1] || title.split('  ')[1] : comparison.right_file;
                
                // Calculate stats from the data
                let additions = 0, deletions = 0, modifications = 0;
                comparison.left_lines.forEach(line => {
                  if (line.type === 'insert') additions++;
                  else if (line.type === 'delete') deletions++;
                  else if (line.type === 'replace') modifications++;
                });
                
                // Update stats
                const stats = `${additions} additions, ${deletions} deletions, ${modifications} modifications`;
                document.getElementById('comparisonStats').textContent = stats;
                
                // Render diff
                this.renderDiff(comparison);
                
                // Show comparison section
                document.getElementById('comparisonSection').style.display = 'block';
                
                // Enable export button
                document.getElementById('exportBtn').disabled = false;
                
                // Setup navigation
                this.setupDiffNavigation(comparison);
              }

              async showGitStatus() {
                if (!this.gitData.status) {
                  await this.loadGitStatus();
                }

                let statusHtml = `
                  <div class="modal fade" id="gitStatusModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Git Repository Status</h5>
                          <button type="button" class="btn-close" id="closeGitStatusModal"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6">
                              <h6>Current Branch:</h6>
                              <p class="text-primary">${this.gitData.status?.current_branch || 'Unknown'}</p>
                              
                              <h6>Repository Status:</h6>
                              <p class="${this.gitData.status?.is_dirty ? 'text-warning' : 'text-success'}">
                                ${this.gitData.status?.is_dirty ? 'Modified files present' : 'Clean working directory'}
                              </p>
                            </div>
                            <div class="col-md-6">
                              <h6>Available Branches:</h6>
                              <ul class="list-unstyled">
                                ${this.gitData.branches.map(branch => 
                                  `<li class="${branch.is_current ? 'text-primary fw-bold' : ''}">${branch.name}${branch.is_current ? ' (current)' : ''}</li>`
                                ).join('')}
                              </ul>
                            </div>
                          </div>
                          
                          <h6>Recent Commits:</h6>
                          <div class="table-responsive">
                            <table class="table table-sm">
                              <thead>
                                <tr>
                                  <th>Hash</th>
                                  <th>Message</th>
                                  <th>Author</th>
                                  <th>Date</th>
                                </tr>
                              </thead>
                              <tbody>
                                ${this.gitData.commits.slice(0, 10).map(commit => `
                                  <tr>
                                    <td><code>${commit.hash.substring(0, 8)}</code></td>
                                    <td>${commit.message}</td>
                                    <td>${commit.author}</td>
                                    <td>${new Date(commit.date).toLocaleDateString()}</td>
                                  </tr>
                                `).join('')}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" id="closeGitStatusModalBtn">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                // Remove existing modal and add new one
                const existingModal = document.getElementById('gitStatusModal');
                if (existingModal) {
                  this.closeGitStatusModal();
                }
                
                // Remove any existing backdrop
                const existingBackdrop = document.querySelector('.modal-backdrop');
                if (existingBackdrop) {
                  existingBackdrop.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', statusHtml);
                
                // Show the modal
                const modal = document.getElementById('gitStatusModal');
                modal.style.display = 'block';
                modal.classList.add('show');
                
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'gitStatusBackdrop';
                document.body.appendChild(backdrop);
                
                // Add event listeners for close functionality
                const closeBtn = document.getElementById('closeGitStatusModal');
                const closeFooterBtn = document.getElementById('closeGitStatusModalBtn');
                
                closeBtn.addEventListener('click', () => this.closeGitStatusModal());
                closeFooterBtn.addEventListener('click', () => this.closeGitStatusModal());
                backdrop.addEventListener('click', () => this.closeGitStatusModal());
                
                // Close on escape key
                const escapeHandler = (e) => {
                  if (e.key === 'Escape') {
                    this.closeGitStatusModal();
                    document.removeEventListener('keydown', escapeHandler);
                  }
                };
                document.addEventListener('keydown', escapeHandler);
              }

              closeGitStatusModal() {
                const modal = document.getElementById('gitStatusModal');
                const backdrop = document.getElementById('gitStatusBackdrop');
                
                if (modal) {
                  modal.remove();
                }
                
                if (backdrop) {
                  backdrop.remove();
                }
                
                // Also remove any other modal backdrops that might be left behind
                const allBackdrops = document.querySelectorAll('.modal-backdrop');
                allBackdrops.forEach(bd => bd.remove());
                
                // Remove the modal-open class from body if it exists
                document.body.classList.remove('modal-open');
                
                // Reset body padding-right that Bootstrap sometimes adds
                document.body.style.paddingRight = '';
              }

              renderDiff(diffData) {
                const container = document.getElementById('diffContent');
                container.innerHTML = '';
                
                this.currentDiffs = [];
                
                // Render side-by-side comparison
                const maxLines = Math.max(diffData.left_lines.length, diffData.right_lines.length);
                
                for (let i = 0; i < maxLines; i++) {
                  const leftLine = diffData.left_lines[i] || { line_number: null, content: '', type: 'empty' };
                  const rightLine = diffData.right_lines[i] || { line_number: null, content: '', type: 'empty' };
                  
                  const row = document.createElement('div');
                  row.className = 'diff-row';
                  
                  // Left side
                  const leftDiv = document.createElement('div');
                  leftDiv.className = `diff-line ${this.getDiffClass(leftLine.type)}`;
                  leftDiv.innerHTML = this.formatLine(leftLine.line_number, leftLine.content, leftLine.type, 'left');
                  
                  // Right side
                  const rightDiv = document.createElement('div');
                  rightDiv.className = `diff-line ${this.getDiffClass(rightLine.type)}`;
                  rightDiv.innerHTML = this.formatLine(rightLine.line_number, rightLine.content, rightLine.type, 'right');
                  
                  row.appendChild(leftDiv);
                  row.appendChild(rightDiv);
                  container.appendChild(row);
                  
                  // Track diff locations for navigation and export
                  // Store all lines for export, including unchanged ones
                  const diffType = this.getDiffType(leftLine.type, rightLine.type);
                  this.currentDiffs.push({
                    element: row,
                    type: diffType,
                    left: leftLine.content || '',
                    right: rightLine.content || '',
                    leftLineNumber: leftLine.line_number,
                    rightLineNumber: rightLine.line_number,
                    index: this.currentDiffs.length
                  });
                }
                
                // Setup sync scrolling
                this.setupSyncScrolling();
                
                // Update navigation buttons
                this.updateNavigationButtons();
              }

              getDiffClass(type) {
                switch (type) {
                  case 'insert': return 'diff-added';
                  case 'delete': return 'diff-removed';
                  case 'replace': return 'diff-modified';
                  case 'equal': return 'diff-unchanged';
                  default: return 'diff-unchanged';
                }
              }

              getDiffType(leftType, rightType) {
                // Determine unified diff type based on left and right line types
                if (leftType === 'equal' && rightType === 'equal') {
                  return 'unchanged';
                } else if (leftType === 'delete' && rightType === 'empty') {
                  return 'removed';
                } else if (leftType === 'empty' && rightType === 'insert') {
                  return 'added';
                } else if (leftType === 'replace' || rightType === 'replace') {
                  return 'modified';
                } else if (leftType === 'delete' && rightType === 'insert') {
                  return 'modified';
                } else {
                  return 'unchanged';
                }
              }

              formatLine(lineNumber, content, type, side) {
                const lineNumSpan = `<span class="diff-line-number">${lineNumber || ''}</span>`;
                const contentSpan = `<span class="diff-line-content">${this.escapeHtml(content || '')}</span>`;
                return lineNumSpan + contentSpan;
              }

              escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
              }

              setupSyncScrolling() {
                const container = document.getElementById('diffContent');
                // Sync scrolling is handled by CSS flexbox layout
              }

              setupDiffNavigation(diffData) {
                this.currentDiffIndex = 0;
                this.updateNavigationButtons();
              }

              navigateDiff(direction) {
                // Get only the changed lines (not unchanged ones) for navigation
                const changedDiffs = this.currentDiffs.filter(diff => diff.type !== 'unchanged');
                
                if (changedDiffs.length === 0) return;
                
                this.currentDiffIndex += direction;
                
                if (this.currentDiffIndex < 0) {
                  this.currentDiffIndex = changedDiffs.length - 1;
                } else if (this.currentDiffIndex >= changedDiffs.length) {
                  this.currentDiffIndex = 0;
                }
                
                // Scroll to current diff
                const diff = changedDiffs[this.currentDiffIndex];
                diff.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight current diff temporarily
                diff.element.style.outline = '2px solid #007bff';
                setTimeout(() => {
                  diff.element.style.outline = '';
                }, 2000);
                
                this.updateNavigationButtons();
              }

              updateNavigationButtons() {
                const prevBtn = document.getElementById('prevDiffBtn');
                const nextBtn = document.getElementById('nextDiffBtn');
                
                // Use only changed diffs for navigation count
                const changedDiffs = this.currentDiffs.filter(diff => diff.type !== 'unchanged');
                const hasDeltas = changedDiffs.length > 0;
                
                prevBtn.disabled = !hasDeltas;
                nextBtn.disabled = !hasDeltas;
                
                if (hasDeltas) {
                  prevBtn.title = `Previous difference (${this.currentDiffIndex + 1}/${changedDiffs.length})`;
                  nextBtn.title = `Next difference (${this.currentDiffIndex + 1}/${changedDiffs.length})`;
                }
              }

              showLoading() {
                const diffContent = document.getElementById('diffContent');
                diffContent.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-3">Loading comparison...</p>
                  </div>
                `;
                
                // Show the comparison section
                document.getElementById('comparisonSection').style.display = 'block';
              }

              showError(message) {
                const diffContent = document.getElementById('diffContent');
                diffContent.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    <p class="mt-3 text-danger">${message}</p>
                  </div>
                `;
                
                // Show the comparison section
                document.getElementById('comparisonSection').style.display = 'block';
              }

              toggleUnchanged() {
                this.hideUnchanged = !this.hideUnchanged;
                const toggleBtn = document.getElementById('toggleUnchangedBtn');
                const unchangedLines = document.querySelectorAll('.diff-unchanged');
                
                if (this.hideUnchanged) {
                  unchangedLines.forEach(line => line.parentElement.classList.add('diff-hidden'));
                  toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Show Unchanged';
                } else {
                  unchangedLines.forEach(line => line.parentElement.classList.remove('diff-hidden'));
                  toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Unchanged';
                }
              }

              async exportDiff() {
                try {
                  // Check if we have diff content to export
                  if (!this.currentDiffs || this.currentDiffs.length === 0) {
                    this.showError('No diff content to export. Please run a comparison first.');
                    return;
                  }

                  // Get the file names for the export
                  const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                  let leftFileName = 'source';
                  let rightFileName = 'target';
                  let exportFileName = 'diff.patch';

                  if (mode === 'files') {
                    leftFileName = document.getElementById('leftFileSelect').value || 'source';
                    rightFileName = document.getElementById('rightFileSelect').value || 'target';
                  } else if (mode === 'git') {
                    const leftCommit = document.getElementById('leftCommitSelect').value;
                    const rightCommit = document.getElementById('rightCommitSelect').value;
                    const gitFile = document.getElementById('gitFileSelect').value;
                    
                    leftFileName = gitFile ? `${gitFile}@${leftCommit?.substring(0, 8) || 'source'}` : 'source';
                    rightFileName = gitFile ? `${gitFile}@${rightCommit?.substring(0, 8) || 'target'}` : 'target';
                  }

                  // Create a meaningful filename
                  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                  exportFileName = `diff_${leftFileName.replace(/[^\w.-]/g, '_')}_vs_${rightFileName.replace(/[^\w.-]/g, '_')}_${timestamp}.patch`;

                  // Generate unified diff format from current diff data
                  let unifiedDiff = this.generateUnifiedDiff(leftFileName, rightFileName);

                  if (!unifiedDiff.trim()) {
                    this.showError('No differences found to export.');
                    return;
                  }

                  // Create and download the file
                  const blob = new Blob([unifiedDiff], { type: 'text/plain;charset=utf-8' });
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = exportFileName;
                  a.style.display = 'none';
                  document.body.appendChild(a);
                  a.click();
                  
                  // Cleanup
                  setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                  }, 100);

                  this.showSuccess(`Diff exported as ${exportFileName}`);

                } catch (error) {
                  console.error('Export error:', error);
                  this.showError('Export failed: ' + error.message);
                }
              }

              showSuccess(message) {
                // Show success message in the comparison stats area
                const statsElement = document.getElementById('comparisonStats');
                const originalText = statsElement.textContent;
                
                statsElement.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${message}`;
                statsElement.style.color = '#28a745';
                
                // Restore original text after 3 seconds
                setTimeout(() => {
                  statsElement.textContent = originalText;
                  statsElement.style.color = '';
                }, 3000);
              }

              generateUnifiedDiff(leftFileName, rightFileName) {
                if (!this.currentDiffs || this.currentDiffs.length === 0) {
                  return '';
                }

                const timestamp = new Date().toISOString();
                let unifiedDiff = `--- ${leftFileName}\t${timestamp}\n`;
                unifiedDiff += `+++ ${rightFileName}\t${timestamp}\n`;

                let leftLineNum = 1;
                let rightLineNum = 1;
                let hunkStart = null;
                let hunkLines = [];

                for (let i = 0; i < this.currentDiffs.length; i++) {
                  const diff = this.currentDiffs[i];
                  
                  if (diff.type === 'unchanged') {
                    // If we have a hunk in progress, output it
                    if (hunkStart !== null) {
                      unifiedDiff += this.formatHunk(hunkStart, hunkLines, leftLineNum, rightLineNum);
                      hunkStart = null;
                      hunkLines = [];
                    }
                    leftLineNum++;
                    rightLineNum++;
                  } else {
                    // Start a new hunk if needed
                    if (hunkStart === null) {
                      hunkStart = { left: leftLineNum, right: rightLineNum };
                      
                      // Add context lines before the change
                      const contextBefore = Math.max(0, i - 3);
                      for (let j = contextBefore; j < i; j++) {
                        if (this.currentDiffs[j] && this.currentDiffs[j].type === 'unchanged') {
                          hunkLines.push(` ${this.currentDiffs[j].left || this.currentDiffs[j].right || ''}`);
                        }
                      }
                    }

                    // Add the changed line
                    if (diff.type === 'removed') {
                      hunkLines.push(`-${diff.left || ''}`);
                      leftLineNum++;
                    } else if (diff.type === 'added') {
                      hunkLines.push(`+${diff.right || ''}`);
                      rightLineNum++;
                    } else if (diff.type === 'modified') {
                      hunkLines.push(`-${diff.left || ''}`);
                      hunkLines.push(`+${diff.right || ''}`);
                      leftLineNum++;
                      rightLineNum++;
                    }
                  }
                }

                // Output any remaining hunk
                if (hunkStart !== null) {
                  unifiedDiff += this.formatHunk(hunkStart, hunkLines, leftLineNum, rightLineNum);
                }

                return unifiedDiff;
              }

              formatHunk(hunkStart, hunkLines, endLeftLine, endRightLine) {
                const leftCount = endLeftLine - hunkStart.left;
                const rightCount = endRightLine - hunkStart.right;
                
                let hunk = `@@ -${hunkStart.left},${leftCount} +${hunkStart.right},${rightCount} @@\n`;
                hunk += hunkLines.join('\n') + '\n';
                
                return hunk;
              }

              showLoading() {
                const container = document.getElementById('diffContent');
                container.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-3">Comparing files...</p>
                  </div>
                `;
                document.getElementById('comparisonSection').style.display = 'block';
              }

              showError(message) {
                const container = document.getElementById('diffContent');
                container.innerHTML = `
                  <div class="text-center" style="padding: 50px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    <p class="mt-3 text-danger">${message}</p>
                  </div>
                `;
                document.getElementById('comparisonSection').style.display = 'block';
              }
            }

            // Global reference for onclick handlers
            let configCompare;

            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
              configCompare = new ConfigCompare();
            });
          </script>

        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="float-end">
            Cockpit - Network Management Dashboard
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
      </div>
    </div>
  </body>
</html>
