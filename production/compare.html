<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Config Compare - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    <script>
      // Robust authentication check
      (function () {
        console.log("Checking authentication...");

        // Check if we have a valid token
        const token = localStorage.getItem("auth_token");
        console.log("Token found:", !!token);

        if (!token) {
          console.log("No token found, redirecting to login");
          // Use correct path for Vite dev server on port 3000
          window.location.href = "/production/login.html";
          return;
        }

        console.log("Token found, user authenticated");
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      // Initialize auth manager when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        window.authManager = new AuthManager();
        console.log("AuthManager initialized");

        // Force update display after a short delay to ensure DOM is ready
        setTimeout(function () {
          if (window.authManager && window.authManager.user) {
            window.authManager.updateUserDisplay();
            console.log("Force updated user display");
          }
        }, 500);

        // Listen for storage changes (when user logs in from another tab/window)
        window.addEventListener("storage", function (e) {
          if (e.key === "user_info" || e.key === "auth_token") {
            console.log("Storage changed, refreshing auth manager");
            // Reinitialize auth manager to pick up new user data
            window.authManager = new AuthManager();
            if (window.authManager.user) {
              window.authManager.updateUserDisplay();
              console.log("Updated display after storage change");
            }
          }
        });

        // Check for recent login and refresh display
        const checkRecentLogin = () => {
          const userInfo = localStorage.getItem("user_info");
          const token = localStorage.getItem("auth_token");

          if (userInfo && token && window.authManager) {
            try {
              const user = JSON.parse(userInfo);
              if (user && user.username !== "Guest" && user.username !== "") {
                // Update auth manager with fresh data
                window.authManager.user = user;
                window.authManager.token = token;
                window.authManager.updateUserDisplay();
                console.log("Refreshed display with login data:", user.username);
              }
            } catch (e) {
              console.log("Error parsing fresh user info:", e);
            }
          }
        };

        // Check periodically for login updates
        setTimeout(checkRecentLogin, 1000);
        setTimeout(checkRecentLogin, 2000);
        setTimeout(checkRecentLogin, 3000);
      });
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0">
              <a href="index.html" class="site_title"
                ><i class="fas fa-paw"></i> <span>Cockpit!</span></a
              >
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
                <!-- Profile image removed -->
              </div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <script>
              // Immediate sidebar username update if user info is available
              (function () {
                console.log("=== SIDEBAR UPDATE DEBUG ===");

                const updateSidebar = () => {
                  const userInfo = localStorage.getItem("user_info");
                  console.log("User info for sidebar:", userInfo);

                  const sidebarElement = document.getElementById("sidebar-username");
                  const welcomeElement = document.getElementById("welcome-message");
                  console.log("Sidebar element found:", !!sidebarElement);
                  console.log("Welcome element found:", !!welcomeElement);

                  if (userInfo && sidebarElement) {
                    try {
                      const user = JSON.parse(userInfo);
                      console.log("Parsed user for sidebar:", user);
                      sidebarElement.textContent = user.full_name || user.username || "User";
                      if (welcomeElement) {
                        welcomeElement.textContent = `Welcome, ${user.username || "User"}!`;
                      }
                      console.log("Updated sidebar successfully");
                    } catch (e) {
                      console.log("Error parsing user info for sidebar:", e);
                      sidebarElement.textContent = "Guest";
                      if (welcomeElement) {
                        welcomeElement.textContent = "Welcome, Guest!";
                      }
                    }
                  } else if (sidebarElement) {
                    sidebarElement.textContent = "Guest";
                    if (welcomeElement) {
                      welcomeElement.textContent = "Welcome, Guest!";
                    }
                    console.log("No user info, set sidebar to Guest");
                  }
                };

                // Update immediately
                updateSidebar();

                // Update again after short delays to catch login updates
                setTimeout(updateSidebar, 1000);
                setTimeout(updateSidebar, 2000);
                setTimeout(updateSidebar, 3000);
              })();
            </script>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li>
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-rocket"></i> Onboarding
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="onboard-device.html"
                          ><i class="fas fa-plus-circle"></i> Onboard Device</a
                        >
                      </li>
                      <li>
                        <a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a>
                      </li>
                      <li>
                        <a href="scan-and-add.html"
                          ><i class="fas fa-search-plus"></i> Scan & Add</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Configs <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li><a href="backup.html">Backup</a></li>
                      <li><a href="compare.html" class="current-page">Compare</a></li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Ansible <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="ansible-inventory.html"><i class="fas fa-list"></i> Inventory</a>
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-wrench"></i> Settings
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a>
                      </li>
                      <li>
                        <a href="settings-templates.html"
                          ><i class="fas fa-file-code"></i> Templates</a
                        >
                      </li>
                      <li>
                        <a href="settings-git.html"
                          ><i class="fab fa-git-alt"></i> Git Management</a
                        >
                      </li>
                      <li>
                        <a href="settings-cache.html"><i class="fas fa-bolt"></i> Cache</a>
                      </li>
                      <li>
                        <a href="settings-credentials.html"
                          ><i class="fas fa-key"></i> Credentials</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
              <div class="menu_section">
                <!-- Live On section removed as requested -->
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a
                href="settings-nautobot.html"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Settings"
              >
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px">
                  <a
                    href="javascript:;"
                    class="user-profile dropdown-toggle"
                    aria-haspopup="true"
                    id="navbarDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <script>
                    // Immediate username update if user info is available
                    (function () {
                      console.log("=== USERNAME UPDATE DEBUG ===");

                      const updateNavbar = () => {
                        const userInfo = localStorage.getItem("user_info");
                        const token = localStorage.getItem("auth_token");
                        console.log("User info:", userInfo);
                        console.log("Token:", token);

                        const element = document.getElementById("navbar-username");
                        console.log("Element found:", !!element);

                        if (userInfo && element) {
                          try {
                            const user = JSON.parse(userInfo);
                            console.log("Parsed user:", user);
                            const displayName = user.full_name || user.username || "User";
                            element.textContent = displayName;
                            console.log("Set username to:", displayName);
                          } catch (e) {
                            console.log("Error parsing user info:", e);
                            element.textContent = "Guest";
                          }
                        } else if (element) {
                          element.textContent = "Guest";
                          console.log("No user info, set to Guest");
                        }
                      };

                      // Update immediately
                      updateNavbar();

                      // Update again after short delays to catch login updates
                      setTimeout(updateNavbar, 1000);
                      setTimeout(updateNavbar, 2000);
                      setTimeout(updateNavbar, 3000);
                    })();
                  </script>
                  <div
                    class="dropdown-menu dropdown-usermenu float-end"
                    aria-labelledby="navbarDropdown"
                  >
                    <a class="dropdown-item" href="javascript:;"> Profile</a>
                    <a class="dropdown-item" href="settings-nautobot.html">
                      <span class="badge bg-red float-end">50%</span>
                      <span>Settings</span>
                    </a>
                    <a class="dropdown-item" href="javascript:;">Help</a>
                    <a class="dropdown-item" href="login.html"
                      ><i class="fas fa-sign-out-alt float-end"></i> Log Out</a
                    >
                  </div>
                </li>

                <li role="presentation" class="nav-item dropdown open">
                  <a
                    href="javascript:;"
                    class="dropdown-toggle info-number"
                    id="navbarDropdown1"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="fas fa-envelope"></i>
                    <span class="badge bg-green">6</span>
                  </a>
                  <ul
                    class="dropdown-menu list-unstyled msg_list"
                    role="menu"
                    aria-labelledby="navbarDropdown1"
                  >
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were
                          where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were
                          where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were
                          where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="dropdown-item">
                        <span>
                          <span>John Smith</span>
                          <span class="time">3 mins ago</span>
                        </span>
                        <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were
                          where...
                        </span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <div class="text-center">
                        <a class="dropdown-item">
                          <strong>See All Alerts</strong>
                          <i class="fas fa-angle-right"></i>
                        </a>
                      </div>
                    </li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main" style="height: 100vh; overflow-y: auto">
          <!-- page title -->
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Compare configurations</h3>
              </div>
            </div>
          </div>

          <div class="clearfix"></div>

          <!-- Git Repository Selection Section -->
          <div class="row" id="gitRepositorySection">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>
                    Git Repository Configuration
                    <small>Select repository for configuration comparison</small>
                  </h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li>
                      <a class="collapse-link"><i class="fas fa-chevron-down"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <!-- Repository Selection -->
                  <div class="row" id="repositorySelection">
                    <div class="col-md-8">
                      <div class="form-group">
                        <label for="repoSelector" class="control-label"
                          >Select Git Repository:</label
                        >
                        <div class="d-flex align-items-center">
                          <select id="repoSelector" class="form-control">
                            <option value="">Loading repositories...</option>
                          </select>
                          <span id="repoStatusCheck" style="display: none; margin-left: 10px">
                            <i
                              class="fas fa-check-circle"
                              style="color: #28a745; font-size: 18px"
                              title="Repository ready"
                            ></i>
                          </span>
                        </div>
                        <small class="form-text text-muted"
                          >Choose a repository from the "configs" category for configuration
                          comparison</small
                        >
                        <!-- Compact repository info display -->
                        <div id="selectedRepoInfoInline" style="display: none; margin-top: 5px">
                          <small class="text-muted">
                            <strong><span id="selectedRepoName">-</span></strong> | Branch:
                            <span id="selectedRepoBranch">-</span> | URL:
                            <code id="selectedRepoUrl" style="font-size: 10px">-</code>
                          </small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="btn-group w-100" role="group" style="margin-top: 25px">
                        <button class="btn btn-success" id="syncRepository" disabled>
                          <i class="fas fa-sync"></i> Sync Repository
                        </button>
                        <button class="btn btn-info" id="gitStatusBtn" disabled>
                          <i class="fas fa-info-circle"></i> Git Status
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- No Repositories Message -->
                  <div class="row" id="noRepositoriesMessage" style="display: none">
                    <div class="col-md-12">
                      <div class="alert alert-warning">
                        <h5>
                          <i class="fas fa-exclamation-triangle"></i> No Configuration Repositories
                          Found
                        </h5>
                        <p>
                          No Git repositories in the "configs" category are available for
                          configuration comparison.
                        </p>
                        <p>Please configure a Git repository in the Git Management system:</p>
                        <a href="settings-git.html" class="btn btn-primary">
                          <i class="fab fa-git-alt"></i> Go to Git Management
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- File Selection Section -->
          <div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>
                    Configuration Comparison <small>Choose files or Git commits to compare</small>
                  </h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li>
                      <a class="collapse-link"><i class="fas fa-chevron-down"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <!-- Comparison Mode Selection -->
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label class="control-label">Comparison Mode</label>
                        <div class="btn-group w-100" role="group" id="comparisonModeToggle">
                          <input
                            type="radio"
                            class="btn-check"
                            name="comparisonMode"
                            id="fileMode"
                            value="files"
                            checked
                          />
                          <label class="btn btn-outline-primary" for="fileMode">
                            <i class="fas fa-folder"></i> Files
                          </label>
                          <input
                            type="radio"
                            class="btn-check"
                            name="comparisonMode"
                            id="gitMode"
                            value="git"
                          />
                          <label class="btn btn-outline-primary" for="gitMode">
                            <i class="fas fa-code-branch"></i> Git Commits
                          </label>
                          <input
                            type="radio"
                            class="btn-check"
                            name="comparisonMode"
                            id="historyMode"
                            value="history"
                          />
                          <label class="btn btn-outline-primary" for="historyMode">
                            <i class="fas fa-history"></i> File History
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- File Comparison Mode -->
                  <div id="fileComparisonMode">
                    <div class="row">
                      <!-- Left File Selection -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="leftFileSearch">Source File (Left)</label>
                          <div class="input-group">
                            <input
                              type="text"
                              class="form-control"
                              id="leftFileSearch"
                              placeholder="Type to search files..."
                              autocomplete="off"
                            />
                            <span class="input-group-text">
                              <i class="fas fa-search"></i>
                            </span>
                          </div>
                          <!-- Search Results Dropdown -->
                          <div
                            class="file-search-results"
                            id="leftFileResults"
                            style="display: none"
                          >
                            <div class="list-group">
                              <!-- Results will be populated here -->
                            </div>
                          </div>
                          <!-- Selected File Display -->
                          <div
                            class="selected-file-info"
                            id="leftSelectedFile"
                            style="display: none"
                          >
                            <small class="text-muted"
                              >Selected: <span class="selected-path"></span
                            ></small>
                          </div>
                        </div>
                      </div>

                      <!-- Right File Selection -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="rightFileSearch">Target File (Right)</label>
                          <div class="input-group">
                            <input
                              type="text"
                              class="form-control"
                              id="rightFileSearch"
                              placeholder="Type to search files..."
                              autocomplete="off"
                            />
                            <span class="input-group-text">
                              <i class="fas fa-search"></i>
                            </span>
                          </div>
                          <!-- Search Results Dropdown -->
                          <div
                            class="file-search-results"
                            id="rightFileResults"
                            style="display: none"
                          >
                            <div class="list-group">
                              <!-- Results will be populated here -->
                            </div>
                          </div>
                          <!-- Selected File Display -->
                          <div
                            class="selected-file-info"
                            id="rightSelectedFile"
                            style="display: none"
                          >
                            <small class="text-muted"
                              >Selected: <span class="selected-path"></span
                            ></small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- End File Comparison Mode -->

                  <!-- Git Comparison Mode -->
                  <div id="gitComparisonMode" style="display: none">
                    <div class="row">
                      <!-- Git Branch Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="gitBranchSelect">Branch</label>
                          <div class="input-group">
                            <select class="form-control" id="gitBranchSelect">
                              <option value="">Select branch...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-branch"></i>
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- Left Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="leftCommitSelect">Source Commit (Left)</label>
                          <div class="input-group">
                            <select class="form-control" id="leftCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- Right Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="rightCommitSelect">Target Commit (Right)</label>
                          <div class="input-group">
                            <select class="form-control" id="rightCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- File Selection within Git Mode -->
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="gitFileSearch">File to Compare (from selected commits)</label>
                          <div class="input-group">
                            <input
                              type="text"
                              class="form-control"
                              id="gitFileSearch"
                              placeholder="Type to search files from selected commits..."
                              autocomplete="off"
                            />
                            <span class="input-group-text">
                              <i class="fas fa-search"></i>
                            </span>
                          </div>
                          <!-- Search Results Dropdown -->
                          <div
                            class="file-search-results"
                            id="gitFileResults"
                            style="display: none"
                          >
                            <div class="list-group">
                              <!-- Results will be populated here -->
                            </div>
                          </div>
                          <!-- Selected File Display -->
                          <div
                            class="selected-file-info"
                            id="gitSelectedFile"
                            style="display: none"
                          >
                            <small class="text-muted"
                              >Selected: <span class="selected-path"></span
                            ></small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- File History Mode -->
                  <div id="fileHistoryMode" style="display: none">
                    <div class="row">
                      <!-- Branch Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyBranchSelect">Branch</label>
                          <div class="input-group">
                            <select class="form-control" id="historyBranchSelect">
                              <option value="main">main</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-branch"></i>
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- Commit Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyCommitSelect">Commit</label>
                          <div class="input-group">
                            <select class="form-control" id="historyCommitSelect">
                              <option value="">Select commit...</option>
                            </select>
                            <span class="input-group-text">
                              <i class="fas fa-code-commit"></i>
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- File Selection -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="historyFileSearch">File</label>
                          <div class="input-group">
                            <input
                              type="text"
                              class="form-control"
                              id="historyFileSearch"
                              placeholder="Type to search files..."
                              autocomplete="off"
                            />
                            <span class="input-group-text">
                              <i class="fas fa-search"></i>
                            </span>
                          </div>
                          <!-- Search Results Dropdown -->
                          <div
                            class="file-search-results"
                            id="historyFileResults"
                            style="display: none"
                          >
                            <div class="list-group">
                              <!-- Results will be populated here -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Show History and Compare Buttons for File History Mode -->
                    <div class="row">
                      <div class="col-md-12">
                        <div class="text-center" style="margin-top: 15px">
                          <button class="btn btn-primary" id="showHistoryBtn" disabled>
                            <i class="fas fa-history"></i> Show History
                          </button>
                          <button class="btn btn-primary ms-2" id="historyCompareBtn" disabled>
                            <i class="fas fa-exchange-alt"></i> Compare
                          </button>
                          <button class="btn btn-success ms-2" id="historyExportBtn" disabled>
                            <i class="fas fa-download"></i> Export Diff
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- File History Display -->
                    <div
                      class="row"
                      id="fileHistoryDisplay"
                      style="display: none; margin-top: 20px"
                    >
                      <div class="col-md-12">
                        <div class="card">
                          <div
                            class="card-header d-flex justify-content-between align-items-center"
                          >
                            <h6 class="mb-0">
                              <i class="fas fa-clock"></i> File History:
                              <span id="historyFileName"></span>
                            </h6>
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-secondary"
                              id="closeFileHistoryDisplayBtn"
                              title="Close File History"
                            >
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                          <div class="card-body">
                            <div id="historyContent">
                              <!-- History timeline will be populated here -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- File History Information - Shared between both modes -->
                  <div class="row" id="fileHistorySection" style="display: none; margin-top: 15px">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <h6 class="mb-0">
                            <i class="fas fa-clock"></i> File History Information
                          </h6>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-secondary"
                            id="closeHistoryBtn"
                            title="Close History"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                        <div class="card-body">
                          <div class="row">
                            <div class="col-md-6">
                              <div id="leftFileHistory">
                                <h6 class="text-muted">Source File</h6>
                                <div id="leftFileHistoryContent">
                                  <p class="text-muted"><i>Select a file to view its history</i></p>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div id="rightFileHistory">
                                <h6 class="text-muted">Target File</h6>
                                <div id="rightFileHistoryContent">
                                  <p class="text-muted"><i>Select a file to view its history</i></p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Compare Button and Controls - Hidden for File History Mode -->
                  <div class="row" id="sharedCompareControls">
                    <div class="col-md-12">
                      <div class="text-center" style="margin-top: 15px">
                        <button class="btn btn-primary" id="compareBtn" disabled>
                          <i class="fas fa-exchange-alt"></i> Compare
                        </button>
                        <button class="btn btn-success ms-2" id="exportBtn" disabled>
                          <i class="fas fa-download"></i> Export Diff
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Comparison Results Section -->
          <div class="row" id="comparisonSection" style="display: none">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>Comparison Results <small id="comparisonStats">Comparing files...</small></h2>
                  <ul
                    class="nav navbar-right panel_toolbox"
                    style="display: flex; align-items: center; gap: 8px"
                  >
                    <li>
                      <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" id="prevDiffBtn" disabled>
                          <i class="fas fa-chevron-up"></i> Previous
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="nextDiffBtn" disabled>
                          <i class="fas fa-chevron-down"></i> Next
                        </button>
                      </div>
                    </li>
                    <li>
                      <button class="btn btn-sm btn-outline-secondary" id="toggleUnchangedBtn">
                        <i class="fas fa-eye-slash"></i> Hide Unchanged
                      </button>
                    </li>
                    <li>
                      <div
                        class="btn-group"
                        role="group"
                        style="display: flex; align-items: center"
                      >
                        <label
                          class="btn btn-sm btn-outline-secondary"
                          style="
                            font-size: 11px;
                            padding: 6px 8px;
                            margin: 0;
                            border-right: none;
                            display: flex;
                            align-items: center;
                            height: 31px;
                          "
                        >
                          <i class="fas fa-text-height me-1"></i> Size:
                        </label>
                        <select
                          class="form-select btn-sm"
                          id="fontSizeSelect"
                          style="
                            font-size: 11px;
                            padding: 6px 8px;
                            height: 31px;
                            border-left: 1px solid #dee2e6;
                          "
                        >
                          <option value="10">XS</option>
                          <option value="11">S</option>
                          <option value="12" selected>M</option>
                          <option value="13">L</option>
                          <option value="14">XL</option>
                        </select>
                      </div>
                    </li>
                    <li>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        id="closeResultsBtn"
                        title="Close Comparison Results"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </li>
                    <li>
                      <a class="collapse-link"><i class="fas fa-chevron-up"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <!-- Diff Display Container -->
                  <div class="diff-container">
                    <div class="diff-header">
                      <div class="diff-column diff-left">
                        <h5 id="leftFileName">Source File</h5>
                      </div>
                      <div class="diff-column diff-right">
                        <h5 id="rightFileName">Target File</h5>
                      </div>
                    </div>

                    <div class="diff-content" id="diffContent">
                      <div class="diff-loading text-center" style="padding: 50px">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-3">Select files to start comparison...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Custom CSS for Diff Display -->
          <style>
            .diff-container {
              border: 1px solid #e6e9ed;
              border-radius: 5px;
              overflow: hidden;
              height: calc(100vh - 80px);
            }

            .diff-header {
              display: flex;
              background: #f8f9fa;
              border-bottom: 1px solid #e6e9ed;
            }

            .diff-column {
              flex: 1;
              padding: 4px 10px;
              border-right: 1px solid #e6e9ed;
            }

            .diff-column:last-child {
              border-right: none;
            }

            .diff-column h5 {
              margin: 0;
              font-size: 13px;
              font-weight: 600;
              color: #495057;
            }

            .diff-content {
              height: calc(100vh - 120px);
              max-height: none;
              min-height: calc(100vh - 120px);
              overflow-y: auto;
              position: relative;
            }

            .diff-row {
              display: flex;
              font-family: "Courier New", monospace;
              font-size: var(--diff-font-size, 12px);
              line-height: var(--diff-line-height, 1.1);
              border-bottom: 1px solid #f1f3f4;
            }

            .diff-line {
              flex: 1;
              padding: 1px 6px;
              white-space: pre;
              border-right: 1px solid #f1f3f4;
              position: relative;
            }

            .diff-line:last-child {
              border-right: none;
            }

            .diff-line-number {
              display: inline-block;
              width: 40px;
              color: #6c757d;
              text-align: right;
              margin-right: 6px;
              user-select: none;
              font-size: calc(var(--diff-font-size, 12px) - 1px);
            }

            .diff-line-content {
              display: inline;
            }

            /* Diff Colors */
            .diff-added {
              background-color: #d4edda;
              border-left: 3px solid #28a745;
            }

            .diff-removed {
              background-color: #f8d7da;
              border-left: 3px solid #dc3545;
            }

            .diff-modified {
              background-color: #e2e3e5;
              border-left: 3px solid #6c757d;
            }

            .diff-unchanged {
              background-color: #ffffff;
            }

            .diff-char-added {
              background-color: #28a745;
              color: white;
              padding: 1px 2px;
              border-radius: 2px;
            }

            .diff-char-removed {
              background-color: #dc3545;
              color: white;
              padding: 1px 2px;
              border-radius: 2px;
            }

            .diff-hidden {
              display: none;
            }

            .diff-expand {
              background-color: #f8f9fa;
              text-align: center;
              cursor: pointer;
              color: #007bff;
              font-style: italic;
              padding: 8px;
            }

            .diff-expand:hover {
              background-color: #e9ecef;
            }

            /* Sync Scrolling */
            .diff-content::-webkit-scrollbar {
              width: 8px;
            }

            .diff-content::-webkit-scrollbar-track {
              background: #f1f1f1;
            }

            .diff-content::-webkit-scrollbar-thumb {
              background: #c1c1c1;
              border-radius: 4px;
            }

            .diff-content::-webkit-scrollbar-thumb:hover {
              background: #a8a8a8;
            }

            /* File History Styles */
            .file-history-info {
              font-size: 13px;
            }

            .file-history-info p {
              margin-bottom: 5px;
            }

            .file-history-info strong {
              color: #495057;
            }

            .file-history-info code {
              background-color: #f8f9fa;
              padding: 2px 4px;
              border-radius: 3px;
              font-size: 12px;
            }

            #fileHistorySection .card {
              border: 1px solid #e3e6f0;
              box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            }

            #fileHistorySection .card-header {
              background-color: #f8f9fc;
              border-bottom: 1px solid #e3e6f0;
              padding: 0.75rem 1.25rem;
            }

            /* Timeline styles for File History mode */
            .timeline {
              position: relative;
              padding: 0;
              margin: 0;
            }

            .timeline-header {
              margin-bottom: 0.5rem;
              padding-bottom: 0.25rem;
              border-bottom: 1px solid #e3e6f0;
            }

            .timeline-item {
              position: relative;
              padding: 0.75rem 0 0.75rem 3rem;
              border-left: 2px solid #e3e6f0;
              transition: all 0.2s ease;
            }

            .timeline-item:last-child {
              border-left-color: transparent;
            }

            .timeline-item.timeline-current {
              border-left-color: #007bff;
            }

            .timeline-marker {
              position: absolute;
              left: -0.6rem;
              top: 1rem;
              width: 1.2rem;
              height: 1.2rem;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 0.6rem;
              border: 2px solid white;
              box-shadow: 0 0 0 2px #e3e6f0;
            }

            .timeline-item.timeline-current .timeline-marker {
              box-shadow: 0 0 0 2px #007bff;
            }

            .timeline-content {
              background: #f8f9fc;
              border: 1px solid #e3e6f0;
              border-radius: 0.35rem;
              padding: 0.75rem;
              margin-left: 0.5rem;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }

            .timeline-item.timeline-current .timeline-content {
              background: #e7f3ff;
              border-color: #007bff;
            }

            .timeline-item.timeline-selectable {
              cursor: pointer;
              transition: all 0.2s ease;
            }

            .timeline-item.timeline-selectable:hover .timeline-content {
              background: #f0f0f0;
              border-color: #007bff;
            }

            .timeline-item.timeline-selected .timeline-content {
              background: #d4edda;
              border-color: #28a745;
              box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
            }

            .timeline-item.timeline-selected .timeline-marker {
              background-color: #28a745 !important;
              box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.5);
            }

            .timeline-main-content {
              flex: 1;
              display: flex;
              align-items: center;
              gap: 1rem;
            }

            .timeline-commit-info {
              flex: 0 0 120px;
              font-family: "Courier New", monospace;
              font-size: 0.85rem;
            }

            .timeline-author-info {
              flex: 0 0 150px;
              font-size: 0.85rem;
            }

            .timeline-message-info {
              flex: 1;
              font-size: 0.85rem;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }

            .timeline-time-info {
              flex: 0 0 180px;
              font-size: 0.8rem;
              color: #6c757d;
            }

            .timeline-actions {
              flex: 0 0 auto;
              display: flex;
              gap: 0.25rem;
            }

            .timeline-actions .btn {
              font-size: 0.7rem;
              padding: 0.2rem 0.4rem;
              line-height: 1.2;
            }

            .timeline-title {
              color: #5a5c69;
              font-weight: 600;
              margin: 0;
              font-size: 0.85rem;
            }

            .timeline-time {
              font-size: 0.8rem;
              margin: 0;
            }

            .timeline-body {
              color: #6c757d;
              margin: 0;
            }

            .timeline-body p {
              margin: 0;
            }

            /* File Search Container - Ensure proper positioning context */
            .form-group {
              position: relative;
            }

            /* File Search Results Styling */
            .file-search-results {
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              z-index: 10000;
              max-height: 400px;
              overflow-y: auto;
              background: white;
              border: 1px solid #ced4da;
              border-top: none;
              border-radius: 0 0 0.375rem 0.375rem;
              box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
            }

            .file-search-results .list-group-item {
              border-left: none;
              border-right: none;
              border-radius: 0;
              cursor: pointer;
              padding: 0.5rem 0.75rem;
            }

            .file-search-results .list-group-item:hover,
            .file-search-results .list-group-item.active {
              background-color: #e9ecef;
            }

            .file-item-name {
              font-weight: 500;
              color: #495057;
            }

            .file-item-path {
              font-size: 0.875rem;
              color: #6c757d;
              margin-top: 0.25rem;
            }

            .file-item-directory {
              font-size: 0.75rem;
              color: #6c757d;
              background: #f8f9fa;
              padding: 0.125rem 0.375rem;
              border-radius: 0.25rem;
              display: inline-block;
              margin-left: 0.5rem;
            }

            .selected-file-info {
              margin-top: 0.5rem;
              padding: 0.375rem 0.75rem;
              background: #e7f3ff;
              border-radius: 0.375rem;
              border: 1px solid #b8daff;
            }

            .form-group {
              position: relative;
              overflow: visible; /* Ensure dropdown is not clipped */
            }

            /* Ensure parent containers don't clip the search dropdown */
            .x_panel,
            .x_content {
              overflow: visible !important;
            }
          </style>

          <!-- JavaScript for Compare Functionality -->
          <script>
            class ConfigCompare {
              constructor() {
                console.log("ConfigCompare: Constructor called");
                this.files = [];
                this.gitFiles = [];
                this.gitFileSearchInitialized = false;
                this.historyFileSearchInitialized = false;
                this.selectedGitFile = null;
                this.selectedHistoryFile = null;
                this.selectedHistoryRows = [];
                this.currentDiffs = [];
                this.currentDiffIndex = 0;
                this.hideUnchanged = false;
                this.selectedLeftFile = null;
                this.selectedRightFile = null;
                this.gitData = {
                  branches: [],
                  commits: [],
                  currentBranch: null,
                  status: null,
                };
                this.repositories = [];
                this.selectedRepository = null;
                console.log("ConfigCompare: Calling init()");
                this.init();
              }

              init() {
                // Initialize event listeners with null checks
                const addEventListenerSafe = (id, event, handler) => {
                  const element = document.getElementById(id);
                  if (element) {
                    element.addEventListener(event, handler);
                  } else {
                    console.warn(
                      `ConfigCompare: Element '${id}' not found, skipping event listener`
                    );
                  }
                };

                addEventListenerSafe("compareBtn", "click", () => this.handleCompare());
                addEventListenerSafe("exportBtn", "click", () => this.exportDiff());
                addEventListenerSafe("historyCompareBtn", "click", () => this.handleCompare());
                addEventListenerSafe("historyExportBtn", "click", () => this.exportDiff());
                addEventListenerSafe("prevDiffBtn", "click", () => this.navigateDiff(-1));
                addEventListenerSafe("nextDiffBtn", "click", () => this.navigateDiff(1));
                addEventListenerSafe("toggleUnchangedBtn", "click", () => this.toggleUnchanged());
                addEventListenerSafe("fontSizeSelect", "change", (e) =>
                  this.changeFontSize(e.target.value)
                );
                addEventListenerSafe("gitStatusBtn", "click", () => this.showGitStatus());
                addEventListenerSafe("closeHistoryBtn", "click", () => this.closeFileHistory());
                addEventListenerSafe("closeResultsBtn", "click", () =>
                  this.closeComparisonResults()
                );
                addEventListenerSafe("closeFileHistoryDisplayBtn", "click", () =>
                  this.closeFileHistoryDisplay()
                );

                // Repository selection event listeners
                addEventListenerSafe("repoSelector", "change", (e) =>
                  this.handleRepositorySelection(e)
                );
                addEventListenerSafe("syncRepository", "click", () =>
                  this.syncSelectedRepository()
                );

                // File search will be initialized when files are loaded by populateFileSelects

                // Git selection change handlers with safe wrapper
                addEventListenerSafe("leftCommitSelect", "change", () => {
                  this.populateGitFiles();
                  this.updateCompareButton();
                  this.loadGitFileHistory();
                });
                addEventListenerSafe("rightCommitSelect", "change", () => {
                  this.populateGitFiles();
                  this.updateCompareButton();
                  this.loadGitFileHistory();
                });

                addEventListenerSafe("gitBranchSelect", "change", async (e) => {
                  const selectedBranch = e.target.value;
                  if (selectedBranch) {
                    await this.loadCommitsForBranch(selectedBranch);
                  }
                });

                // File History mode selection change handlers
                addEventListenerSafe("historyBranchSelect", "change", async (e) => {
                  const selectedBranch = e.target.value;
                  if (selectedBranch) {
                    await this.loadHistoryCommitsForBranch(selectedBranch);
                  }
                });
                addEventListenerSafe("historyCommitSelect", "change", () => {
                  // Update the show history button state
                  this.updateShowHistoryButton();
                });
                addEventListenerSafe("showHistoryBtn", "click", () => {
                  this.showFileHistory();
                }); // Comparison mode toggle
                document.querySelectorAll('input[name="comparisonMode"]').forEach((radio) => {
                  radio.addEventListener(
                    "change",
                    async (e) => await this.handleModeChange(e.target.value)
                  );
                });

                // Load files and Git data on page load (with delay for authManager)
                this.loadFiles();

                // Load saved font size preference
                this.loadFontSizePreference();

                // Load repositories and initialize repository selection
                this.loadRepositories();
              }

              // Repository Management
              async loadRepositories() {
                console.log("ConfigCompare: Starting to load repositories...");

                if (!window.authManager) {
                  console.log("ConfigCompare: AuthManager not ready, retrying in 500ms...");
                  setTimeout(() => this.loadRepositories(), 500);
                  return;
                }

                console.log("ConfigCompare: AuthManager ready, loading repositories...");
                console.log(
                  "ConfigCompare: AuthManager authenticated?",
                  window.authManager.isAuthenticated()
                );
                console.log("ConfigCompare: AuthManager token?", !!window.authManager.token);
                console.log("ConfigCompare: AuthManager user?", !!window.authManager.user);

                try {
                  // Load config repositories
                  console.log("ConfigCompare: Calling /api/git-repositories/configs...");
                  const response = await window.authManager.apiRequest(
                    "/api/git-repositories/configs"
                  );
                  console.log("ConfigCompare: Repositories response:", response);
                  this.repositories = response.repositories || [];
                  console.log("ConfigCompare: Found", this.repositories.length, "repositories");

                  // Load currently selected repository
                  console.log("ConfigCompare: Calling /api/git-repositories/selected...");
                  let selectedResponse;
                  try {
                    selectedResponse = await window.authManager.apiRequest(
                      "/api/git-repositories/selected"
                    );
                    console.log("ConfigCompare: Selected repository response:", selectedResponse);
                  } catch (selectedError) {
                    console.log(
                      "ConfigCompare: Error calling /api/git-repositories/selected:",
                      selectedError
                    );
                    console.log("ConfigCompare: Selected error details:", {
                      message: selectedError.message,
                      status: selectedError.status,
                      statusText: selectedError.statusText,
                      url: selectedError.url,
                      stack: selectedError.stack,
                    });
                    // Continue without selected repository
                    selectedResponse = { selected_repository: null };
                  }

                  this.populateRepositorySelector();

                  if (selectedResponse.selected_repository) {
                    this.selectedRepository = selectedResponse.selected_repository;
                    this.selectRepository(selectedResponse.selected_repository.id, false);
                  } else if (this.repositories.length === 1) {
                    // Auto-select if only one repository available
                    console.log(
                      "ConfigCompare: Auto-selecting single repository:",
                      this.repositories[0].name
                    );
                    this.selectRepository(this.repositories[0].id, true);
                  } else if (this.repositories.length === 0) {
                    console.log("ConfigCompare: No repositories found, showing message");
                    this.showNoRepositoriesMessage();
                  }
                } catch (error) {
                  console.error("ConfigCompare: Error loading repositories:", error);
                  console.error("ConfigCompare: Error details:", {
                    message: error.message,
                    status: error.status,
                    statusText: error.statusText,
                    url: error.url,
                  });

                  // Check if it's an authentication error
                  if (
                    error.message.includes("Not authenticated") ||
                    error.message.includes("Authentication expired")
                  ) {
                    console.log("ConfigCompare: Authentication issue, redirecting to login...");
                    window.location.href = "login.html";
                    return;
                  }

                  // Show user-friendly error message
                  this.showStatus("Failed to load repositories: " + error.message, "error");
                  this.showNoRepositoriesMessage();
                }
              }

              populateRepositorySelector() {
                console.log(
                  "ConfigCompare: Populating repository selector with",
                  this.repositories.length,
                  "repositories"
                );
                const selector = document.getElementById("repoSelector");

                if (this.repositories.length === 0) {
                  console.log("ConfigCompare: No repositories available");
                  selector.innerHTML = '<option value="">No repositories available</option>';
                  selector.disabled = true;
                  this.showNoRepositoriesMessage();
                  return;
                }

                console.log("ConfigCompare: Adding repositories to selector");
                selector.innerHTML = '<option value="">Select a repository...</option>';
                this.repositories.forEach((repo) => {
                  console.log("ConfigCompare: Adding repository:", repo.name, repo.id);
                  const option = document.createElement("option");
                  option.value = repo.id;
                  option.textContent = `${repo.name} (${repo.url})`;
                  selector.appendChild(option);
                });

                selector.disabled = false;
                document.getElementById("noRepositoriesMessage").style.display = "none";
                console.log("ConfigCompare: Repository selector populated successfully");
              }

              showNoRepositoriesMessage() {
                document.getElementById("repositorySelection").style.display = "none";
                document.getElementById("noRepositoriesMessage").style.display = "block";

                // Hide inline repository info
                document.getElementById("repoStatusCheck").style.display = "none";
                document.getElementById("selectedRepoInfoInline").style.display = "none";

                // Disable comparison modes that require Git
                this.updateRepositoryControls("error");
              }

              async handleRepositorySelection(event) {
                const repositoryId = parseInt(event.target.value);
                if (repositoryId) {
                  await this.selectRepository(repositoryId, true);
                }
              }

              async selectRepository(repositoryId, saveSelection = true) {
                try {
                  const repository = this.repositories.find((r) => r.id === repositoryId);
                  if (!repository) {
                    console.error("Repository not found:", repositoryId);
                    return;
                  }

                  this.selectedRepository = repository;

                  // Update the selector
                  document.getElementById("repoSelector").value = repositoryId;

                  // Save selection to database if requested
                  if (saveSelection) {
                    await window.authManager.apiRequest(
                      `/api/git-repositories/selected/${repositoryId}`,
                      {
                        method: "POST",
                      }
                    );
                  }

                  // Immediately check repository state and sync status
                  await this.checkRepositoryState();

                  console.log("Repository selected:", repository.name);
                } catch (error) {
                  console.error("Error selecting repository:", error);
                  this.showStatus("Error selecting repository: " + error.message, "error");
                }
              }

              async checkRepositoryState() {
                if (!this.selectedRepository) return;

                try {
                  console.log(
                    "ConfigCompare: Checking repository state for:",
                    this.selectedRepository.name
                  );

                  // Show loading state
                  this.updateRepositoryInfo("checking");

                  // Check if repository exists and is accessible via Git API
                  let repoStatus = null;

                  try {
                    // Get repository status using the unified git-repositories API
                    const repoResponse = await window.authManager.apiRequest(
                      `/api/git-repositories/${this.selectedRepository.id}/status`
                    );
                    if (repoResponse && repoResponse.success) {
                      repoStatus = repoResponse.data;
                      console.log("ConfigCompare: Repository status:", repoStatus);
                    } else {
                      console.log(
                        "ConfigCompare: Repository status check failed:",
                        repoResponse.message
                      );
                    }
                  } catch (repoError) {
                    console.log("ConfigCompare: Repository status API error:", repoError.message);
                  }

                  // Determine repository state
                  let repositoryState = "unknown";
                  let statusMessage = "Repository status unknown";

                  if (repoStatus) {
                    if (repoStatus.exists && repoStatus.is_git_repo) {
                      if (repoStatus.is_synced === false || repoStatus.behind_count > 0) {
                        repositoryState = "needs_sync";
                        statusMessage = `Repository needs sync (${repoStatus.behind_count || 0} commits behind)`;
                      } else {
                        repositoryState = "ready";
                        statusMessage = "Repository ready and synced";
                      }
                    } else if (repoStatus.exists && !repoStatus.is_git_repo) {
                      repositoryState = "needs_clone";
                      statusMessage =
                        "Directory exists but is not a Git repository - needs re-cloning";
                    } else {
                      repositoryState = "needs_clone";
                      statusMessage = "Repository needs to be cloned";
                    }
                  } else {
                    repositoryState = "error";
                    statusMessage = "Could not determine repository status";
                  }

                  // Store repository data for UI updates
                  this.gitData.status = repoStatus;
                  this.gitData.repositoryState = repositoryState;
                  this.gitData.statusMessage = statusMessage;

                  // If repository is ready, load Git data for branches and commits
                  if (repositoryState === "ready" || repositoryState === "needs_sync") {
                    try {
                      await this.loadGitData();
                    } catch (error) {
                      console.warn("Could not load Git data:", error.message);
                    }
                  } else {
                    // Clear Git data if repository is not ready
                    this.gitData.currentBranch = null;
                    this.gitData.commits = [];
                    this.gitData.branches = [];
                  }

                  // Update UI based on state
                  this.updateRepositoryInfo(repositoryState, statusMessage);
                  this.updateRepositoryControls(repositoryState);

                  console.log("ConfigCompare: Repository state check complete:", repositoryState);
                } catch (error) {
                  console.error("ConfigCompare: Error checking repository state:", error);
                  this.updateRepositoryInfo("error", "Error checking repository: " + error.message);
                  this.updateRepositoryControls("error");
                }
              }

              async loadGitData() {
                try {
                  console.log("ConfigCompare: Loading Git data (status, branches, commits)...");

                  // Load Git status to get current branch and commits
                  try {
                    const gitResponse = await window.authManager.apiRequest("/api/git/status");
                    if (gitResponse && gitResponse.current_branch) {
                      this.gitData.currentBranch = gitResponse.current_branch;
                      this.gitData.commits = gitResponse.commits || [];
                      console.log(
                        "ConfigCompare: Loaded",
                        this.gitData.commits.length,
                        "commits from Git status"
                      );
                    }
                  } catch (error) {
                    console.warn("ConfigCompare: Could not load Git status:", error.message);
                  }

                  // Load Git branches
                  try {
                    await this.populateGitBranches();
                  } catch (error) {
                    console.warn("ConfigCompare: Could not load Git branches:", error.message);
                  }

                  // Populate commits in UI dropdowns if we have commits
                  if (this.gitData.commits && this.gitData.commits.length > 0) {
                    this.populateGitCommits();
                  }

                  console.log("ConfigCompare: Git data loaded successfully");
                } catch (error) {
                  console.error("ConfigCompare: Error loading Git data:", error);
                  throw error;
                }
              }

              updateRepositoryInfo(state = "ready", message = null) {
                if (!this.selectedRepository) return;

                // Update repository details
                document.getElementById("selectedRepoName").textContent =
                  this.selectedRepository.name;
                document.getElementById("selectedRepoUrl").textContent =
                  this.selectedRepository.url;
                document.getElementById("selectedRepoBranch").textContent =
                  this.selectedRepository.branch;

                // Show/hide elements based on state
                const statusCheck = document.getElementById("repoStatusCheck");
                const inlineInfo = document.getElementById("selectedRepoInfoInline");
                const repoSelection = document.getElementById("repositorySelection");
                const noReposMessage = document.getElementById("noRepositoriesMessage");

                repoSelection.style.display = "block";
                noReposMessage.style.display = "none";

                // Update status indicator based on state
                if (statusCheck) {
                  const icon = statusCheck.querySelector("i");
                  const title = statusCheck.querySelector("i");

                  statusCheck.style.display = "inline";

                  // Reset classes
                  icon.className = "";
                  icon.style.color = "";

                  switch (state) {
                    case "ready":
                      icon.className = "fas fa-check-circle";
                      icon.style.color = "#28a745";
                      title.title = message || "Repository ready";
                      break;
                    case "needs_sync":
                      icon.className = "fas fa-exclamation-triangle";
                      icon.style.color = "#ffc107";
                      title.title = message || "Repository needs sync";
                      break;
                    case "needs_clone":
                      icon.className = "fas fa-download";
                      icon.style.color = "#17a2b8";
                      title.title = message || "Repository needs cloning";
                      break;
                    case "checking":
                      icon.className = "fas fa-spinner fa-spin";
                      icon.style.color = "#6c757d";
                      title.title = "Checking repository status...";
                      break;
                    case "error":
                      icon.className = "fas fa-times-circle";
                      icon.style.color = "#dc3545";
                      title.title = message || "Repository error";
                      break;
                    case "invalid":
                      icon.className = "fas fa-times-circle";
                      icon.style.color = "#dc3545";
                      title.title = message || "Invalid repository";
                      break;
                    default:
                      icon.className = "fas fa-question-circle";
                      icon.style.color = "#6c757d";
                      title.title = message || "Unknown status";
                  }
                }

                // Show inline info
                if (inlineInfo) {
                  inlineInfo.style.display = "block";
                }
              }

              updateRepositoryControls(state) {
                const syncBtn = document.getElementById("syncRepository");
                const statusBtn = document.getElementById("gitStatusBtn");
                const gitModeRadio = document.getElementById("gitMode");
                const historyModeRadio = document.getElementById("historyMode");

                // Enable/disable buttons based on state
                if (syncBtn) {
                  syncBtn.disabled = state === "checking" || state === "error";

                  // Update sync button text based on state
                  const syncText = syncBtn.querySelector("i").nextSibling;
                  if (syncText) {
                    switch (state) {
                      case "needs_clone":
                        syncText.textContent = " Clone Repository";
                        break;
                      case "needs_sync":
                        syncText.textContent = " Sync Repository";
                        break;
                      default:
                        syncText.textContent = " Sync Repository";
                    }
                  }
                }

                if (statusBtn) {
                  statusBtn.disabled =
                    state === "checking" || state === "error" || state === "needs_clone";
                }

                // Enable/disable Git comparison modes
                const gitModesEnabled = state === "ready" || state === "needs_sync";

                if (gitModeRadio) {
                  gitModeRadio.disabled = !gitModesEnabled;
                  if (gitModesEnabled) {
                    gitModeRadio.parentElement.classList.remove("disabled");
                  } else {
                    gitModeRadio.parentElement.classList.add("disabled");
                  }
                }

                if (historyModeRadio) {
                  historyModeRadio.disabled = !gitModesEnabled;
                  if (gitModesEnabled) {
                    historyModeRadio.parentElement.classList.remove("disabled");
                  } else {
                    historyModeRadio.parentElement.classList.add("disabled");
                  }
                }
              }

              async syncSelectedRepository() {
                if (!this.selectedRepository) return;

                try {
                  console.log("ConfigCompare: Syncing repository...");

                  // Show syncing state
                  this.updateRepositoryInfo("checking", "Syncing repository...");
                  this.updateRepositoryControls("checking");

                  const response = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/sync`,
                    {
                      method: "POST",
                    }
                  );

                  console.log("ConfigCompare: Repository sync response:", response);

                  if (response.success) {
                    console.log("ConfigCompare: Repository synced successfully");
                    console.log("ConfigCompare: Repository path:", response.repository_path);

                    // Show success message temporarily
                    this.updateRepositoryInfo(
                      "ready",
                      response.message || "Repository synced successfully"
                    );

                    // Immediately check repository state after sync to update UI properly
                    setTimeout(async () => {
                      await this.checkRepositoryState();
                    }, 1000);
                  } else {
                    console.error("ConfigCompare: Repository sync failed:", response.message);
                    this.updateRepositoryInfo("error", response.message || "Sync failed");
                    this.updateRepositoryControls("error");
                  }
                } catch (error) {
                  console.error("Error syncing repository:", error);
                  let errorMessage = "Sync failed: " + error.message;

                  // Extract more specific error message if available
                  if (error.detail) {
                    errorMessage = error.detail;
                  } else if (error.message && error.message.includes("detail:")) {
                    const detailMatch = error.message.match(/detail:\s*(.+)/);
                    if (detailMatch) {
                      errorMessage = detailMatch[1];
                    }
                  }

                  this.updateRepositoryInfo("error", errorMessage);
                  this.updateRepositoryControls("error");
                }
              }

              showStatus(message, type) {
                // You can implement a status display here if needed
                console.log(`Status (${type}):`, message);
              }

              // File Search Functionality
              initializeFileSearch(inputId, side, onSelectCallback) {
                const searchInput = document.getElementById(inputId);
                const resultsDiv = document.getElementById(`${side}FileResults`);
                const selectedDiv = document.getElementById(`${side}SelectedFile`);

                if (!searchInput) {
                  console.error(`Search input element not found: ${inputId}`);
                  return;
                }

                let searchTimeout;
                let currentQuery = "";
                let selectedFile = null;

                // Store callback for this input
                searchInput.onSelectCallback = onSelectCallback;

                // Search input handler
                searchInput.addEventListener("input", (e) => {
                  const query = e.target.value.trim();
                  currentQuery = query;

                  // Clear previous timeout
                  if (searchTimeout) {
                    clearTimeout(searchTimeout);
                  }

                  // Debounce search requests
                  searchTimeout = setTimeout(() => {
                    if (query.length >= 1) {
                      this.searchFiles(side, query);
                    } else {
                      this.hideSearchResults(side);
                    }
                  }, 300);
                });

                // Handle focus and blur events
                searchInput.addEventListener("focus", () => {
                  if (currentQuery.length >= 1) {
                    resultsDiv.style.display = "block";
                  }
                });

                searchInput.addEventListener("blur", (e) => {
                  // Delay hiding to allow clicking on results
                  setTimeout(() => {
                    if (!e.relatedTarget || !resultsDiv.contains(e.relatedTarget)) {
                      this.hideSearchResults(side);
                    }
                  }, 150);
                });

                // Keyboard navigation
                searchInput.addEventListener("keydown", (e) => {
                  this.handleKeyboardNavigation(side, e);
                });
              }

              // Git File Search Functionality
              initializeGitFileSearch() {
                const searchInput = document.getElementById("gitFileSearch");
                const resultsDiv = document.getElementById("gitFileResults");
                const selectedDiv = document.getElementById("gitSelectedFile");

                if (!searchInput) {
                  console.error("Git file search input element not found");
                  return;
                }

                let searchTimeout;
                let currentQuery = "";

                // Search input handler
                searchInput.addEventListener("input", (e) => {
                  const query = e.target.value.trim();
                  currentQuery = query;

                  // Clear previous timeout
                  if (searchTimeout) {
                    clearTimeout(searchTimeout);
                  }

                  // Debounce search requests
                  searchTimeout = setTimeout(() => {
                    if (query.length >= 1) {
                      this.searchGitFiles(query);
                    } else {
                      this.hideGitSearchResults();
                    }
                  }, 300);
                });

                // Handle focus and blur events
                searchInput.addEventListener("focus", () => {
                  if (currentQuery.length >= 1) {
                    resultsDiv.style.display = "block";
                  }
                });

                searchInput.addEventListener("blur", (e) => {
                  // Delay hiding to allow clicking on results
                  setTimeout(() => {
                    if (!e.relatedTarget || !resultsDiv.contains(e.relatedTarget)) {
                      this.hideGitSearchResults();
                    }
                  }, 150);
                });

                // Keyboard navigation
                searchInput.addEventListener("keydown", (e) => {
                  this.handleGitFileKeyboardNavigation(e);
                });
              }

              async searchFiles(side, query) {
                try {
                  if (!window.authManager) {
                    console.warn("AuthManager not ready for file search");
                    return;
                  }

                  if (!this.selectedRepository) {
                    console.warn("No repository selected for file search");
                    this.showSearchError(side, "Please select a repository first.");
                    return;
                  }

                  const response = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/files/search?query=${encodeURIComponent(query)}&limit=20`
                  );

                  if (response.success) {
                    this.displaySearchResults(side, response.data.files, query);
                  } else {
                    console.error("File search failed:", response.message);
                    this.showSearchError(side, "Search failed. Please try again.");
                  }
                } catch (error) {
                  console.error("Error searching files:", error);
                  this.showSearchError(side, "Search error. Check your connection.");
                }
              }

              displaySearchResults(side, files, query) {
                const resultsDiv = document.getElementById(`${side}FileResults`);
                const listGroup = resultsDiv.querySelector(".list-group");
                const searchInput = document.getElementById(`${side}FileSearch`);

                // Filter out files with repo_ prefix
                const filteredFiles = files.filter((file) => !file.path.startsWith("repo_"));

                // Clear previous results
                listGroup.innerHTML = "";

                if (filteredFiles.length === 0) {
                  listGroup.innerHTML = `
                    <div class="list-group-item text-muted">
                      <i class="fas fa-search"></i> No files found matching "${query}"
                    </div>
                  `;
                } else {
                  filteredFiles.forEach((file, index) => {
                    const item = document.createElement("div");
                    item.className = "list-group-item list-group-item-action";
                    item.dataset.index = index;
                    item.dataset.filePath = file.path;

                    item.innerHTML = `
                      <div class="file-item-name">${this.highlightMatch(file.name, query)}</div>
                      <div class="file-item-path">
                        ${file.directory ? `<span class="file-item-directory">${file.directory}/</span>` : ""}
                        ${this.highlightMatch(file.path, query)}
                      </div>
                    `;

                    // Click handler for file selection
                    item.addEventListener("click", () => {
                      this.selectFile(side, file);
                    });

                    listGroup.appendChild(item);
                  });
                }

                resultsDiv.style.display = "block";
              }

              highlightMatch(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
                return text.replace(regex, "<mark>$1</mark>");
              }

              selectFile(side, file) {
                const searchInput = document.getElementById(`${side}FileSearch`);
                const selectedDiv = document.getElementById(`${side}SelectedFile`);
                const selectedPath = selectedDiv.querySelector(".selected-path");

                // Update input and display
                searchInput.value = file.name;
                selectedPath.textContent = file.path;
                selectedDiv.style.display = "block";

                // Store selected file
                if (side === "left") {
                  this.selectedLeftFile = file;
                } else {
                  this.selectedRightFile = file;
                }

                // Call the callback if it exists
                if (searchInput.onSelectCallback) {
                  searchInput.onSelectCallback(file);
                }

                // Hide search results
                this.hideSearchResults(side);

                // Update compare button and load file history
                this.updateCompareButton();
                this.loadFileHistory(side);

                console.log(`Selected ${side} file:`, file.path);
              }

              hideSearchResults(side) {
                const resultsDiv = document.getElementById(`${side}FileResults`);
                resultsDiv.style.display = "none";
              }

              // Git File Search Methods
              async searchGitFiles(query) {
                try {
                  if (!this.selectedRepository) {
                    console.warn("No repository selected for Git file search");
                    this.showGitSearchError("Please select a repository first.");
                    return;
                  }

                  // Use new unified git-repositories search endpoint
                  const result = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/files/search?query=${encodeURIComponent(query)}`
                  );

                  if (result.success && result.data && result.data.files) {
                    // Filter out files with repo_ prefix and convert to same format as local gitFiles
                    const formattedFiles = result.data.files
                      .filter((fileInfo) => !fileInfo.path.startsWith("repo_"))
                      .map((fileInfo) => ({
                        path: fileInfo.path,
                        name: fileInfo.name,
                        directory: fileInfo.directory || "",
                      }));
                    this.displayGitSearchResults(formattedFiles, query);
                  } else {
                    this.showGitSearchError("No files found");
                  }
                } catch (error) {
                  console.error("Error searching Git files:", error);
                  this.showGitSearchError("Error searching files");
                }
              }

              displayGitSearchResults(files, query) {
                const resultsDiv = document.getElementById("gitFileResults");
                const listGroup = resultsDiv.querySelector(".list-group");

                // Clear previous results
                listGroup.innerHTML = "";

                if (files.length === 0) {
                  listGroup.innerHTML = `
                    <div class="list-group-item text-muted">
                      <i class="fas fa-search"></i> No files found matching "${query}"
                    </div>
                  `;
                } else {
                  files.forEach((file, index) => {
                    const item = document.createElement("div");
                    item.className = "list-group-item list-group-item-action";
                    item.dataset.index = index;
                    item.dataset.filePath = file.path;

                    item.innerHTML = `
                      <div class="file-item-name">${this.highlightMatch(file.name, query)}</div>
                      <div class="file-item-path">
                        ${file.directory ? `<span class="file-item-directory">${file.directory}/</span>` : ""}
                        ${this.highlightMatch(file.path, query)}
                      </div>
                    `;

                    // Click handler for file selection
                    item.addEventListener("click", () => {
                      this.selectGitFile(file);
                    });

                    listGroup.appendChild(item);
                  });
                }

                resultsDiv.style.display = "block";
              }

              selectGitFile(file) {
                const searchInput = document.getElementById("gitFileSearch");
                const selectedDiv = document.getElementById("gitSelectedFile");
                const selectedPath = selectedDiv.querySelector(".selected-path");

                // Update input and display
                searchInput.value = file.name;
                selectedPath.textContent = file.path;
                selectedDiv.style.display = "block";

                // Store selected file
                this.selectedGitFile = file;

                // Hide search results
                this.hideGitSearchResults();

                // Update compare button and load Git file history
                this.updateCompareButton();
                this.loadGitFileHistory();

                console.log("Selected Git file:", file.path);
              }

              hideGitSearchResults() {
                const resultsDiv = document.getElementById("gitFileResults");
                resultsDiv.style.display = "none";
              }

              showGitSearchError(message) {
                const resultsDiv = document.getElementById("gitFileResults");
                const listGroup = resultsDiv.querySelector(".list-group");

                listGroup.innerHTML = `
                  <div class="list-group-item text-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                  </div>
                `;

                resultsDiv.style.display = "block";
              }

              handleGitFileKeyboardNavigation(e) {
                const resultsDiv = document.getElementById("gitFileResults");
                const items = resultsDiv.querySelectorAll(".list-group-item-action");

                if (items.length === 0) return;

                let currentIndex = -1;
                const activeItem = resultsDiv.querySelector(".list-group-item.active");
                if (activeItem) {
                  currentIndex = parseInt(activeItem.dataset.index);
                }

                switch (e.key) {
                  case "ArrowDown":
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    this.highlightGitResultItem(resultsDiv, currentIndex);
                    break;

                  case "ArrowUp":
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, 0);
                    this.highlightGitResultItem(resultsDiv, currentIndex);
                    break;

                  case "Enter":
                    e.preventDefault();
                    if (currentIndex >= 0 && items[currentIndex]) {
                      items[currentIndex].click();
                    }
                    break;

                  case "Escape":
                    this.hideGitSearchResults();
                    break;
                }
              }

              highlightGitResultItem(resultsDiv, index) {
                const items = resultsDiv.querySelectorAll(".list-group-item-action");
                items.forEach((item) => item.classList.remove("active"));

                if (items[index]) {
                  items[index].classList.add("active");
                }
              }

              showSearchError(side, message) {
                const resultsDiv = document.getElementById(`${side}FileResults`);
                const listGroup = resultsDiv.querySelector(".list-group");

                listGroup.innerHTML = `
                  <div class="list-group-item text-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                  </div>
                `;

                resultsDiv.style.display = "block";
              }

              handleKeyboardNavigation(side, e) {
                const resultsDiv = document.getElementById(`${side}FileResults`);
                const items = resultsDiv.querySelectorAll(".list-group-item-action");

                if (items.length === 0) return;

                let currentIndex = -1;
                const activeItem = resultsDiv.querySelector(".list-group-item.active");
                if (activeItem) {
                  currentIndex = parseInt(activeItem.dataset.index);
                }

                switch (e.key) {
                  case "ArrowDown":
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    this.highlightResultItem(resultsDiv, currentIndex);
                    break;

                  case "ArrowUp":
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, 0);
                    this.highlightResultItem(resultsDiv, currentIndex);
                    break;

                  case "Enter":
                    e.preventDefault();
                    if (currentIndex >= 0 && items[currentIndex]) {
                      items[currentIndex].click();
                    }
                    break;

                  case "Escape":
                    this.hideSearchResults(side);
                    break;
                }
              }

              highlightResultItem(resultsDiv, index) {
                const items = resultsDiv.querySelectorAll(".list-group-item-action");
                items.forEach((item) => item.classList.remove("active"));

                if (items[index]) {
                  items[index].classList.add("active");
                }
              }

              // History File Search Functionality
              initializeHistoryFileSearch() {
                const searchInput = document.getElementById("historyFileSearch");
                const resultsDiv = document.getElementById("historyFileResults");

                if (!searchInput) {
                  console.error("History file search input element not found");
                  return;
                }

                let searchTimeout;
                let currentQuery = "";

                // Search input handler
                searchInput.addEventListener("input", (e) => {
                  const query = e.target.value.trim();
                  currentQuery = query;

                  // Clear previous timeout
                  if (searchTimeout) {
                    clearTimeout(searchTimeout);
                  }

                  // Debounce search requests
                  searchTimeout = setTimeout(() => {
                    if (query.length >= 1) {
                      this.searchHistoryFiles(query);
                    } else {
                      resultsDiv.style.display = "none";
                    }
                  }, 300);
                });

                // Handle focus and blur events
                searchInput.addEventListener("focus", () => {
                  if (currentQuery.length >= 1) {
                    resultsDiv.style.display = "block";
                  }
                });

                searchInput.addEventListener("blur", (e) => {
                  // Delay hiding to allow clicking on results
                  setTimeout(() => {
                    if (!e.relatedTarget || !resultsDiv.contains(e.relatedTarget)) {
                      this.hideHistorySearchResults();
                    }
                  }, 150);
                });

                // Keyboard navigation
                searchInput.addEventListener("keydown", (e) => {
                  this.handleHistoryFileKeyboardNavigation(e);
                });
              }

              async searchHistoryFiles(query) {
                try {
                  if (!this.selectedRepository) {
                    console.warn("No repository selected for history file search");
                    this.showHistorySearchError("Please select a repository first.");
                    return;
                  }

                  // Use new unified git-repositories search endpoint
                  const result = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/files/search?query=${encodeURIComponent(query)}`
                  );

                  if (result.success && result.data && result.data.files) {
                    // Filter out files with repo_ prefix and convert to same format as other modes
                    const formattedFiles = result.data.files
                      .filter((fileInfo) => !fileInfo.path.startsWith("repo_"))
                      .map((fileInfo) => ({
                        path: fileInfo.path,
                        name: fileInfo.name,
                        directory: fileInfo.directory || "",
                      }));
                    this.displayHistorySearchResults(formattedFiles, query);
                  } else {
                    this.showHistorySearchError("No files found");
                  }
                } catch (error) {
                  console.error("Error searching history files:", error);
                  this.showHistorySearchError("Error searching files");
                }
              }

              displayHistorySearchResults(files, query) {
                const resultsDiv = document.getElementById("historyFileResults");
                const listGroup = resultsDiv.querySelector(".list-group");

                // Clear previous results
                listGroup.innerHTML = "";

                if (files.length === 0) {
                  listGroup.innerHTML = `
                    <div class="list-group-item text-muted">
                      <i class="fas fa-search"></i> No files found matching "${query}"
                    </div>
                  `;
                } else {
                  files.forEach((file, index) => {
                    const item = document.createElement("div");
                    item.className = "list-group-item list-group-item-action";
                    item.dataset.index = index;
                    item.innerHTML = `
                      <div class="file-item-name">${this.highlightMatch(file.name, query)}</div>
                      <div class="file-item-path">${this.highlightMatch(file.path, query)}</div>
                      ${file.directory ? `<span class="file-item-directory">${file.directory}</span>` : ""}
                    `;

                    item.addEventListener("click", () => this.selectHistoryFile(file));
                    listGroup.appendChild(item);
                  });
                }

                resultsDiv.style.display = "block";
              }

              selectHistoryFile(file) {
                const searchInput = document.getElementById("historyFileSearch");

                // Update input
                searchInput.value = file.name;

                // Store selected file
                this.selectedHistoryFile = file;

                // Hide search results
                this.hideHistorySearchResults();

                // Update show history button
                this.updateShowHistoryButton();

                console.log("Selected history file:", file.path);
              }

              hideHistorySearchResults() {
                const resultsDiv = document.getElementById("historyFileResults");
                resultsDiv.style.display = "none";
              }

              showHistorySearchError(message) {
                const resultsDiv = document.getElementById("historyFileResults");
                const listGroup = resultsDiv.querySelector(".list-group");

                listGroup.innerHTML = `
                  <div class="list-group-item text-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                  </div>
                `;

                resultsDiv.style.display = "block";
              }

              handleHistoryFileKeyboardNavigation(e) {
                const resultsDiv = document.getElementById("historyFileResults");
                const items = resultsDiv.querySelectorAll(".list-group-item-action");

                if (items.length === 0) return;

                let currentIndex = -1;
                const activeItem = resultsDiv.querySelector(".list-group-item.active");
                if (activeItem) {
                  currentIndex = parseInt(activeItem.dataset.index);
                }

                switch (e.key) {
                  case "ArrowDown":
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    this.highlightHistoryResultItem(resultsDiv, currentIndex);
                    break;

                  case "ArrowUp":
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, 0);
                    this.highlightHistoryResultItem(resultsDiv, currentIndex);
                    break;

                  case "Enter":
                    e.preventDefault();
                    if (currentIndex >= 0 && items[currentIndex]) {
                      items[currentIndex].click();
                    }
                    break;

                  case "Escape":
                    this.hideHistorySearchResults();
                    break;
                }
              }

              highlightHistoryResultItem(resultsDiv, index) {
                const items = resultsDiv.querySelectorAll(".list-group-item-action");
                items.forEach((item) => item.classList.remove("active"));

                if (items[index]) {
                  items[index].classList.add("active");
                }
              }

              async handleModeChange(mode) {
                console.log("Mode changed to:", mode);

                const fileMode = document.getElementById("fileComparisonMode");
                const gitMode = document.getElementById("gitComparisonMode");
                const historyMode = document.getElementById("fileHistoryMode");
                const sharedControls = document.getElementById("sharedCompareControls");

                if (mode === "files") {
                  fileMode.style.display = "block";
                  gitMode.style.display = "none";
                  historyMode.style.display = "none";
                  sharedControls.style.display = "block";
                  this.updateFileHistoryVisibility();
                } else if (mode === "git") {
                  fileMode.style.display = "none";
                  gitMode.style.display = "block";
                  historyMode.style.display = "none";
                  sharedControls.style.display = "block";
                  this.updateGitFileHistoryVisibility();

                  // Ensure commits are loaded when switching to Git mode
                  if (this.gitData.commits.length === 0) {
                    console.log("No commits loaded, checking repository state...");
                    await this.checkRepositoryState();
                  } else {
                    // Refresh the commit dropdowns to make sure they're populated
                    this.populateGitCommits();
                  }
                } else if (mode === "history") {
                  fileMode.style.display = "none";
                  gitMode.style.display = "none";
                  historyMode.style.display = "block";
                  sharedControls.style.display = "none";

                  // Initialize history file search immediately when switching to history mode
                  if (!this.historyFileSearchInitialized) {
                    this.initializeHistoryFileSearch();
                    this.historyFileSearchInitialized = true;
                  }

                  // Load branches and commits for history mode
                  this.loadHistoryBranches();

                  // Add small delay to ensure DOM is ready
                  setTimeout(() => {
                    this.initializeHistoryMode();
                  }, 100);
                }
                this.updateCompareButton();
              }

              async handleRefresh() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                if (mode === "files") {
                  this.loadFiles();
                } else {
                  await this.checkRepositoryState();
                }
              }

              handleCompare() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                if (mode === "files") {
                  this.compareFiles();
                } else if (mode === "git") {
                  this.compareGitCommits();
                } else if (mode === "history") {
                  this.compareSelectedHistoryRows();
                }
              }

              async compareSelectedHistoryRows() {
                if (this.selectedHistoryRows.length !== 2) {
                  this.showError("Please select exactly two commits to compare");
                  return;
                }

                const fileName = document.getElementById("historyFileName").textContent;
                if (!fileName) {
                  this.showError("No file selected for comparison");
                  return;
                }

                // Sort by chronological order (older first, newer second)
                const sortedRows = this.selectedHistoryRows.sort((a, b) => {
                  // Assume the order in the timeline is chronological (newer first)
                  const aElement = a.element;
                  const bElement = b.element;
                  const aIndex = Array.from(aElement.parentNode.children).indexOf(aElement);
                  const bIndex = Array.from(bElement.parentNode.children).indexOf(bElement);
                  return bIndex - aIndex; // Reverse order for chronological
                });

                const olderCommit = sortedRows[0];
                const newerCommit = sortedRows[1];

                this.showLoading();

                try {
                  const diffData = await window.authManager.apiRequest("/api/git/diff", {
                    method: "POST",
                    body: JSON.stringify({
                      commit1: olderCommit.hash,
                      commit2: newerCommit.hash,
                      file_path: fileName,
                    }),
                  });

                  const formattedDiff = this.formatGitDiff(
                    diffData,
                    fileName,
                    olderCommit.shortHash,
                    newerCommit.shortHash
                  );

                  this.displayComparison(
                    formattedDiff,
                    `Compare ${olderCommit.shortHash} vs ${newerCommit.shortHash}: ${fileName}`
                  );

                  document.getElementById("comparisonSection").scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                } catch (error) {
                  this.showError(`Error comparing commits: ${error.message}`);
                }
              }

              async populateGitBranches() {
                try {
                  const data = await window.authManager.apiRequest("/api/git/branches");
                  console.log("Git branches data:", data);

                  // Handle different response formats
                  let branches = [];
                  if (Array.isArray(data)) {
                    // Direct array of strings
                    branches = data;
                  } else if (data.branches && Array.isArray(data.branches)) {
                    // Array of branch objects with name property
                    branches = data.branches.map((branch) =>
                      typeof branch === "string" ? branch : branch.name
                    );
                  } else {
                    // Fallback to empty array
                    branches = [];
                  }

                  this.gitData.branches = branches;

                  const branchSelect = document.getElementById("gitBranchSelect");

                  branchSelect.innerHTML = '<option value="">Select branch...</option>';
                  branches.forEach((branch) => {
                    const option = new Option(branch, branch);
                    branchSelect.add(option);
                  });

                  // Auto-select the main branch if available
                  if (branches.includes("main")) {
                    branchSelect.value = "main";
                    await this.loadCommitsForBranch("main");
                  } else if (branches.length > 0) {
                    branchSelect.value = branches[0];
                    await this.loadCommitsForBranch(branches[0]);
                  }
                } catch (error) {
                  console.error("Error loading Git branches:", error);
                }
              }

              populateGitCommits() {
                const leftSelect = document.getElementById("leftCommitSelect");
                const rightSelect = document.getElementById("rightCommitSelect");

                if (!leftSelect || !rightSelect) {
                  console.error("Commit select elements not found");
                  return;
                }

                leftSelect.innerHTML = '<option value="">Select commit...</option>';
                rightSelect.innerHTML = '<option value="">Select commit...</option>';

                if (this.gitData.commits && this.gitData.commits.length > 0) {
                  this.gitData.commits.forEach((commit) => {
                    const shortHash = commit.hash.substring(0, 8);
                    const shortMessage =
                      commit.message.length > 50
                        ? commit.message.substring(0, 50) + "..."
                        : commit.message;
                    const optionText = `${shortHash} - ${shortMessage}`;

                    const option1 = new Option(optionText, commit.hash);
                    const option2 = new Option(optionText, commit.hash);
                    option1.title = commit.message;
                    option2.title = commit.message;

                    leftSelect.add(option1);
                    rightSelect.add(option2);
                  });

                  // Auto-select first two commits for comparison
                  if (this.gitData.commits.length >= 2) {
                    leftSelect.value = this.gitData.commits[1].hash; // Older commit
                    rightSelect.value = this.gitData.commits[0].hash; // Newer commit

                    // Populate files after selecting commits
                    this.populateGitFiles();
                  }
                }

                this.updateCompareButton();
              }

              async loadCommitsForBranch(branch) {
                try {
                  this.gitData.commits = await window.authManager.apiRequest(
                    `/api/git/commits/${branch}`
                  );
                  this.populateGitCommits();
                } catch (error) {
                  console.error("Error loading commits for branch:", error);
                }
              }

              async populateGitFiles() {
                try {
                  const leftCommit = document.getElementById("leftCommitSelect").value;
                  const rightCommit = document.getElementById("rightCommitSelect").value;

                  if (!leftCommit && !rightCommit) {
                    this.gitFiles = [];
                    return;
                  }

                  const commitHash = rightCommit || leftCommit || "HEAD";

                  const files = await window.authManager.apiRequest(`/api/git/files/${commitHash}`);
                  // Store files for search functionality instead of populating select
                  this.gitFiles = files.map((filePath) => ({
                    path: filePath,
                    name: filePath.split("/").pop(),
                    directory: filePath.includes("/")
                      ? filePath.substring(0, filePath.lastIndexOf("/"))
                      : "",
                  }));

                  // Initialize Git file search if not already done
                  if (!this.gitFileSearchInitialized) {
                    this.initializeGitFileSearch();
                    this.gitFileSearchInitialized = true;
                  }
                } catch (error) {
                  console.error("Error loading Git files:", error);
                  this.gitFiles = [];
                }
              }

              loadFontSizePreference() {
                const savedSize = localStorage.getItem("diff_font_size") || "12";
                document.getElementById("fontSizeSelect").value = savedSize;
                this.changeFontSize(savedSize);
              }

              changeFontSize(size) {
                const fontSize = parseInt(size);
                const lineHeight = fontSize <= 11 ? 1.0 : fontSize <= 12 ? 1.1 : 1.2;

                // Update CSS custom properties
                document.documentElement.style.setProperty("--diff-font-size", fontSize + "px");
                document.documentElement.style.setProperty("--diff-line-height", lineHeight);

                // Save preference
                localStorage.setItem("diff_font_size", size);

                console.log(`Font size changed to ${fontSize}px with line-height ${lineHeight}`);
              }

              async loadFiles() {
                try {
                  const data = await window.authManager.apiRequest("/api/files/list");

                  this.files = data.files || data;
                  this.populateFileSelects();
                  console.log("Files loaded:", this.files.length);
                } catch (error) {
                  this.showError("Error loading files: " + error.message);
                }
              }

              async loadFileHistory(side) {
                const historyContent = document.getElementById(
                  side === "left" ? "leftFileHistoryContent" : "rightFileHistoryContent"
                );
                const selectedFile =
                  side === "left" ? this.selectedLeftFile : this.selectedRightFile;

                if (!selectedFile || !selectedFile.path) {
                  historyContent.innerHTML =
                    '<p class="text-muted"><i>Select a file to view its history</i></p>';
                  this.updateFileHistoryVisibility();
                  return;
                }

                // Show loading state
                historyContent.innerHTML =
                  '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';

                try {
                  const data = await window.authManager.apiRequest(
                    `/api/git/file-history/${encodeURIComponent(selectedFile.path)}`
                  );

                  const commit = data.last_commit;
                  const commitDate = new Date(commit.date);
                  const timeAgo = this.getTimeAgo(commitDate);

                  historyContent.innerHTML = `
                    <div class="file-history-info">
                      <p><strong>Last Modified:</strong> ${timeAgo}</p>
                      <p><strong>Date:</strong> ${commitDate.toLocaleString()}</p>
                      <p><strong>Author:</strong> ${typeof commit.author === "object" ? commit.author.name : commit.author}</p>
                      <p><strong>Commit:</strong> <code>${commit.short_hash}</code></p>
                      <p><strong>Message:</strong> ${commit.message}</p>
                      ${!data.file_exists ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> File was deleted in this commit</p>' : ""}
                    </div>
                  `;
                } catch (error) {
                  historyContent.innerHTML = `<p class="text-danger">Error loading history: ${error.message}</p>`;
                }

                this.updateFileHistoryVisibility();
              }

              updateFileHistoryVisibility() {
                const leftFile = this.selectedLeftFile ? this.selectedLeftFile.path : "";
                const rightFile = this.selectedRightFile ? this.selectedRightFile.path : "";
                const historySection = document.getElementById("fileHistorySection");

                // Reset headers for file mode
                const leftHeader = document.querySelector("#leftFileHistory h6");
                const rightHeader = document.querySelector("#rightFileHistory h6");
                leftHeader.textContent = "Source File";
                rightHeader.textContent = "Target File";

                // Show history section if at least one file is selected
                if (leftFile || rightFile) {
                  historySection.style.display = "block";
                } else {
                  historySection.style.display = "none";
                }
              }

              async loadGitFileHistory() {
                const leftCommit = document.getElementById("leftCommitSelect").value;
                const rightCommit = document.getElementById("rightCommitSelect").value;
                const gitFile = this.selectedGitFile ? this.selectedGitFile.path : null;

                // Update the section headers for Git mode
                const leftHeader = document.querySelector("#leftFileHistory h6");
                const rightHeader = document.querySelector("#rightFileHistory h6");
                leftHeader.textContent = leftCommit
                  ? `Source Commit (${leftCommit.substring(0, 8)})`
                  : "Source Commit";
                rightHeader.textContent = rightCommit
                  ? `Target Commit (${rightCommit.substring(0, 8)})`
                  : "Target Commit";

                // Clear both sides first
                this.clearFileHistory("left");
                this.clearFileHistory("right");

                if (!gitFile) {
                  this.updateGitFileHistoryVisibility();
                  return;
                }

                // Load history for both commits if they're selected
                if (leftCommit) {
                  await this.loadGitCommitFileHistory("left", leftCommit, gitFile);
                }
                if (rightCommit) {
                  await this.loadGitCommitFileHistory("right", rightCommit, gitFile);
                }

                this.updateGitFileHistoryVisibility();
              }

              async loadGitCommitFileHistory(side, commitHash, filePath) {
                const historyContent = document.getElementById(
                  side === "left" ? "leftFileHistoryContent" : "rightFileHistoryContent"
                );

                // Show loading state
                historyContent.innerHTML =
                  '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';

                try {
                  const data = await window.authManager.apiRequest(
                    `/api/git/file-history/${encodeURIComponent(filePath)}`
                  );

                  const commit = data.last_commit;
                  const commitDate = new Date(commit.date);
                  const timeAgo = this.getTimeAgo(commitDate);

                  // Check if the selected commit is the same as the last commit that modified the file
                  // Compare both full hash and short hash, handling both directions
                  const selectedShort = commitHash.substring(0, 8);
                  const lastCommitShort = commit.short_hash || commit.hash.substring(0, 8);
                  const isSelectedCommit =
                    commitHash === commit.hash ||
                    selectedShort === lastCommitShort ||
                    commitHash === commit.short_hash ||
                    (commit.hash && commit.hash.startsWith(commitHash));

                  const commitLabel = isSelectedCommit ? "Selected Commit" : "Last Modified";

                  historyContent.innerHTML = `
                    <div class="file-history-info">
                      <p><strong>${commitLabel}:</strong> ${timeAgo}</p>
                      <p><strong>Date:</strong> ${commitDate.toLocaleString()}</p>
                      <p><strong>Author:</strong> ${typeof commit.author === "object" ? commit.author.name : commit.author}</p>
                      <p><strong>Commit:</strong> <code>${commit.short_hash}</code></p>
                      <p><strong>Message:</strong> ${commit.message}</p>
                      ${!data.file_exists ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> File was deleted in this commit</p>' : ""}
                      ${!isSelectedCommit ? `<p class="text-info"><i class="fas fa-info-circle"></i> Note: File unchanged in selected commit (${selectedShort}). Showing last modification.</p>` : ""}
                    </div>
                  `;
                } catch (error) {
                  historyContent.innerHTML = `<p class="text-danger">Error loading history: ${error.message}</p>`;
                }
              }

              clearFileHistory(side) {
                const historyContent = document.getElementById(
                  side === "left" ? "leftFileHistoryContent" : "rightFileHistoryContent"
                );
                historyContent.innerHTML =
                  '<p class="text-muted"><i>Select a file to view its history</i></p>';
              }

              closeFileHistory() {
                const historySection = document.getElementById("fileHistorySection");
                historySection.style.display = "none";

                // Clear both sides
                this.clearFileHistory("left");
                this.clearFileHistory("right");
              }

              closeFileHistoryDisplay() {
                const fileHistoryDisplay = document.getElementById("fileHistoryDisplay");
                fileHistoryDisplay.style.display = "none";

                // Clear the selected rows if any
                this.selectedHistoryRows = [];
              }

              toggleHistoryRowSelection(commitHash, event) {
                event.stopPropagation();

                const timelineItem = document.querySelector(`[data-commit-hash="${commitHash}"]`);
                if (!timelineItem) return;

                const index = this.selectedHistoryRows.findIndex((row) => row.hash === commitHash);

                if (index === -1) {
                  // Select the row (max 2 selections)
                  if (this.selectedHistoryRows.length < 2) {
                    this.selectedHistoryRows.push({
                      hash: commitHash,
                      shortHash: timelineItem.dataset.commitShort,
                      element: timelineItem,
                    });
                    timelineItem.classList.add("timeline-selected");
                  }
                } else {
                  // Deselect the row
                  this.selectedHistoryRows.splice(index, 1);
                  timelineItem.classList.remove("timeline-selected");
                }

                this.updateCompareButton(); // Update the history compare button as well
              }

              async downloadHistoryFile(commitHash, shortHash) {
                const fileName = document.getElementById("historyFileName").textContent;
                if (!fileName) {
                  this.showError("No file selected for download");
                  return;
                }

                try {
                  const response = await window.authManager.apiRequest(
                    `/api/git/files/${encodeURIComponent(commitHash)}?file_path=${encodeURIComponent(fileName)}`
                  );

                  if (!response || !response.content) {
                    this.showError("File content not found");
                    return;
                  }

                  // Create and download the file
                  const blob = new Blob([response.content], { type: "text/plain" });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `${fileName.split("/").pop()}_${shortHash}`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                } catch (error) {
                  this.showError(`Error downloading file: ${error.message}`);
                }
              }

              closeComparisonResults() {
                const comparisonSection = document.getElementById("comparisonSection");
                comparisonSection.style.display = "none";
              }

              updateGitFileHistoryVisibility() {
                const gitFile = this.selectedGitFile ? this.selectedGitFile.path : null;
                const historySection = document.getElementById("fileHistorySection");

                // Show history section if a Git file is selected
                if (gitFile) {
                  historySection.style.display = "block";
                } else {
                  historySection.style.display = "none";
                }
              }

              getTimeAgo(date) {
                // Return exact date instead of relative time
                const options = {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: false,
                };
                return date.toLocaleString("en-US", options);
              }

              // File History Mode Methods
              async initializeHistoryMode() {
                console.log("Initializing File History mode...");

                // Wait for authManager to be ready if it's not already
                if (!window.authManager) {
                  console.log("AuthManager not ready, waiting...");
                  // Wait up to 3 seconds for authManager
                  for (let i = 0; i < 30; i++) {
                    if (window.authManager) {
                      console.log("AuthManager is now ready");
                      break;
                    }
                    await new Promise((resolve) => setTimeout(resolve, 100));
                  }

                  if (!window.authManager) {
                    console.error("AuthManager still not ready after waiting");
                    return;
                  }
                }

                // Load branches for history mode
                await this.loadHistoryBranches();
                // Note: loadHistoryBranches now handles loading commits for the selected branch

                console.log("File History mode initialization complete");
              }

              async loadHistoryBranches() {
                console.log("Loading branches for history mode...");
                try {
                  const data = await window.authManager.apiRequest("/api/git/branches");
                  console.log("History branches data:", data);

                  const branches = this.parseBranchesData(data);
                  this.populateHistoryBranchSelect(branches);
                } catch (error) {
                  console.error("Error loading branches for history mode:", error);
                  console.error("Error stack:", error.stack);
                  this.addDefaultHistoryBranch();
                }
              }

              parseBranchesData(data) {
                let branches = [];
                if (Array.isArray(data)) {
                  // Direct array of strings
                  branches = data;
                } else if (data && data.branches && Array.isArray(data.branches)) {
                  // Array of branch objects with name property
                  branches = data.branches.map((branch) =>
                    typeof branch === "string" ? branch : branch.name
                  );
                } else if (Array.isArray(data)) {
                  // Sometimes the response itself is the array
                  branches = data;
                } else {
                  // Fallback to empty array
                  console.warn("Unexpected branches data format:", data);
                  branches = [];
                }
                console.log("Parsed branches:", branches);
                return branches;
              }

              populateHistoryBranchSelect(branches) {
                const branchSelect = document.getElementById("historyBranchSelect");
                if (!branchSelect) {
                  console.error("History branch select element not found");
                  return;
                }

                // Clear existing options
                branchSelect.innerHTML = "";

                // Add branch options
                if (branches.length > 0) {
                  branches.forEach((branch) => {
                    const option = new Option(branch, branch);
                    branchSelect.add(option);
                  });

                  // Set default branch value explicitly
                  if (branches.includes("main")) {
                    branchSelect.value = "main";
                    console.log("Set branch to main");
                  } else if (branches.includes("master")) {
                    branchSelect.value = "master";
                    console.log("Set branch to master");
                  } else {
                    branchSelect.value = branches[0];
                    console.log("Set branch to:", branches[0]);
                  }

                  // Load commits for the selected branch
                  this.loadHistoryCommitsForBranch(branchSelect.value);
                } else {
                  this.addDefaultHistoryBranch();
                }
              }

              addDefaultHistoryBranch() {
                const branchSelect = document.getElementById("historyBranchSelect");
                if (branchSelect) {
                  console.warn("No branches found, adding default main option");
                  branchSelect.innerHTML = "";
                  const option = new Option("main", "main");
                  branchSelect.add(option);
                  branchSelect.value = "main";
                }
              }

              async loadHistoryCommitsForBranch(branch) {
                console.log("Loading commits for branch:", branch);
                try {
                  const commits = await window.authManager.apiRequest(`/api/git/commits/${branch}`);
                  console.log("Loaded commits for history mode:", commits.length);
                  this.populateHistoryCommitSelect(commits);
                } catch (error) {
                  console.error("Error loading commits for branch:", branch, error);
                  console.error("Error stack:", error.stack);
                  this.addDefaultHistoryCommit();
                }
              }

              populateHistoryCommitSelect(commits) {
                const commitSelect = document.getElementById("historyCommitSelect");
                if (!commitSelect) {
                  console.error("History commit select element not found");
                  return;
                }

                // Clear existing options
                commitSelect.innerHTML = '<option value="">Select commit...</option>';

                // Add commit options using the same format as Git Commits mode
                let latestCommitHash = null;
                commits.forEach((commit, index) => {
                  // Create short hash the same way as Git Commits mode
                  const shortHash = commit.hash.substring(0, 8);
                  const shortMessage =
                    commit.message.length > 50
                      ? commit.message.substring(0, 50) + "..."
                      : commit.message;
                  const optionText = `${shortHash} - ${shortMessage}`;

                  const option = new Option(optionText, commit.hash);
                  option.title = commit.message; // Add full message as tooltip
                  commitSelect.add(option);

                  // Store the latest commit hash for selection
                  if (index === 0) {
                    latestCommitHash = commit.hash;
                  }
                });

                // Select the latest commit explicitly
                if (latestCommitHash) {
                  commitSelect.value = latestCommitHash;
                  console.log("Set commit to:", latestCommitHash);
                }
              }

              addDefaultHistoryCommit() {
                const commitSelect = document.getElementById("historyCommitSelect");
                if (commitSelect) {
                  console.warn("No commits found, adding placeholder option");
                  commitSelect.innerHTML = '<option value="">No commits available</option>';
                }
              }

              updateShowHistoryButton() {
                const branch = document.getElementById("historyBranchSelect").value;
                const commit = document.getElementById("historyCommitSelect").value;
                const file = this.selectedHistoryFile ? this.selectedHistoryFile.path : null;
                const button = document.getElementById("showHistoryBtn");

                button.disabled = !(branch && commit && file);
              }

              async showFileHistory() {
                const branch = document.getElementById("historyBranchSelect").value;
                const commit = document.getElementById("historyCommitSelect").value;
                const filePath = this.selectedHistoryFile ? this.selectedHistoryFile.path : null;

                if (!branch || !commit || !filePath) return;

                const historyDisplay = document.getElementById("fileHistoryDisplay");
                const historyContent = document.getElementById("historyContent");
                const fileName = document.getElementById("historyFileName");

                fileName.textContent = filePath;
                historyContent.innerHTML =
                  '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading file history...</p>';
                historyDisplay.style.display = "block";

                try {
                  // Try authManager first
                  if (window.authManager) {
                    console.log("Using authManager for file history...");
                    const response = await window.authManager.apiRequest(
                      `/api/git/file-complete-history/${encodeURIComponent(filePath)}?from_commit=${encodeURIComponent(commit)}`
                    );

                    if (response && response.success) {
                      // Pass the selected commit hash to the render function
                      this.renderFileHistory(response.data, commit);
                      return; // Success, exit early
                    }
                  }

                  // Fallback to direct API request using the correct API endpoint
                  console.log("Falling back to direct API request for file history...");
                  const data = await window.authManager.apiRequest(
                    `/api/git/file-complete-history/${encodeURIComponent(filePath)}?from_commit=${encodeURIComponent(commit)}`
                  );
                  this.renderFileHistory(data, commit);
                } catch (error) {
                  console.error("Error loading file history:", error);
                  historyContent.innerHTML = `<p class="text-danger">Error loading file history: ${error.message}</p>`;
                }
              }

              renderFileHistory(history, selectedCommitHash) {
                const historyContent = document.getElementById("historyContent");

                if (!history.commits || history.commits.length === 0) {
                  historyContent.innerHTML =
                    '<p class="text-muted">No history found for this file.</p>';
                  return;
                }

                let historyHtml = `
                  <div class="timeline">
                    <div class="timeline-header">
                      <p class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> 
                        Showing ${history.commits.length} commit${history.commits.length > 1 ? "s" : ""} 
                        from <strong>${history.from_commit.substring(0, 8)}</strong> backwards to file creation
                      </p>
                    </div>
                `;

                history.commits.forEach((commit, index) => {
                  const commitDate = new Date(commit.date);
                  const timeAgo = this.getTimeAgo(commitDate);
                  const isLast = index === history.commits.length - 1;

                  // Check if this commit is the selected one
                  const isSelectedCommit =
                    commit.hash === selectedCommitHash ||
                    commit.short_hash === selectedCommitHash.substring(0, 8) ||
                    selectedCommitHash.startsWith(commit.hash) ||
                    selectedCommitHash.startsWith(commit.short_hash);

                  let changeType = "modified";
                  let changeIcon = "fas fa-edit";
                  let changeColor = "primary";

                  if (isLast) {
                    changeType = "added";
                    changeIcon = "fas fa-plus";
                    changeColor = "success";
                  }

                  if (commit.change_type === "D") {
                    changeType = "deleted";
                    changeIcon = "fas fa-trash";
                    changeColor = "danger";
                  } else if (commit.change_type === "N") {
                    changeType = "no change";
                    changeIcon = "fas fa-eye";
                    changeColor = "secondary";
                  }

                  historyHtml += `
                    <div class="timeline-item timeline-selectable ${isSelectedCommit ? "timeline-current" : ""}" 
                         data-commit-hash="${commit.hash}" 
                         data-commit-short="${commit.short_hash}"
                         onclick="configCompare.toggleHistoryRowSelection('${commit.hash}', event)">
                      <div class="timeline-marker bg-${changeColor}">
                        <i class="${changeIcon}"></i>
                      </div>
                      <div class="timeline-content">
                        <div class="timeline-main-content">
                          <div class="timeline-commit-info">
                            <code>${commit.short_hash}</code>
                            ${isSelectedCommit ? '<br><span class="badge bg-info" style="font-size: 0.6rem;">Selected</span>' : ""}
                          </div>
                          <div class="timeline-author-info">
                            <strong>${typeof commit.author === "object" ? commit.author.name : commit.author}</strong>
                          </div>
                          <div class="timeline-message-info" title="${commit.message}">
                            ${commit.message}
                            ${commit.change_type === "N" ? '<div class="mt-1"><small class="text-muted"><i class="fas fa-info-circle"></i> No changes to this file</small></div>' : ""}
                          </div>
                          <div class="timeline-time-info">
                            <i class="fas fa-clock"></i> ${timeAgo}
                          </div>
                        </div>
                        <div class="timeline-actions">
                          ${
                            isLast
                              ? `<button class="btn btn-outline-info" 
                                    onclick="configCompare.viewHistoryFile('${commit.hash}', '${commit.short_hash}'); event.stopPropagation();"
                                    title="View file content at this commit">
                              <i class="fas fa-file-alt"></i>
                            </button>`
                              : commit.change_type === "N"
                                ? `<button class="btn btn-outline-secondary" disabled
                                    title="No changes to show for this commit">
                              <i class="fas fa-eye-slash"></i>
                            </button>`
                                : `<button class="btn btn-outline-primary" 
                                    onclick="configCompare.compareHistoryCommit('${commit.hash}', '${commit.short_hash}'); event.stopPropagation();"
                                    title="Show changes made in this commit">
                              <i class="fas fa-exchange-alt"></i>
                            </button>`
                          }
                          <button class="btn btn-outline-success" 
                                  onclick="configCompare.downloadHistoryFile('${commit.hash}', '${commit.short_hash}'); event.stopPropagation();"
                                  title="Download file at this commit">
                            <i class="fas fa-download"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
                });

                historyHtml += "</div>";
                historyContent.innerHTML = historyHtml;

                // Initialize button state
                this.selectedHistoryRows = [];
              }

              async compareHistoryCommit(commitHash, shortHash) {
                // Get the current file path from the history display
                const fileName = document.getElementById("historyFileName").textContent;
                if (!fileName) {
                  this.showError("No file selected for comparison");
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  // Get the file history to find the parent commit
                  const historyData = await window.authManager.apiRequest(
                    `/api/git/file-complete-history/${encodeURIComponent(fileName)}?from_commit=${encodeURIComponent(commitHash)}`
                  );

                  // Find the current commit and the next one (parent) in the history
                  let currentIndex = -1;
                  for (let i = 0; i < historyData.commits.length; i++) {
                    if (
                      historyData.commits[i].hash === commitHash ||
                      historyData.commits[i].short_hash === shortHash
                    ) {
                      currentIndex = i;
                      break;
                    }
                  }

                  if (currentIndex === -1) {
                    this.showError("Could not find commit in history");
                    return;
                  }

                  // Get parent commit (next in history array, or create empty for first commit)
                  let parentCommit = null;
                  if (currentIndex < historyData.commits.length - 1) {
                    parentCommit = historyData.commits[currentIndex + 1].hash;
                  } else {
                    // This is the first commit for this file, compare with empty
                    parentCommit = null;
                  }

                  // Use the existing diff API
                  const diffData = await window.authManager.apiRequest("/api/git/diff", {
                    method: "POST",
                    body: JSON.stringify({
                      commit1: parentCommit, // Parent (older)
                      commit2: commitHash, // Current (newer)
                      file_path: fileName,
                    }),
                  });

                  // Format the diff data for display
                  const formattedDiff = this.formatGitDiff(
                    diffData,
                    fileName,
                    parentCommit || "empty",
                    commitHash
                  );

                  // Display the comparison
                  this.displayComparison(formattedDiff, `Commit ${shortHash}: ${fileName}`);

                  // Scroll to comparison section
                  document.getElementById("comparisonSection").scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                } catch (error) {
                  this.showError(`Error loading commit diff: ${error.message}`);
                }
              }

              async viewHistoryFile(commitHash, shortHash) {
                // Get the current file path from the history display
                const fileName = document.getElementById("historyFileName").textContent;
                if (!fileName) {
                  this.showError("No file selected to view");
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  const fileData = await window.authManager.apiRequest(
                    `/api/git/files/${commitHash}?file_path=${encodeURIComponent(fileName)}`
                  );

                  // Display file content using a simple approach
                  const displayData = {
                    left_file: `${fileName} (${shortHash})`,
                    right_file: `File Content`,
                    left_lines: [],
                    right_lines: [],
                  };

                  // Convert file content to lines for display
                  const lines = fileData.content ? fileData.content.split("\n") : ["<empty file>"];
                  lines.forEach((line, index) => {
                    displayData.left_lines.push({
                      line_number: index + 1,
                      content: line,
                      type: "equal",
                    });
                    // Add the same line to right side to make it display properly
                    displayData.right_lines.push({
                      line_number: index + 1,
                      content: line,
                      type: "equal",
                    });
                  });

                  this.displayComparison(displayData, `File Content: ${fileName} (${shortHash})`);

                  // Scroll to comparison section
                  document.getElementById("comparisonSection").scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                } catch (error) {
                  this.showError(`Error loading file content: ${error.message}`);
                }
              }

              populateFileSelects() {
                // This method is now used to initialize the search functionality
                // Files are stored in this.files and used by the search inputs
                console.log(`Loaded ${this.files.length} files for search functionality`);

                // Initialize file search for both sides
                this.initializeFileSearch("leftFileSearch", "left", (file) => {
                  this.selectedLeftFile = file;
                  this.updateCompareButton();
                });

                this.initializeFileSearch("rightFileSearch", "right", (file) => {
                  this.selectedRightFile = file;
                  this.updateCompareButton();
                });
              }

              async compareFiles() {
                const leftFile = this.selectedLeftFile ? this.selectedLeftFile.path : null;
                const rightFile = this.selectedRightFile ? this.selectedRightFile.path : null;

                if (!leftFile || !rightFile) {
                  this.showError("Please select both files to compare");
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  const data = await window.authManager.apiRequest("/api/files/compare", {
                    method: "POST",
                    body: JSON.stringify({
                      left_file: leftFile,
                      right_file: rightFile,
                    }),
                  });

                  this.displayComparison(data, `${leftFile} vs ${rightFile}`);
                } catch (error) {
                  this.showError("Error comparing files: " + error.message);
                }
              }

              async compareGitCommits() {
                const leftCommit = document.getElementById("leftCommitSelect").value;
                const rightCommit = document.getElementById("rightCommitSelect").value;
                const gitFile = this.selectedGitFile ? this.selectedGitFile.path : null;

                if (!leftCommit || !rightCommit || !gitFile) {
                  this.showError("Please select both commits and a file to compare");
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  const result = await window.authManager.apiRequest("/api/git/diff", {
                    method: "POST",
                    body: JSON.stringify({
                      commit1: leftCommit,
                      commit2: rightCommit,
                      file_path: gitFile,
                    }),
                  });

                  // Convert Git diff format to comparison format
                  const formattedResult = this.formatGitDiff(
                    result,
                    gitFile,
                    leftCommit,
                    rightCommit
                  );
                  const leftCommitShort = leftCommit.substring(0, 8);
                  const rightCommitShort = rightCommit.substring(0, 8);
                  this.displayComparison(
                    formattedResult,
                    `${gitFile}: ${leftCommitShort}  ${rightCommitShort}`
                  );
                } catch (error) {
                  this.showError("Error comparing Git commits: " + error.message);
                }
              }

              formatGitDiff(gitResult, fileName, leftCommit, rightCommit) {
                // The backend now returns data in the same format as file comparison
                // Check if we have the new format with left_lines and right_lines
                if (gitResult.left_lines && gitResult.right_lines) {
                  // New format - use directly
                  return {
                    left_file: gitResult.left_file,
                    right_file: gitResult.right_file,
                    left_lines: gitResult.left_lines,
                    right_lines: gitResult.right_lines,
                  };
                }

                // Fallback to old format processing for backward compatibility
                const leftLines = [];
                const rightLines = [];

                if (gitResult.diff_lines && Array.isArray(gitResult.diff_lines)) {
                  let leftLineNum = 1;
                  let rightLineNum = 1;

                  gitResult.diff_lines.forEach((line) => {
                    if (line.startsWith("-")) {
                      // Deleted line
                      leftLines.push({
                        line_number: leftLineNum++,
                        content: line.substring(1),
                        type: "delete",
                      });
                      rightLines.push({
                        line_number: null,
                        content: "",
                        type: "empty",
                      });
                    } else if (line.startsWith("+")) {
                      // Added line
                      leftLines.push({
                        line_number: null,
                        content: "",
                        type: "empty",
                      });
                      rightLines.push({
                        line_number: rightLineNum++,
                        content: line.substring(1),
                        type: "insert",
                      });
                    } else if (line.startsWith(" ")) {
                      // Unchanged line
                      leftLines.push({
                        line_number: leftLineNum++,
                        content: line.substring(1),
                        type: "equal",
                      });
                      rightLines.push({
                        line_number: rightLineNum++,
                        content: line.substring(1),
                        type: "equal",
                      });
                    }
                  });
                } else {
                  // No differences or files are identical
                  leftLines.push({
                    line_number: 1,
                    content: "Files are identical or no differences found",
                    type: "equal",
                  });
                  rightLines.push({
                    line_number: 1,
                    content: "Files are identical or no differences found",
                    type: "equal",
                  });
                }

                return {
                  left_file: `${fileName} (${leftCommit.substring(0, 8)})`,
                  right_file: `${fileName} (${rightCommit.substring(0, 8)})`,
                  left_lines: leftLines,
                  right_lines: rightLines,
                };
              }

              populateFileSelects() {
                // This method is now used to initialize the search functionality
                // Files are stored in this.files and used by the search inputs
                console.log(`Loaded ${this.files.length} files for search functionality`);

                // Initialize file search for both sides
                this.initializeFileSearch("leftFileSearch", "left", (file) => {
                  this.selectedLeftFile = file;
                  this.updateCompareButton();
                });

                this.initializeFileSearch("rightFileSearch", "right", (file) => {
                  this.selectedRightFile = file;
                  this.updateCompareButton();
                });
              }

              updateCompareButton() {
                const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                const compareBtn = document.getElementById("compareBtn");
                const historyCompareBtn = document.getElementById("historyCompareBtn");
                const historyExportBtn = document.getElementById("historyExportBtn");
                let canCompare = false;

                if (mode === "files") {
                  const leftFile = this.selectedLeftFile ? this.selectedLeftFile.path : null;
                  const rightFile = this.selectedRightFile ? this.selectedRightFile.path : null;
                  canCompare = leftFile && rightFile && leftFile !== rightFile;
                  compareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare Files';
                } else if (mode === "git") {
                  const leftCommit = document.getElementById("leftCommitSelect").value;
                  const rightCommit = document.getElementById("rightCommitSelect").value;
                  const gitFile = this.selectedGitFile ? this.selectedGitFile.path : null;
                  canCompare = leftCommit && rightCommit && gitFile && leftCommit !== rightCommit;
                  compareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare Commits';
                } else if (mode === "history") {
                  // In history mode, check if we have selected rows for comparison
                  canCompare = this.selectedHistoryRows.length === 2;
                  if (historyCompareBtn) {
                    historyCompareBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare';
                    historyCompareBtn.disabled = !canCompare;
                  }
                  if (historyExportBtn) {
                    historyExportBtn.disabled = !canCompare;
                  }
                }

                // Update main compare button (for files and git modes)
                if (mode !== "history") {
                  compareBtn.disabled = !canCompare;
                }
              }

              async compareFiles() {
                const leftFile = this.selectedLeftFile ? this.selectedLeftFile.path : null;
                const rightFile = this.selectedRightFile ? this.selectedRightFile.path : null;

                if (!leftFile || !rightFile) {
                  this.showError("Please select both files to compare");
                  return;
                }

                // Show loading state
                this.showLoading();

                try {
                  const data = await window.authManager.apiRequest("/api/files/compare", {
                    method: "POST",
                    body: JSON.stringify({
                      left_file: leftFile,
                      right_file: rightFile,
                    }),
                  });

                  this.displayComparison(data);
                } catch (error) {
                  this.showError("Error comparing files: " + error.message);
                }
              }

              displayComparison(comparison, title = null) {
                // Update file names
                document.getElementById("leftFileName").textContent = title
                  ? title.split(" vs ")[0] || title.split(": ")[0]
                  : comparison.left_file;
                document.getElementById("rightFileName").textContent = title
                  ? title.split(" vs ")[1] || title.split(": ")[1] || title.split("  ")[1]
                  : comparison.right_file;

                // Calculate stats from the data
                let additions = 0,
                  deletions = 0,
                  modifications = 0;
                comparison.left_lines.forEach((line) => {
                  if (line.type === "insert") additions++;
                  else if (line.type === "delete") deletions++;
                  else if (line.type === "replace") modifications++;
                });

                // Update stats
                const stats = `${additions} additions, ${deletions} deletions, ${modifications} modifications`;
                document.getElementById("comparisonStats").textContent = stats;

                // Render diff
                this.renderDiff(comparison);

                // Show comparison section
                document.getElementById("comparisonSection").style.display = "block";

                // Enable export button
                document.getElementById("exportBtn").disabled = false;

                // Setup navigation
                this.setupDiffNavigation(comparison);
              }

              async showGitStatus() {
                if (!this.selectedRepository) {
                  alert("No repository selected. Please select a repository first.");
                  return;
                }

                if (!this.gitData.status) {
                  await this.checkRepositoryState();
                }

                let statusHtml = `
                  <div class="modal fade" id="gitStatusModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Git Repository Status - ${this.selectedRepository.name}</h5>
                          <button type="button" class="btn-close" id="closeGitStatusModal"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6">
                              <h6>Repository Details:</h6>
                              <dl class="row">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">${this.selectedRepository.name}</dd>
                                <dt class="col-sm-4">URL:</dt>
                                <dd class="col-sm-8"><a href="${this.selectedRepository.url}" target="_blank">${this.selectedRepository.url}</a></dd>
                                <dt class="col-sm-4">Branch:</dt>
                                <dd class="col-sm-8"><code>${this.gitData.status?.current_branch || this.selectedRepository.branch}</code></dd>
                              </dl>
                              
                              <h6>Repository Status:</h6>
                              <p class="${this.gitData.status?.is_dirty ? "text-warning" : "text-success"}">
                                <i class="fas ${this.gitData.status?.is_dirty ? "fa-exclamation-triangle" : "fa-check-circle"}"></i>
                                ${this.gitData.status?.is_dirty ? "Modified files present" : "Clean working directory"}
                              </p>
                            </div>
                            <div class="col-md-6">
                              <h6>Available Branches:</h6>
                              ${
                                this.gitData.branches && this.gitData.branches.length > 0
                                  ? `
                                <ul class="list-unstyled">
                                  ${this.gitData.branches
                                    .map((branch) => {
                                      const branchName =
                                        typeof branch === "string" ? branch : branch.name;
                                      const isCurrent =
                                        branchName === this.gitData.status?.current_branch;
                                      return `<li class="${isCurrent ? "text-primary fw-bold" : ""}">${branchName}${isCurrent ? " (current)" : ""}</li>`;
                                    })
                                    .join("")}
                                </ul>
                              `
                                  : '<p class="text-muted">No branches available</p>'
                              }
                            </div>
                          </div>
                          
                          ${
                            this.gitData.status?.is_dirty
                              ? `
                            <div class="row mt-3">
                              <div class="col-md-12">
                                <h6>Working Directory Changes:</h6>
                                ${
                                  this.gitData.status.modified_files &&
                                  this.gitData.status.modified_files.length > 0
                                    ? `
                                  <p><strong>Modified Files:</strong></p>
                                  <ul class="list-unstyled">
                                    ${this.gitData.status.modified_files.map((file) => `<li class="text-warning"><i class="fas fa-edit"></i> ${file}</li>`).join("")}
                                  </ul>
                                `
                                    : ""
                                }
                                ${
                                  this.gitData.status.untracked_files &&
                                  this.gitData.status.untracked_files.length > 0
                                    ? `
                                  <p><strong>Untracked Files:</strong></p>
                                  <ul class="list-unstyled">
                                    ${this.gitData.status.untracked_files.map((file) => `<li class="text-info"><i class="fas fa-plus"></i> ${file}</li>`).join("")}
                                  </ul>
                                `
                                    : ""
                                }
                              </div>
                            </div>
                          `
                              : ""
                          }
                          
                          ${
                            this.gitData.commits && this.gitData.commits.length > 0
                              ? `
                            <div class="row mt-3">
                              <div class="col-md-12">
                                <h6>Recent Commits:</h6>
                                <div class="table-responsive">
                                  <table class="table table-sm">
                                    <thead>
                                      <tr>
                                        <th>Hash</th>
                                        <th>Message</th>
                                        <th>Author</th>
                                        <th>Date</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${this.gitData.commits
                                        .slice(0, 10)
                                        .map(
                                          (commit) => `
                                        <tr>
                                          <td><code>${commit.hash.substring(0, 8)}</code></td>
                                          <td>${commit.message}</td>
                                          <td>${typeof commit.author === "object" ? commit.author.name : commit.author}</td>
                                          <td>${new Date(commit.date).toLocaleDateString()}</td>
                                        </tr>
                                      `
                                        )
                                        .join("")}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          `
                              : '<div class="alert alert-info mt-3">No commits available</div>'
                          }
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" id="closeGitStatusModalBtn">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                // Remove existing modal and add new one
                const existingModal = document.getElementById("gitStatusModal");
                if (existingModal) {
                  this.closeGitStatusModal();
                }

                // Remove any existing backdrop
                const existingBackdrop = document.querySelector(".modal-backdrop");
                if (existingBackdrop) {
                  existingBackdrop.remove();
                }

                document.body.insertAdjacentHTML("beforeend", statusHtml);

                // Show the modal
                const modal = document.getElementById("gitStatusModal");
                modal.style.display = "block";
                modal.classList.add("show");

                // Add backdrop
                const backdrop = document.createElement("div");
                backdrop.className = "modal-backdrop fade show";
                backdrop.id = "gitStatusBackdrop";
                document.body.appendChild(backdrop);

                // Add event listeners for close functionality
                const closeBtn = document.getElementById("closeGitStatusModal");
                const closeFooterBtn = document.getElementById("closeGitStatusModalBtn");

                closeBtn.addEventListener("click", () => this.closeGitStatusModal());
                closeFooterBtn.addEventListener("click", () => this.closeGitStatusModal());
                backdrop.addEventListener("click", () => this.closeGitStatusModal());

                // Close on escape key
                const escapeHandler = (e) => {
                  if (e.key === "Escape") {
                    this.closeGitStatusModal();
                    document.removeEventListener("keydown", escapeHandler);
                  }
                };
                document.addEventListener("keydown", escapeHandler);
              }

              closeGitStatusModal() {
                const modal = document.getElementById("gitStatusModal");
                const backdrop = document.getElementById("gitStatusBackdrop");

                if (modal) {
                  modal.remove();
                }

                if (backdrop) {
                  backdrop.remove();
                }

                // Also remove any other modal backdrops that might be left behind
                const allBackdrops = document.querySelectorAll(".modal-backdrop");
                allBackdrops.forEach((bd) => bd.remove());

                // Remove the modal-open class from body if it exists
                document.body.classList.remove("modal-open");

                // Reset body padding-right that Bootstrap sometimes adds
                document.body.style.paddingRight = "";
              }

              renderDiff(diffData) {
                const container = document.getElementById("diffContent");
                container.innerHTML = "";

                this.currentDiffs = [];

                // Render side-by-side comparison
                const maxLines = Math.max(diffData.left_lines.length, diffData.right_lines.length);

                for (let i = 0; i < maxLines; i++) {
                  const leftLine = diffData.left_lines[i] || {
                    line_number: null,
                    content: "",
                    type: "empty",
                  };
                  const rightLine = diffData.right_lines[i] || {
                    line_number: null,
                    content: "",
                    type: "empty",
                  };

                  const row = document.createElement("div");
                  row.className = "diff-row";

                  // Left side
                  const leftDiv = document.createElement("div");
                  leftDiv.className = `diff-line ${this.getDiffClass(leftLine.type)}`;
                  leftDiv.innerHTML = this.formatLine(
                    leftLine.line_number,
                    leftLine.content,
                    leftLine.type,
                    "left"
                  );

                  // Right side
                  const rightDiv = document.createElement("div");
                  rightDiv.className = `diff-line ${this.getDiffClass(rightLine.type)}`;
                  rightDiv.innerHTML = this.formatLine(
                    rightLine.line_number,
                    rightLine.content,
                    rightLine.type,
                    "right"
                  );

                  row.appendChild(leftDiv);
                  row.appendChild(rightDiv);
                  container.appendChild(row);

                  // Track diff locations for navigation and export
                  // Store all lines for export, including unchanged ones
                  const diffType = this.getDiffType(leftLine.type, rightLine.type);
                  this.currentDiffs.push({
                    element: row,
                    type: diffType,
                    left: leftLine.content || "",
                    right: rightLine.content || "",
                    leftLineNumber: leftLine.line_number,
                    rightLineNumber: rightLine.line_number,
                    index: this.currentDiffs.length,
                  });
                }

                // Setup sync scrolling
                this.setupSyncScrolling();

                // Update navigation buttons
                this.updateNavigationButtons();
              }

              getDiffClass(type) {
                switch (type) {
                  case "insert":
                    return "diff-added";
                  case "delete":
                    return "diff-removed";
                  case "replace":
                    return "diff-modified";
                  case "equal":
                    return "diff-unchanged";
                  default:
                    return "diff-unchanged";
                }
              }

              getDiffType(leftType, rightType) {
                // Determine unified diff type based on left and right line types
                if (leftType === "equal" && rightType === "equal") {
                  return "unchanged";
                } else if (leftType === "delete" && rightType === "empty") {
                  return "removed";
                } else if (leftType === "empty" && rightType === "insert") {
                  return "added";
                } else if (leftType === "replace" || rightType === "replace") {
                  return "modified";
                } else if (leftType === "delete" && rightType === "insert") {
                  return "modified";
                } else {
                  return "unchanged";
                }
              }

              formatLine(lineNumber, content, type, side) {
                const lineNumSpan = `<span class="diff-line-number">${lineNumber || ""}</span>`;
                const contentSpan = `<span class="diff-line-content">${this.escapeHtml(content || "")}</span>`;
                return lineNumSpan + contentSpan;
              }

              escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
              }

              setupSyncScrolling() {
                const container = document.getElementById("diffContent");
                // Sync scrolling is handled by CSS flexbox layout
              }

              setupDiffNavigation(diffData) {
                this.currentDiffIndex = 0;
                this.updateNavigationButtons();
              }

              navigateDiff(direction) {
                // Get only the changed lines (not unchanged ones) for navigation
                const changedDiffs = this.currentDiffs.filter((diff) => diff.type !== "unchanged");

                if (changedDiffs.length === 0) return;

                this.currentDiffIndex += direction;

                if (this.currentDiffIndex < 0) {
                  this.currentDiffIndex = changedDiffs.length - 1;
                } else if (this.currentDiffIndex >= changedDiffs.length) {
                  this.currentDiffIndex = 0;
                }

                // Scroll to current diff
                const diff = changedDiffs[this.currentDiffIndex];
                diff.element.scrollIntoView({ behavior: "smooth", block: "center" });

                // Highlight current diff temporarily
                diff.element.style.outline = "2px solid #007bff";
                setTimeout(() => {
                  diff.element.style.outline = "";
                }, 2000);

                this.updateNavigationButtons();
              }

              updateNavigationButtons() {
                const prevBtn = document.getElementById("prevDiffBtn");
                const nextBtn = document.getElementById("nextDiffBtn");

                // Use only changed diffs for navigation count
                const changedDiffs = this.currentDiffs.filter((diff) => diff.type !== "unchanged");
                const hasDeltas = changedDiffs.length > 0;

                prevBtn.disabled = !hasDeltas;
                nextBtn.disabled = !hasDeltas;

                if (hasDeltas) {
                  prevBtn.title = `Previous difference (${this.currentDiffIndex + 1}/${changedDiffs.length})`;
                  nextBtn.title = `Next difference (${this.currentDiffIndex + 1}/${changedDiffs.length})`;
                }
              }

              showLoading() {
                const diffContent = document.getElementById("diffContent");
                diffContent.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-3">Loading comparison...</p>
                  </div>
                `;

                // Show the comparison section
                document.getElementById("comparisonSection").style.display = "block";
              }

              showError(message) {
                const diffContent = document.getElementById("diffContent");
                diffContent.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    <p class="mt-3 text-danger">${message}</p>
                  </div>
                `;

                // Show the comparison section
                document.getElementById("comparisonSection").style.display = "block";
              }

              toggleUnchanged() {
                this.hideUnchanged = !this.hideUnchanged;
                const toggleBtn = document.getElementById("toggleUnchangedBtn");
                const unchangedLines = document.querySelectorAll(".diff-unchanged");

                if (this.hideUnchanged) {
                  unchangedLines.forEach((line) => line.parentElement.classList.add("diff-hidden"));
                  toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Show Unchanged';
                } else {
                  unchangedLines.forEach((line) =>
                    line.parentElement.classList.remove("diff-hidden")
                  );
                  toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Unchanged';
                }
              }

              async exportDiff() {
                try {
                  // Check if we have diff content to export
                  if (!this.currentDiffs || this.currentDiffs.length === 0) {
                    this.showError("No diff content to export. Please run a comparison first.");
                    return;
                  }

                  // Get the file names for the export
                  const mode = document.querySelector('input[name="comparisonMode"]:checked').value;
                  let leftFileName = "source";
                  let rightFileName = "target";
                  let exportFileName = "diff.patch";

                  if (mode === "files") {
                    leftFileName = this.selectedLeftFile
                      ? this.selectedLeftFile.name || this.selectedLeftFile.path
                      : "source";
                    rightFileName = this.selectedRightFile
                      ? this.selectedRightFile.name || this.selectedRightFile.path
                      : "target";
                  } else if (mode === "git") {
                    const leftCommit = document.getElementById("leftCommitSelect").value;
                    const rightCommit = document.getElementById("rightCommitSelect").value;
                    const gitFile = this.selectedGitFile ? this.selectedGitFile.path : null;

                    leftFileName = gitFile
                      ? `${gitFile}@${leftCommit?.substring(0, 8) || "source"}`
                      : "source";
                    rightFileName = gitFile
                      ? `${gitFile}@${rightCommit?.substring(0, 8) || "target"}`
                      : "target";
                  }

                  // Create a meaningful filename
                  const timestamp = new Date().toISOString().replace(/[:.]/g, "-").substring(0, 19);
                  exportFileName = `diff_${leftFileName.replace(/[^\w.-]/g, "_")}_vs_${rightFileName.replace(/[^\w.-]/g, "_")}_${timestamp}.patch`;

                  // Generate unified diff format from current diff data
                  let unifiedDiff = this.generateUnifiedDiff(leftFileName, rightFileName);

                  if (!unifiedDiff.trim()) {
                    this.showError("No differences found to export.");
                    return;
                  }

                  // Create and download the file
                  const blob = new Blob([unifiedDiff], { type: "text/plain;charset=utf-8" });
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = exportFileName;
                  a.style.display = "none";
                  document.body.appendChild(a);
                  a.click();

                  // Cleanup
                  setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                  }, 100);

                  this.showSuccess(`Diff exported as ${exportFileName}`);
                } catch (error) {
                  console.error("Export error:", error);
                  this.showError("Export failed: " + error.message);
                }
              }

              showSuccess(message) {
                // Show success message in the comparison stats area
                const statsElement = document.getElementById("comparisonStats");
                const originalText = statsElement.textContent;

                statsElement.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${message}`;
                statsElement.style.color = "#28a745";

                // Restore original text after 3 seconds
                setTimeout(() => {
                  statsElement.textContent = originalText;
                  statsElement.style.color = "";
                }, 3000);
              }

              generateUnifiedDiff(leftFileName, rightFileName) {
                if (!this.currentDiffs || this.currentDiffs.length === 0) {
                  return "";
                }

                const timestamp = new Date().toISOString();
                let unifiedDiff = `--- ${leftFileName}\t${timestamp}\n`;
                unifiedDiff += `+++ ${rightFileName}\t${timestamp}\n`;

                let leftLineNum = 1;
                let rightLineNum = 1;
                let hunkStart = null;
                let hunkLines = [];

                for (let i = 0; i < this.currentDiffs.length; i++) {
                  const diff = this.currentDiffs[i];

                  if (diff.type === "unchanged") {
                    // If we have a hunk in progress, output it
                    if (hunkStart !== null) {
                      unifiedDiff += this.formatHunk(
                        hunkStart,
                        hunkLines,
                        leftLineNum,
                        rightLineNum
                      );
                      hunkStart = null;
                      hunkLines = [];
                    }
                    leftLineNum++;
                    rightLineNum++;
                  } else {
                    // Start a new hunk if needed
                    if (hunkStart === null) {
                      hunkStart = { left: leftLineNum, right: rightLineNum };

                      // Add context lines before the change
                      const contextBefore = Math.max(0, i - 3);
                      for (let j = contextBefore; j < i; j++) {
                        if (this.currentDiffs[j] && this.currentDiffs[j].type === "unchanged") {
                          hunkLines.push(
                            ` ${this.currentDiffs[j].left || this.currentDiffs[j].right || ""}`
                          );
                        }
                      }
                    }

                    // Add the changed line
                    if (diff.type === "removed") {
                      hunkLines.push(`-${diff.left || ""}`);
                      leftLineNum++;
                    } else if (diff.type === "added") {
                      hunkLines.push(`+${diff.right || ""}`);
                      rightLineNum++;
                    } else if (diff.type === "modified") {
                      hunkLines.push(`-${diff.left || ""}`);
                      hunkLines.push(`+${diff.right || ""}`);
                      leftLineNum++;
                      rightLineNum++;
                    }
                  }
                }

                // Output any remaining hunk
                if (hunkStart !== null) {
                  unifiedDiff += this.formatHunk(hunkStart, hunkLines, leftLineNum, rightLineNum);
                }

                return unifiedDiff;
              }

              formatHunk(hunkStart, hunkLines, endLeftLine, endRightLine) {
                const leftCount = endLeftLine - hunkStart.left;
                const rightCount = endRightLine - hunkStart.right;

                let hunk = `@@ -${hunkStart.left},${leftCount} +${hunkStart.right},${rightCount} @@\n`;
                hunk += hunkLines.join("\n") + "\n";

                return hunk;
              }

              showLoading() {
                const container = document.getElementById("diffContent");
                container.innerHTML = `
                  <div class="diff-loading text-center" style="padding: 50px;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-3">Comparing files...</p>
                  </div>
                `;
                document.getElementById("comparisonSection").style.display = "block";
              }

              showError(message) {
                const container = document.getElementById("diffContent");
                container.innerHTML = `
                  <div class="text-center" style="padding: 50px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    <p class="mt-3 text-danger">${message}</p>
                  </div>
                `;
                document.getElementById("comparisonSection").style.display = "block";
              }
            }

            // Global reference for onclick handlers
            let configCompare;

            // Git Repository Management
            class GitManager {
              constructor() {
                console.log("GitManager: Initializing...");
                this.initializeEventListeners();

                // Delay initial status check to ensure authManager is ready
                setTimeout(() => {
                  console.log(
                    "GitManager: Checking if authManager is ready...",
                    !!window.authManager
                  );
                  if (window.authManager) {
                    console.log("GitManager: AuthManager ready, checking repository status...");
                    this.checkRepositoryStatus();
                  } else {
                    console.warn("GitManager: AuthManager not ready, retrying in 1 second...");
                    setTimeout(() => {
                      console.log(
                        "GitManager: Retrying repository status check...",
                        !!window.authManager
                      );
                      if (window.authManager) {
                        this.checkRepositoryStatus();
                      } else {
                        console.error("GitManager: AuthManager still not ready after 1.5 seconds");
                        this.updateStatusMessage(
                          "danger",
                          '<i class="fas fa-times-circle"></i> Authentication system not ready. Please refresh the page.'
                        );
                      }
                    }, 1000);
                  }
                }, 500);
              }

              initializeEventListeners() {
                // Refresh status button
                document.getElementById("refreshGitStatus").addEventListener("click", () => {
                  this.checkRepositoryStatus();
                });

                // Sync repository button
                document.getElementById("syncRepository").addEventListener("click", () => {
                  this.syncRepository();
                });

                // Clone repository button
                document.getElementById("cloneRepository").addEventListener("click", () => {
                  this.cloneRepository();
                });
              }

              async checkRepositoryStatus() {
                this.updateStatusMessage(
                  "info",
                  '<i class="fas fa-spinner fa-spin"></i> Checking repository status...',
                  true
                );
                this.setButtonsDisabled(true);

                try {
                  // Check if authManager is available
                  if (!window.authManager) {
                    throw new Error("Authentication manager not initialized");
                  }

                  const response = await window.authManager.apiRequest("/api/git/repo/status");

                  if (response.success) {
                    const status = response.data;
                    // this.updateRepositoryInfo(status); // Disabled - using new repository selector

                    if (status.is_git_repo) {
                      if (status.has_configs) {
                        this.updateStatusMessage(
                          "success",
                          '<i class="fas fa-check-circle"></i> Repository is ready with configuration files.'
                        );

                        // Auto-collapse the Git Repository Status panel when ready
                        setTimeout(() => {
                          const gitStatusPanel = document.querySelector(
                            "#gitStatusSection .collapse-link"
                          );
                          if (gitStatusPanel) {
                            gitStatusPanel.click();
                            console.log(
                              "GitManager: Auto-collapsed Git Repository Status panel (status: ready)"
                            );
                          }
                        }, 1500); // Wait 1.5 seconds to let user see the success message
                      } else {
                        this.updateStatusMessage(
                          "warning",
                          '<i class="fas fa-exclamation-triangle"></i> Repository exists but no configuration files found.'
                        );
                      }
                      this.setButtonsDisabled(false);
                    } else if (!status.is_empty) {
                      this.updateStatusMessage(
                        "warning",
                        '<i class="fas fa-exclamation-triangle"></i> Directory exists but is not a Git repository.'
                      );
                      document.getElementById("cloneRepository").disabled = false;
                    } else {
                      this.updateStatusMessage(
                        "info",
                        '<i class="fas fa-info-circle"></i> Repository not initialized. Click "Sync Repository" to clone.'
                      );
                      document.getElementById("syncRepository").disabled = false;
                    }
                  } else {
                    this.updateStatusMessage(
                      "danger",
                      `<i class="fas fa-times-circle"></i> Error: ${response.message}`
                    );
                  }
                } catch (error) {
                  console.error("Error checking repository status:", error);
                  console.error("Error message:", error.message);
                  console.error("Error stack:", error.stack);

                  // More specific error messages
                  let errorMessage = "Failed to check repository status.";
                  if (error.message.includes("Authentication manager")) {
                    errorMessage += " Authentication not ready.";
                  } else if (error.message.includes("Failed to fetch")) {
                    errorMessage += " Backend server not available.";
                  } else if (error.message.includes("401")) {
                    errorMessage += " Authentication failed. Please log in again.";
                  } else {
                    errorMessage += ` Check your settings and try again. (Error: ${error.message})`;
                  }

                  this.updateStatusMessage(
                    "danger",
                    `<i class="fas fa-times-circle"></i> ${errorMessage}`
                  );
                }
              }

              async syncRepository() {
                if (!this.selectedRepository) {
                  this.updateStatusMessage(
                    "danger",
                    '<i class="fas fa-exclamation-triangle"></i> No repository selected'
                  );
                  return;
                }

                this.updateStatusMessage(
                  "info",
                  '<i class="fas fa-spinner fa-spin"></i> Synchronizing repository...',
                  true
                );
                this.setButtonsDisabled(true);

                try {
                  const response = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/sync`,
                    {
                      method: "POST",
                    }
                  );

                  if (response.success) {
                    this.updateStatusMessage(
                      "success",
                      `<i class="fas fa-check-circle"></i> ${response.message}`
                    );

                    // Update repository state after sync
                    await this.checkRepositoryState();
                    this.setButtonsDisabled(false);
                  } else {
                    this.updateStatusMessage(
                      "danger",
                      `<i class="fas fa-times-circle"></i> Sync failed: ${response.message}`
                    );
                    this.setButtonsDisabled(false);
                  }
                } catch (error) {
                  console.error("Error syncing repository:", error);
                  this.updateStatusMessage(
                    "danger",
                    '<i class="fas fa-times-circle"></i> Sync failed. Check your Git settings.'
                  );
                  this.setButtonsDisabled(false);
                }
              }

              async cloneRepository() {
                if (!this.selectedRepository) {
                  this.updateStatusMessage(
                    "danger",
                    '<i class="fas fa-exclamation-triangle"></i> No repository selected'
                  );
                  return;
                }

                if (
                  !confirm("This will backup any existing repository and clone fresh. Continue?")
                ) {
                  return;
                }

                this.updateStatusMessage(
                  "info",
                  '<i class="fas fa-spinner fa-spin"></i> Cloning repository...',
                  true
                );
                this.setButtonsDisabled(true);

                try {
                  const response = await window.authManager.apiRequest(
                    `/api/git-repositories/${this.selectedRepository.id}/sync`,
                    {
                      method: "POST",
                    }
                  );

                  if (response.success) {
                    this.updateStatusMessage(
                      "success",
                      `<i class="fas fa-check-circle"></i> ${response.message}`
                    );

                    // Update repository state after clone
                    await this.checkRepositoryState();
                    this.setButtonsDisabled(false);
                  } else {
                    this.updateStatusMessage(
                      "danger",
                      `<i class="fas fa-times-circle"></i> Clone failed: ${response.message}`
                    );
                    this.setButtonsDisabled(false);
                  }
                } catch (error) {
                  console.error("Error cloning repository:", error);
                  this.updateStatusMessage(
                    "danger",
                    '<i class="fas fa-times-circle"></i> Clone failed. Check your Git settings.'
                  );
                  this.setButtonsDisabled(false);
                }
              }

              updateStatusMessage(type, message, loading = false) {
                // Status messages now logged to console since UI element was removed
                console.log(`Status (${type}):`, message);
              }

              setButtonsDisabled(disabled) {
                document.getElementById("syncRepository").disabled = disabled;
                document.getElementById("cloneRepository").disabled = disabled;
                document.getElementById("refreshGitStatus").disabled = disabled;
              }
            }

            let gitManager;

            // Initialize when DOM is loaded
            document.addEventListener("DOMContentLoaded", function () {
              console.log("Compare page: DOM loaded, initializing components...");

              // Delay ConfigCompare initialization to ensure authManager is fully ready
              setTimeout(() => {
                console.log("Compare page: Creating ConfigCompare...", !!window.authManager);
                configCompare = new ConfigCompare();
              }, 800);

              // GitManager disabled - repository management now handled by ConfigCompare
              // setTimeout(() => {
              //   console.log('Compare page: Creating GitManager...', !!window.authManager);
              //   gitManager = new GitManager();
              // }, 1000);
            });
          </script>
        </div>
        <!-- /page content -->
      </div>
    </div>
  </body>
</html>
