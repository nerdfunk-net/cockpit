<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="images/favicon.ico" type="image/ico" />
    <title>Dashboard - Cockpit</title>
    <!-- Vite entry (loads CSS/JS bundle) -->
    <script type="module" src="/src/main-minimal.js"></script>
    <!-- Config -->
    <script src="js/config.js"></script>
    <script>
      // Load container config only when not on vite dev server and not localhost
      (function () {
        const currentPort = window.location.port;
        const isDevelopment = currentPort === "3000" || currentPort === "3001";
        const isNonLocalhost =
          window.location.hostname !== "localhost" &&
          window.location.hostname !== "127.0.0.1";
        if (isNonLocalhost && !isDevelopment) {
          const script = document.createElement("script");
          script.src = "js/config-container.js";
          document.head.appendChild(script);
        }
      })();
    </script>
    <!-- API + Auth bootstrap -->
    <script src="js/api-manager.js"></script>
    <script>
      (function () {
        const t = localStorage.getItem("auth_token");
        if (!t) {
          window.location.href = "/login.html";
        }
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        window.authManager = new AuthManager();
      });
    </script>
  </head>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0">
              <a href="index.html" class="site_title"
                ><i class="fas fa-paw"></i> <span>Cockpit!</span></a
              >
            </div>
            <div class="clearfix"></div>
            <div class="profile clearfix">
              <div class="profile_pic"></div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <br />
            <div
              id="sidebar-menu"
              class="main_menu_side hidden-print main_menu"
            >
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li>
                    <a href="index.html" class="current-page"
                      ><i class="fas fa-home"></i> Home</a
                    >
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-rocket"></i> Onboarding
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="onboard-device.html"
                          ><i class="fas fa-plus-circle"></i> Onboard Device</a
                        >
                      </li>
                      <li>
                        <a href="sync_devices.html"
                          ><i class="fas fa-sync"></i> Sync Devices</a
                        >
                      </li>
                      <li>
                        <a href="scan-and-add.html"
                          ><i class="fas fa-search-plus"></i> Scan & Add</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Configs
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="backup.html"
                          ><i class="fas fa-save"></i> Backup</a
                        >
                      </li>
                      <li>
                        <a href="compare.html"
                          ><i class="fas fa-exchange-alt"></i> Compare</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Ansible
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="ansible-inventory.html"
                          ><i class="fas fa-list"></i> Inventory</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-wrench"></i> Settings
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="settings-nautobot.html"
                          ><i class="fas fa-server"></i> Nautobot</a
                        >
                      </li>
                      <li>
                        <a href="settings-templates.html"
                          ><i class="fas fa-file-code"></i> Templates</a
                        >
                      </li>
                      <li>
                        <a href="settings-git.html"
                          ><i class="fab fa-git-alt"></i> Git Management</a
                        >
                      </li>
                      <li>
                        <a href="settings-cache.html"
                          ><i class="fas fa-bolt"></i> Cache</a
                        >
                      </li>
                      <li>
                        <a href="settings-credentials.html"
                          ><i class="fas fa-key"></i> Credentials</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <div class="sidebar-footer hidden-small">
              <a
                href="settings-nautobot.html"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Settings"
                ><span class="fas fa-cog" aria-hidden="true"></span
              ></a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="FullScreen"
                ><span class="fas fa-expand" aria-hidden="true"></span
              ></a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock"
                ><span class="fas fa-eye-slash" aria-hidden="true"></span
              ></a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Logout"
                href="login.html"
                ><span class="fas fa-power-off" aria-hidden="true"></span
              ></a>
            </div>
          </div>
        </div>
        <!-- /sidebar -->

        <!-- top nav -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px">
                  <a
                    href="javascript:;"
                    class="user-profile dropdown-toggle"
                    aria-haspopup="true"
                    id="navbarDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <div
                    class="dropdown-menu dropdown-usermenu float-end"
                    aria-labelledby="navbarDropdown"
                  >
                    <a class="dropdown-item" href="login.html"
                      ><i class="fas fa-sign-out-alt float-end"></i> Log Out</a>
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top nav -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left"><h3>Nautobot Dashboard</h3></div>
              <div class="title_right">
                <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right">
                  <button
                    id="refresh-dashboard"
                    class="btn btn-primary btn-sm"
                    onclick="dashboard.refreshData()"
                  >
                    <i class="fas fa-sync-alt"></i> Refresh Data
                  </button>
                  <small
                    id="cache-indicator"
                    class="text-muted"
                    style="margin-left: 10px; font-size: 11px"
                  ></small>
                </div>
              </div>
            </div>
            <div class="clearfix"></div>

            <!-- Nautobot metrics tiles -->
            <div class="row">
              <div
                class="tile_count"
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 20px;
                  margin-bottom: 30px;
                  width: 100%;
                "
              >
                <div
                  class="col-md-2 col-sm-4 col-xs-6 tile_stats_count"
                  style="
                    flex: 1;
                    min-width: 200px;
                    height: 120px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    background: #fff;
                    border: 1px solid #e6e9ed;
                    border-radius: 5px;
                    padding: 15px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
                  "
                >
                  <span
                    class="count_top"
                    style="
                      display: flex;
                      align-items: center;
                      margin-bottom: 8px;
                    "
                  >
                    <i
                      class="fas fa-server"
                      style="
                        color: #3498db;
                        font-size: 32px;
                        margin-right: 12px;
                      "
                    ></i>
                    <div>
                      <div
                        id="devices-count"
                        class="count"
                        style="
                          font-size: 24px;
                          font-weight: bold;
                          color: #34495e;
                          line-height: 1;
                        "
                      >
                        -
                      </div>
                      <span
                        class="count_bottom"
                        style="
                          font-size: 12px;
                          color: #7f8c8d;
                          text-transform: uppercase;
                        "
                        >Total Devices</span
                      >
                    </div>
                  </span>
                </div>
                <div
                  class="col-md-2 col-sm-4 col-xs-6 tile_stats_count"
                  style="
                    flex: 1;
                    min-width: 200px;
                    height: 120px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    background: #fff;
                    border: 1px solid #e6e9ed;
                    border-radius: 5px;
                    padding: 15px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
                  "
                >
                  <span
                    class="count_top"
                    style="
                      display: flex;
                      align-items: center;
                      margin-bottom: 8px;
                    "
                  >
                    <i
                      class="fas fa-map-marker-alt"
                      style="
                        color: #2ecc71;
                        font-size: 32px;
                        margin-right: 12px;
                      "
                    ></i>
                    <div>
                      <div
                        id="locations-count"
                        class="count"
                        style="
                          font-size: 24px;
                          font-weight: bold;
                          color: #34495e;
                          line-height: 1;
                        "
                      >
                        -
                      </div>
                      <span
                        class="count_bottom"
                        style="
                          font-size: 12px;
                          color: #7f8c8d;
                          text-transform: uppercase;
                        "
                        >Total Locations</span
                      >
                    </div>
                  </span>
                </div>
                <div
                  class="col-md-2 col-sm-4 col-xs-6 tile_stats_count"
                  style="
                    flex: 1;
                    min-width: 200px;
                    height: 120px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    background: #fff;
                    border: 1px solid #e6e9ed;
                    border-radius: 5px;
                    padding: 15px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
                  "
                >
                  <span
                    class="count_top"
                    style="
                      display: flex;
                      align-items: center;
                      margin-bottom: 8px;
                    "
                  >
                    <i
                      class="fas fa-network-wired"
                      style="
                        color: #f39c12;
                        font-size: 32px;
                        margin-right: 12px;
                      "
                    ></i>
                    <div>
                      <div
                        id="ip-addresses-count"
                        class="count"
                        style="
                          font-size: 24px;
                          font-weight: bold;
                          color: #34495e;
                          line-height: 1;
                        "
                      >
                        -
                      </div>
                      <span
                        class="count_bottom"
                        style="
                          font-size: 12px;
                          color: #7f8c8d;
                          text-transform: uppercase;
                        "
                        >IP Addresses</span
                      >
                    </div>
                  </span>
                </div>
                <div
                  class="col-md-2 col-sm-4 col-xs-6 tile_stats_count"
                  style="
                    flex: 1;
                    min-width: 200px;
                    height: 120px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    background: #fff;
                    border: 1px solid #e6e9ed;
                    border-radius: 5px;
                    padding: 15px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
                  "
                >
                  <span
                    class="count_top"
                    style="
                      display: flex;
                      align-items: center;
                      margin-bottom: 8px;
                    "
                  >
                    <i
                      class="fas fa-sitemap"
                      style="
                        color: #9b59b6;
                        font-size: 32px;
                        margin-right: 12px;
                      "
                    ></i>
                    <div>
                      <div
                        id="prefixes-count"
                        class="count"
                        style="
                          font-size: 24px;
                          font-weight: bold;
                          color: #34495e;
                          line-height: 1;
                        "
                      >
                        -
                      </div>
                      <span
                        class="count_bottom"
                        style="
                          font-size: 12px;
                          color: #7f8c8d;
                          text-transform: uppercase;
                        "
                        >Total Prefixes</span
                      >
                    </div>
                  </span>
                </div>
              </div>
            </div>

            <!-- status message -->
            <div class="row">
              <div class="col-md-12">
                <div
                  id="status-message"
                  class="alert alert-info"
                  style="display: none"
                >
                  Loading dashboard data...
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->
      </div>
    </div>

    <style>
      .current-page {
        background-color: #2a3f54 !important;
        color: #fff !important;
        border-radius: 3px;
      }
      .current-page:hover {
        background-color: #1e2b3a !important;
      }
      .x_panel {
        background: #fff;
        border: 1px solid #e6e9ed;
        border-radius: 3px;
        box-shadow:
          0 1px 3px rgba(0, 0, 0, 0.12),
          0 1px 2px rgba(0, 0, 0, 0.24);
        margin-bottom: 25px;
        transition: box-shadow 0.3s ease;
      }
      .x_panel:hover {
        box-shadow:
          0 3px 6px rgba(0, 0, 0, 0.16),
          0 3px 6px rgba(0, 0, 0, 0.23);
      }
      .progress {
        height: 4px;
        margin-bottom: 0;
      }
      .loading {
        animation: pulse 1.5s ease-in-out infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>

    <script>
      class Dashboard {
        constructor() {
          this.init();
        }
        init() {
          if (!window.authManager) {
            setTimeout(() => this.init(), 100);
            return;
          }
          this.loadDashboardData();
          this.updateUserInfo();
        }
        async loadDashboardData() {
          const cached = this.getCachedStats();
          if (cached) {
            this.updateDashboardCards(cached);
            return;
          }
          this.showStatus("Loading dashboard statistics...", "info");
          this.setLoadingState(true);
          this.updateCacheIndicator("üîÑ Loading fresh data...");
          try {
            const relativePath =
              window.CockpitConfig.api.endpoints.nautobot.stats.replace(
                window.CockpitConfig.api.baseUrl,
                "",
              );
            const stats = await window.authManager.apiRequest(relativePath);
            this.updateDashboardCards(stats);
            this.cacheStats(stats);
            this.setLoadingState(false);
            this.hideStatus();
          } catch (e) {
            this.showStatus(
              "Failed to load dashboard data. Please refresh the page.",
              "danger",
            );
            this.updateCacheIndicator("‚ùå Failed to load data");
            this.setLoadingState(false);
          }
        }
        getCachedStats() {
          try {
            const cached = localStorage.getItem("cockpit_dashboard_stats");
            if (!cached) return null;
            const data = JSON.parse(cached);
            const cacheTime = new Date(data.cacheTimestamp);
            const now = new Date();
            const ageMin = (now - cacheTime) / (1000 * 60);
            if (ageMin < 10) {
              const rem = Math.ceil(10 - ageMin);
              this.updateCacheIndicator(`üìÅ Cached data (expires in ${rem}m)`);
              return data.stats;
            } else {
              localStorage.removeItem("cockpit_dashboard_stats");
              return null;
            }
          } catch (e) {
            localStorage.removeItem("cockpit_dashboard_stats");
            return null;
          }
        }
        cacheStats(stats) {
          try {
            localStorage.setItem(
              "cockpit_dashboard_stats",
              JSON.stringify({
                stats,
                cacheTimestamp: new Date().toISOString(),
              }),
            );
            this.updateCacheIndicator("üìÅ Cached data (expires in 10m)");
          } catch (e) {}
        }
        updateDashboardCards(stats) {
          document.getElementById("devices-count").textContent =
            stats.devices || 0;
          document.getElementById("locations-count").textContent =
            stats.locations || 0;
          document.getElementById("ip-addresses-count").textContent =
            stats.ip_addresses || 0;
          document.getElementById("prefixes-count").textContent =
            stats.prefixes || 0;
        }
        refreshData() {
          localStorage.removeItem("cockpit_dashboard_stats");
          this.updateCacheIndicator("");
          this.loadDashboardData();
        }
        updateCacheIndicator(message) {
          const el = document.getElementById("cache-indicator");
          if (el) {
            el.textContent = message;
          }
        }
        updateUserInfo() {
          const sidebarUsername = document.getElementById("sidebar-username");
          const navbarUsername = document.getElementById("navbar-username");
          const userInfo = localStorage.getItem("user_info");
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              const name = user.full_name || user.username || "User";
              if (sidebarUsername) sidebarUsername.textContent = name;
              if (navbarUsername) navbarUsername.textContent = name;
            } catch (e) {}
          }
        }
        setLoadingState(loading) {
          const cards = document.querySelectorAll(".x_panel");
          cards.forEach((card) => {
            loading
              ? card.classList.add("loading")
              : card.classList.remove("loading");
          });
        }
        showStatus(message, type = "info") {
          const el = document.getElementById("status-message");
          el.className = `alert alert-${type}`;
          el.textContent = message;
          el.style.display = "block";
        }
        hideStatus() {
          const el = document.getElementById("status-message");
          el.style.display = "none";
        }
      }
      document.addEventListener("DOMContentLoaded", function () {
        window.dashboard = new Dashboard();
      });
    </script>
  </body>
</html>
