<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Scan & Add | Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    
    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- Container configuration (if in container mode) -->
    <script>
      // Load container config if in container environment
      // But NOT if we're running on Vite dev server ports (development mode)
      const currentPort = window.location.port;
      const isDevelopment = currentPort === '3000' || currentPort === '3001';
      const isNonLocalhost = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
      
      if (isNonLocalhost && !isDevelopment) {
        const script = document.createElement('script');
        script.src = 'js/config-container.js';
        document.head.appendChild(script);
      }
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><i class="fas fa-paw"></i> <span>Cockpit!</span></a>
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
              </div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="nav-username">Loading...</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                  <li><a><i class="fas fa-rocket"></i> Onboarding <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu" style="display:block;">
                      <li><a href="onboard-device.html"><i class="fas fa-plus-circle"></i> Onboard Device</a></li>
                      <li><a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a></li>
                      <li><a href="scan-and-add.html" class="current-page"><i class="fas fa-search-plus"></i> Scan & Add</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-cogs"></i> Configs <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="backup.html"><i class="fas fa-save"></i> Backup</a></li>
                      <li><a href="compare.html"><i class="fas fa-exchange-alt"></i> Compare</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-cogs"></i> Ansible <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="ansible-inventory.html"><i class="fas fa-list"></i> Inventory</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-wrench"></i> Settings <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a></li>
                      <li><a href="settings-templates.html"><i class="fas fa-file-code"></i> Templates</a></li>
                      <li><a href="settings-git.html"><i class="fab fa-git-alt"></i> Git Management</a></li>
                      <li><a href="settings-cache.html"><i class="fas fa-bolt"></i> Cache</a></li>
                      <li><a href="settings-credentials.html"><i class="fas fa-key"></i> Credentials</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a href="settings-nautobot.html" data-bs-toggle="tooltip" data-bs-placement="top" title="Settings">
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px;">
                  <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false">
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <div class="dropdown-menu dropdown-usermenu pull-right" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="login.html"><i class="fas fa-sign-out-alt pull-right"></i> Log Out</a>
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2><i class="fa fa-search-plus"></i> Scan & Add Network Devices</h2>
                    <div class="clearfix"></div>
                  </div>

                  <div class="x_content">
                    <!-- Progress Steps -->
                    <div class="step-indicator mb-4">
                      <div class="step-container">
                        <div class="step active" id="step1-indicator">
                          <div class="step-number">1</div>
                          <div class="step-title">Network Scanning</div>
                        </div>
                        <div class="step-divider"></div>
                        <div class="step" id="step2-indicator">
                          <div class="step-number">2</div>
                          <div class="step-title">Device Onboarding</div>
                        </div>
                      </div>
                    </div>

                    <!-- Step 1: Network Scanning -->
                    <div id="step1-content" class="step-content">
                      <div class="col-md-8 col-sm-12 col-xs-12">
                        <h3>Network Discovery Configuration</h3>
                        <p class="text-muted">Scan network ranges to discover devices and test credentials.</p>

                        <form id="scan-form">
                          <!-- Network Ranges -->
                          <div class="form-group">
                            <label class="control-label">Network Ranges (CIDR)</label>
                            <small class="help-block">Maximum /22 networks (up to ~1024 hosts). Up to 10 ranges.</small>
                            <div id="cidrs-container">
                              <div class="cidr-input-group">
                                <div class="input-group">
                                  <input type="text" class="form-control cidr-input" 
                                         placeholder="192.168.1.0/24" 
                                         pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$">
                                  <span class="input-group-btn">
                                    <button class="btn btn-danger remove-cidr" type="button" style="display:none;">
                                      <i class="fa fa-minus"></i>
                                    </button>
                                    <button class="btn btn-primary add-cidr" type="button">
                                      <i class="fa fa-plus"></i>
                                    </button>
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Credentials Selection -->
                          <div class="form-group">
                            <label class="control-label">Authentication Credentials</label>
                            <small class="help-block">Select credentials to test against discovered devices.</small>
                            <div id="credentials-container">
                              <div class="credential-select-group">
                                <div class="input-group">
                                  <select class="form-control credential-select" required>
                                    <option value="">Select credentials...</option>
                                  </select>
                                  <span class="input-group-btn">
                                    <button class="btn btn-danger remove-credential" type="button" style="display:none;">
                                      <i class="fa fa-minus"></i>
                                    </button>
                                    <button class="btn btn-primary add-credential" type="button">
                                      <i class="fa fa-plus"></i>
                                    </button>
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Network Discovery Configuration -->
                          <div class="form-group">
                            <label class="control-label">Network Discovery Configuration</label>
                            <small class="help-block">Choose the method for device authentication and detection.</small>
                            <select class="form-control" id="discovery-mode" required>
                              <option value="napalm">Napalm (Default - Full device detection with platform identification)</option>
                              <option value="ssh-login">SSH Login (Command-based device detection)</option>
                            </select>
                            <div class="help-block" style="margin-top: 8px;">
                              <strong>Napalm:</strong> Attempts Cisco (ios/nxos/iosxr) and Linux detection with full platform details.<br>
                              <strong>SSH Login:</strong> SSH connectivity with basic device detection using 'show version' (Cisco) and 'uname -a' (Linux) commands.
                            </div>
                          </div>

                          <!-- Scan Actions -->
                          <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg" id="start-scan-btn">
                              <i class="fa fa-search"></i> Start Network Scan
                            </button>
                          </div>
                        </form>
                      </div>

                      <!-- Scan Progress Sidebar -->
                      <div class="col-md-4 col-sm-12 col-xs-12">
                        <div id="scan-progress" style="display:none;">
                          <div class="x_panel">
                            <div class="x_title">
                              <h2><i class="fa fa-pulse fa-spinner"></i> Scan Progress</h2>
                              <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                              <div class="progress-stats">
                                <div class="stat-item">
                                  <strong>Job ID:</strong> <span id="job-id">-</span>
                                </div>
                                <div class="stat-item">
                                  <strong>Status:</strong> <span id="scan-status">-</span>
                                </div>
                                <div class="stat-item">
                                  <strong>Progress:</strong> 
                                  <div class="progress">
                                    <div class="progress-bar" id="scan-progress-bar" style="width: 0%"></div>
                                  </div>
                                  <small><span id="scan-progress-text">0 / 0</span></small>
                                </div>
                              </div>

                              <div class="scan-metrics">
                                <table class="table table-condensed">
                                  <tbody>
                                    <tr>
                                      <td><i class="fa fa-check text-success"></i> Alive</td>
                                      <td><span id="metric-alive">0</span></td>
                                    </tr>
                                    <tr>
                                      <td><i class="fa fa-key text-info"></i> Authenticated</td>
                                      <td><span id="metric-authenticated">0</span></td>
                                    </tr>
                                    <tr>
                                      <td><i class="fa fa-times text-danger"></i> Unreachable</td>
                                      <td><span id="metric-unreachable">0</span></td>
                                    </tr>
                                    <tr>
                                      <td><i class="fa fa-exclamation text-warning"></i> Auth Failed</td>
                                      <td><span id="metric-auth-failed">0</span></td>
                                    </tr>
                                    <tr>
                                      <td><i class="fa fa-question text-muted"></i> Driver N/A</td>
                                      <td><span id="metric-driver-na">0</span></td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Step 2: Device Onboarding -->
                    <div id="step2-content" class="step-content" style="display:none;">
                      <div class="row">
                        <div class="col-md-12">
                          <h3>Device Onboarding</h3>
                          <p class="text-muted">Configure and onboard discovered devices.</p>

                          <!-- Device Results Table -->
                          <div class="table-responsive">
                            <table id="devices-table" class="table table-striped table-bordered">
                              <thead>
                                <tr>
                                  <th width="40"><input type="checkbox" id="select-all-devices"></th>
                                  <th>IP Address</th>
                                  <th>Hostname</th>
                                  <th>Device Type</th>
                                  <th>Platform</th>
                                  <th>Credential</th>
                                  <th width="120">Actions</th>
                                </tr>
                              </thead>
                              <tbody id="devices-tbody">
                                <!-- Populated by JavaScript -->
                              </tbody>
                            </table>
                          </div>

                          <!-- Onboarding Actions -->
                          <div class="form-actions">
                            <button type="button" class="btn btn-success btn-lg" id="onboard-selected-btn" disabled>
                              <i class="fa fa-upload"></i> Onboard Selected Devices
                            </button>
                            <button type="button" class="btn btn-default" id="back-to-scan-btn">
                              <i class="fa fa-arrow-left"></i> Back to Scanning
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Device Metadata Modal -->
                    <div class="modal" id="device-metadata-modal" tabindex="-1" role="dialog" aria-labelledby="device-metadata-modal-label" aria-hidden="true">
                      <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h4 class="modal-title" id="device-metadata-modal-label">Device Configuration</h4>
                            <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <form id="device-metadata-form">
                              <input type="hidden" id="device-ip">
                              
                              <div class="row">
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label>IP Address</label>
                                    <input type="text" class="form-control" id="device-ip-display" readonly>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Hostname</label>
                                    <input type="text" class="form-control" id="device-hostname" 
                                           placeholder="Auto-detected or custom">
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Platform</label>
                                    <input type="text" class="form-control" id="device-platform" 
                                           placeholder="cisco_ios, cisco_nxos, linux">
                                  </div>

                                  <div class="form-group">
                                    <label>Device Type</label>
                                    <select class="form-control" id="device-type" readonly>
                                      <option value="cisco">Cisco Device</option>
                                      <option value="linux">Linux Server</option>
                                      <option value="unknown">Unknown Device</option>
                                    </select>
                                  </div>
                                </div>

                                <!-- Cisco-specific fields -->
                                <div class="col-md-6" id="cisco-fields">
                                  <div class="form-group">
                                    <label>Location</label>
                                    <input type="text" class="form-control" id="device-location" 
                                           placeholder="Building/Room/Rack">
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Namespace</label>
                                    <select class="form-control" id="device-namespace">
                                      <option value="Global">Global</option>
                                    </select>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Role</label>
                                    <select class="form-control" id="device-role">
                                      <option value="">Select role...</option>
                                      <option value="access-switch">Access Switch</option>
                                      <option value="distribution-switch">Distribution Switch</option>
                                      <option value="core-switch">Core Switch</option>
                                      <option value="router">Router</option>
                                      <option value="firewall">Firewall</option>
                                      <option value="wireless-controller">Wireless Controller</option>
                                    </select>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-control" id="device-status">
                                      <option value="Active">Active</option>
                                      <option value="Planned">Planned</option>
                                      <option value="Maintenance">Maintenance</option>
                                      <option value="Decommissioned">Decommissioned</option>
                                    </select>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Interface Status</label>
                                    <select class="form-control" id="device-interface-status">
                                      <option value="Active">Active</option>
                                      <option value="Deprecated">Deprecated</option>
                                    </select>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>IP Status</label>
                                    <select class="form-control" id="device-ip-status">
                                      <option value="Active">Active</option>
                                      <option value="Reserved">Reserved</option>
                                      <option value="Deprecated">Deprecated</option>
                                    </select>
                                  </div>
                                </div>

                                <!-- Linux-specific fields -->
                                <div class="col-md-6" id="linux-fields" style="display:none;">
                                  <div class="form-group">
                                    <label>Server Role</label>
                                    <select class="form-control" id="linux-role">
                                      <option value="server">Server</option>
                                      <option value="web-server">Web Server</option>
                                      <option value="database-server">Database Server</option>
                                      <option value="application-server">Application Server</option>
                                      <option value="monitoring-server">Monitoring Server</option>
                                    </select>
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Location</label>
                                    <input type="text" class="form-control" id="linux-location" 
                                           placeholder="Datacenter/Rack">
                                  </div>
                                  
                                  <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-control" id="linux-status">
                                      <option value="Active">Active</option>
                                      <option value="Planned">Planned</option>
                                      <option value="Maintenance">Maintenance</option>
                                      <option value="Decommissioned">Decommissioned</option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-bs-dismiss="modal" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="save-device-metadata">Save Configuration</button>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="pull-right">
            Cockpit Network Management Dashboard
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
      </div>
    </div>

    <!-- Authentication check -->
    <script>
      if (!localStorage.getItem('auth_token')) {
        window.location.href = 'login.html';
      }
    </script>

    <!-- Auth Manager -->
    <script src="js/auth.js"></script>
    <style>
      .step-indicator {
        margin-bottom: 30px;
      }
      
      .step-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
      }
      
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-width: 120px;
      }
      
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        border: 2px solid #e9ecef;
      }
      
      .step.active .step-number {
        background-color: #337ab7;
        color: white;
        border-color: #337ab7;
      }
      
      .step-title {
        font-size: 14px;
        color: #6c757d;
        font-weight: 500;
      }
      
      .step.active .step-title {
        color: #337ab7;
        font-weight: bold;
      }
      
      .step-divider {
        width: 100px;
        height: 2px;
        background-color: #e9ecef;
        margin: 0 20px;
      }
      
      .cidr-input-group, .credential-select-group {
        margin-bottom: 10px;
      }
      
      .progress-stats .stat-item {
        margin-bottom: 10px;
      }
      
      .scan-metrics {
        margin-top: 20px;
      }
      
      .device-config-btn {
        margin-right: 5px;
      }
      
      #cisco-fields, #linux-fields {
        border-left: 3px solid #337ab7;
        padding-left: 15px;
      }
      
      /* Modal styling fixes */
      .modal {
        z-index: 1050;
      }
      
      .modal-backdrop {
        z-index: 1040;
      }
      
      .modal.show {
        display: block !important;
      }
      
      .modal-backdrop.show {
        opacity: 0.5;
      }
      
      /* Ensure modal is properly centered */
      .modal-dialog {
        margin: 30px auto;
      }
      
      /* Fix modal content visibility and force hardware acceleration */
      .modal-content {
        background-color: #fff;
        border: 1px solid rgba(0,0,0,.2);
        border-radius: 6px;
        box-shadow: 0 3px 9px rgba(0,0,0,.5);
        transform: translateZ(0);
        backface-visibility: hidden;
        will-change: opacity, transform;
      }
      
      /* Disable modal fade transition to prevent gray screen */
      .modal.fade .modal-dialog {
        transition: none !important;
        transform: none !important;
      }
      
      /* Force immediate visibility */
      .modal.show .modal-content {
        opacity: 1 !important;
        visibility: visible !important;
      }
    </style>

    <script>
      // Authentication Manager Integration
      let authManager;
      let credentialsData = [];
      let scanJob = null;
      let discoveredDevices = [];
      let deviceMetadata = {};

      // Initialize when auth manager is ready
      window.addEventListener('load', async () => {
        if (window.authManager) {
          authManager = window.authManager;
          await initializePage();
        } else {
          setTimeout(async () => {
            authManager = window.authManager;
            await initializePage();
          }, 100);
        }
      });

      async function initializePage() {
        // Set username in navigation (like other pages)
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const username = userInfo.username || 'User';
        document.getElementById('nav-username').textContent = username;
        const navbarUsername = document.getElementById('navbar-username');
        if (navbarUsername) navbarUsername.textContent = username;

        // Load available credentials
        await loadCredentials();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize button visibility
        updateRemoveButtons();
        updateCredentialRemoveButtons();
      }

      async function loadCredentials() {
        try {
          const response = await authManager.apiRequest('/api/credentials/');
          if (response && Array.isArray(response)) {
            credentialsData = response;
            updateCredentialSelects();
          }
        } catch (error) {
          console.error('Failed to load credentials:', error);
          showAlert('Failed to load credentials. Please check your connection.', 'danger');
        }
      }

      function populateCredentialSelect(select) {
        // Clear existing options except first
        const firstOption = select.querySelector('option[value=""]');
        select.innerHTML = '';
        if (firstOption) select.appendChild(firstOption);
        
        // Add credential options
        credentialsData.forEach(cred => {
          const option = document.createElement('option');
          option.value = cred.id;
          option.textContent = `${cred.name} (${cred.username})`;
          select.appendChild(option);
        });
      }

      function updateCredentialSelects() {
        const selects = document.querySelectorAll('.credential-select');
        selects.forEach(select => {
          // Store current selected value
          const currentValue = select.value;
          
          // Populate the select
          populateCredentialSelect(select);
          
          // Restore selected value if it still exists
          if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
            select.value = currentValue;
          }
        });
      }

      function setupEventListeners() {
        // CIDR management - use event delegation for dynamic buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('add-cidr') || e.target.parentElement.classList.contains('add-cidr')) {
            addCidrInput();
          }
          if (e.target.classList.contains('remove-cidr') || e.target.parentElement.classList.contains('remove-cidr')) {
            removeCidrInput(e.target.closest('button'));
          }
        });

        // Credential management - use event delegation for dynamic buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('add-credential') || e.target.parentElement.classList.contains('add-credential')) {
            addCredentialSelect();
          }
          if (e.target.classList.contains('remove-credential') || e.target.parentElement.classList.contains('remove-credential')) {
            removeCredentialSelect(e.target.closest('button'));
          }
        });

        // Form submission
        document.getElementById('scan-form').addEventListener('submit', startScan);

        // Step navigation
        document.getElementById('back-to-scan-btn').addEventListener('click', () => showStep(1));
        
        // Device selection
        document.getElementById('select-all-devices').addEventListener('change', toggleAllDevices);
        
        // Onboarding
        document.getElementById('onboard-selected-btn').addEventListener('click', onboardSelectedDevices);
        
        // Device metadata modal
        document.getElementById('save-device-metadata').addEventListener('click', saveDeviceMetadata);
        document.getElementById('device-type').addEventListener('change', toggleDeviceFields);
      }

      function addCidrInput() {
        const container = document.getElementById('cidrs-container');
        const groups = container.querySelectorAll('.cidr-input-group');
        
        if (groups.length >= 10) {
          showAlert('Maximum 10 network ranges allowed.', 'warning');
          return;
        }

        const newGroup = document.createElement('div');
        newGroup.className = 'cidr-input-group';
        newGroup.innerHTML = `
          <div class="input-group">
            <input type="text" class="form-control cidr-input" 
                   placeholder="192.168.1.0/24" 
                   pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$">
            <span class="input-group-btn">
              <button class="btn btn-danger remove-cidr" type="button">
                <i class="fa fa-minus"></i>
              </button>
              <button class="btn btn-primary add-cidr" type="button">
                <i class="fa fa-plus"></i>
              </button>
            </span>
          </div>
        `;
        
        container.appendChild(newGroup);
        updateRemoveButtons();
      }

      function removeCidrInput(button) {
        const group = button.closest('.cidr-input-group');
        group.remove();
        updateRemoveButtons();
      }

      function updateRemoveButtons() {
        const groups = document.querySelectorAll('.cidr-input-group');
        groups.forEach((group, index) => {
          const removeBtn = group.querySelector('.remove-cidr');
          const addBtn = group.querySelector('.add-cidr');
          
          // Show remove button only if more than one group
          removeBtn.style.display = groups.length > 1 ? 'inline-block' : 'none';
          
          // Show add button only on the last group
          addBtn.style.display = index === groups.length - 1 ? 'inline-block' : 'none';
        });
      }

      function addCredentialSelect() {
        const container = document.getElementById('credentials-container');
        const groups = container.querySelectorAll('.credential-select-group');
        
        if (groups.length >= credentialsData.length) {
          showAlert('All available credentials already selected.', 'warning');
          return;
        }

        const newGroup = document.createElement('div');
        newGroup.className = 'credential-select-group';
        newGroup.innerHTML = `
          <div class="input-group">
            <select class="form-control credential-select" required>
              <option value="">Select credentials...</option>
            </select>
            <span class="input-group-btn">
              <button class="btn btn-danger remove-credential" type="button">
                <i class="fa fa-minus"></i>
              </button>
              <button class="btn btn-primary add-credential" type="button">
                <i class="fa fa-plus"></i>
              </button>
            </span>
          </div>
        `;
        
        container.appendChild(newGroup);
        
        // Populate only the new credential select dropdown
        const newSelect = newGroup.querySelector('.credential-select');
        populateCredentialSelect(newSelect);
        
        updateCredentialRemoveButtons();
      }

      function removeCredentialSelect(button) {
        const group = button.closest('.credential-select-group');
        group.remove();
        updateCredentialRemoveButtons();
      }

      function updateCredentialRemoveButtons() {
        const groups = document.querySelectorAll('.credential-select-group');
        groups.forEach((group, index) => {
          const removeBtn = group.querySelector('.remove-credential');
          const addBtn = group.querySelector('.add-credential');
          
          // Show remove button only if more than one group
          removeBtn.style.display = groups.length > 1 ? 'inline-block' : 'none';
          
          // Show add button only on the last group
          addBtn.style.display = index === groups.length - 1 ? 'inline-block' : 'none';
        });
      }

      async function startScan(e) {
        e.preventDefault();
        
        // Collect and validate CIDR inputs
        const cidrInputs = document.querySelectorAll('.cidr-input');
        const cidrs = Array.from(cidrInputs)
          .map(input => input.value.trim())
          .filter(cidr => cidr);
        
        if (cidrs.length === 0) {
          showAlert('Please enter at least one network range.', 'warning');
          return;
        }

        // Validate CIDR format
        for (const cidr of cidrs) {
          if (!isValidCIDR(cidr)) {
            showAlert(`Invalid CIDR format: ${cidr}`, 'danger');
            return;
          }
        }

        // Collect and validate credentials
        const credentialSelects = document.querySelectorAll('.credential-select');
        const credentialIds = Array.from(credentialSelects)
          .map(select => parseInt(select.value))
          .filter(id => !isNaN(id));
        
        if (credentialIds.length === 0) {
          showAlert('Please select at least one credential.', 'warning');
          return;
        }

        // Check for duplicate credentials
        const uniqueCredentials = [...new Set(credentialIds)];
        if (uniqueCredentials.length !== credentialIds.length) {
          showAlert('Duplicate credentials selected. Please choose unique credentials.', 'warning');
          return;
        }

        // Get discovery mode
        const discoveryMode = document.getElementById('discovery-mode').value;
        if (!discoveryMode) {
          showAlert('Please select a discovery mode.', 'warning');
          return;
        }

        try {
          // Disable form and show progress
          document.getElementById('start-scan-btn').disabled = true;
          document.getElementById('scan-progress').style.display = 'block';

          // Start scan
          const response = await authManager.apiRequest('/api/scan/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cidrs: cidrs,
              credential_ids: uniqueCredentials,
              discovery_mode: discoveryMode
            })
          });

          scanJob = response;
          document.getElementById('job-id').textContent = response.job_id;
          document.getElementById('scan-status').textContent = response.state;

          // Start polling for progress
          pollScanProgress();

        } catch (error) {
          console.error('Failed to start scan:', error);
          showAlert('Failed to start network scan. Please try again.', 'danger');
          document.getElementById('start-scan-btn').disabled = false;
          document.getElementById('scan-progress').style.display = 'none';
        }
      }

      async function pollScanProgress() {
        if (!scanJob) return;

        try {
          const response = await authManager.apiRequest(`/api/scan/${scanJob.job_id}/status`);
          
          // Update progress display
          updateProgressDisplay(response);
          
          // Check if scan completed
          if (response.state === 'finished') {
            discoveredDevices = response.results;
            showAlert('Network scan completed!', 'success');
            populateDevicesTable();
            showStep(2);
          } else if (response.state === 'failed') {
            showAlert('Network scan failed. Please try again.', 'danger');
            resetScanForm();
          } else {
            // Continue polling
            setTimeout(pollScanProgress, 2000);
          }

        } catch (error) {
          console.error('Failed to get scan status:', error);
          showAlert('Lost connection to scan job. Please refresh the page.', 'danger');
          resetScanForm();
        }
      }

      function updateProgressDisplay(status) {
        const progress = status.progress;
        
        // Update progress bar
        const percentage = progress.total > 0 ? (progress.scanned / progress.total * 100) : 0;
        document.getElementById('scan-progress-bar').style.width = `${percentage}%`;
        document.getElementById('scan-progress-text').textContent = `${progress.scanned} / ${progress.total}`;
        
        // Update metrics
        document.getElementById('metric-alive').textContent = progress.alive;
        document.getElementById('metric-authenticated').textContent = progress.authenticated;
        document.getElementById('metric-unreachable').textContent = progress.unreachable;
        document.getElementById('metric-auth-failed').textContent = progress.auth_failed;
        document.getElementById('metric-driver-na').textContent = progress.driver_not_supported;
        
        // Update status
        document.getElementById('scan-status').textContent = status.state;
      }

      function populateDevicesTable() {
        const tbody = document.getElementById('devices-tbody');
        tbody.innerHTML = '';

        discoveredDevices.forEach((device, index) => {
          const credential = credentialsData.find(c => c.id === device.credential_id);
          const credentialName = credential ? credential.name : 'Unknown';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="checkbox" class="device-checkbox" data-ip="${device.ip}"></td>
            <td>${device.ip}</td>
            <td>${device.hostname || 'Unknown'}</td>
            <td>${device.device_type}</td>
            <td>${device.platform || 'Unknown'}</td>
            <td>${credentialName}</td>
            <td>
              <button class="btn btn-sm btn-info device-config-btn" onclick="editDeviceMetadata('${device.ip}')">
                <i class="fa fa-edit"></i> Configure
              </button>
            </td>
          `;
          tbody.appendChild(row);

          // Initialize device metadata with scan results
          deviceMetadata[device.ip] = {
            ...device,
            namespace: 'Global',
            role: device.device_type === 'cisco' ? 'access-switch' : device.device_type === 'linux' ? 'server' : 'unknown',
            status: 'Active',
            interface_status: 'Active',
            ip_status: 'Active'
          };
        });

        // Update onboard button state
        updateOnboardButton();
        
        // Setup device checkbox listeners
        document.querySelectorAll('.device-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', updateOnboardButton);
        });
      }

      function showStep(stepNumber) {
        // Update step indicators
        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        document.getElementById(`step${stepNumber}-indicator`).classList.add('active');

        // Show/hide step content
        document.querySelectorAll('.step-content').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(`step${stepNumber}-content`).style.display = 'block';

        if (stepNumber === 1) {
          resetScanForm();
        }
      }

      function resetScanForm() {
        document.getElementById('start-scan-btn').disabled = false;
        document.getElementById('scan-progress').style.display = 'none';
        scanJob = null;
        discoveredDevices = [];
        deviceMetadata = {};
      }

      function toggleAllDevices() {
        const selectAll = document.getElementById('select-all-devices');
        const checkboxes = document.querySelectorAll('.device-checkbox');
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll.checked;
        });
        
        updateOnboardButton();
      }

      function updateOnboardButton() {
        const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
        const onboardBtn = document.getElementById('onboard-selected-btn');
        onboardBtn.disabled = checkedBoxes.length === 0;
      }

      function editDeviceMetadata(ip) {
        console.log('editDeviceMetadata called for IP:', ip);
        const device = deviceMetadata[ip];
        if (!device) {
          console.error('No device metadata found for IP:', ip);
          return;
        }

        console.log('Device data:', device);

        // Populate modal with device data
        document.getElementById('device-ip').value = ip;
        document.getElementById('device-ip-display').value = ip;
        document.getElementById('device-hostname').value = device.hostname || '';
        document.getElementById('device-platform').value = device.platform || '';
        document.getElementById('device-type').value = device.device_type;

        // Show appropriate fields
        toggleDeviceFields();

        if (device.device_type === 'cisco') {
          document.getElementById('device-location').value = device.location || '';
          document.getElementById('device-namespace').value = device.namespace || 'Global';
          document.getElementById('device-role').value = device.role || '';
          document.getElementById('device-status').value = device.status || 'Active';
          document.getElementById('device-interface-status').value = device.interface_status || 'Active';
          document.getElementById('device-ip-status').value = device.ip_status || 'Active';
        } else if (device.device_type === 'linux') {
          document.getElementById('linux-role').value = device.role || 'server';
          document.getElementById('linux-location').value = device.location || '';
          document.getElementById('linux-status').value = device.status || 'Active';
        } else if (device.device_type === 'unknown') {
          // For unknown devices, no specific fields to initialize
          // They only have the common hostname and platform fields
        }

        // Show modal using Bootstrap 5
        const modal = document.getElementById('device-metadata-modal');
        console.log('Modal element:', modal);
        
        try {
          // Force layout recalculation before showing modal
          modal.offsetHeight;
          
          const modalInstance = new bootstrap.Modal(modal, {
            backdrop: true,
            keyboard: true,
            focus: true
          });
          
          // Show modal and force immediate rendering
          modalInstance.show();
          
          // Force repaint to avoid gray screen issue
          setTimeout(() => {
            modal.style.transform = 'translateZ(0)';
            modal.querySelector('.modal-content').style.opacity = '1';
            modal.querySelector('.modal-content').style.transform = 'translateZ(0)';
          }, 10);
          
          console.log('Bootstrap 5 Modal shown successfully');
        } catch (error) {
          console.error('Error showing modal:', error);
          showAlert('Error opening device configuration dialog.', 'danger');
        }
      }

      function toggleDeviceFields() {
        const deviceType = document.getElementById('device-type').value;
        const ciscoFields = document.getElementById('cisco-fields');
        const linuxFields = document.getElementById('linux-fields');

        if (deviceType === 'cisco') {
          ciscoFields.style.display = 'block';
          linuxFields.style.display = 'none';
        } else if (deviceType === 'linux') {
          ciscoFields.style.display = 'none';
          linuxFields.style.display = 'block';
        } else if (deviceType === 'unknown') {
          // For unknown devices, hide both device-specific fields
          ciscoFields.style.display = 'none';
          linuxFields.style.display = 'none';
        }
      }

      function saveDeviceMetadata() {
        const ip = document.getElementById('device-ip').value;
        const deviceType = document.getElementById('device-type').value;

        if (!deviceMetadata[ip]) return;

        // Update common fields
        deviceMetadata[ip].hostname = document.getElementById('device-hostname').value;
        deviceMetadata[ip].platform = document.getElementById('device-platform').value;

        // Update type-specific fields
        if (deviceType === 'cisco') {
          deviceMetadata[ip].location = document.getElementById('device-location').value;
          deviceMetadata[ip].namespace = document.getElementById('device-namespace').value;
          deviceMetadata[ip].role = document.getElementById('device-role').value;
          deviceMetadata[ip].status = document.getElementById('device-status').value;
          deviceMetadata[ip].interface_status = document.getElementById('device-interface-status').value;
          deviceMetadata[ip].ip_status = document.getElementById('device-ip-status').value;
        } else if (deviceType === 'linux') {
          deviceMetadata[ip].role = document.getElementById('linux-role').value;
          deviceMetadata[ip].location = document.getElementById('linux-location').value;
          deviceMetadata[ip].status = document.getElementById('linux-status').value;
        } else if (deviceType === 'unknown') {
          // For unknown devices, set minimal metadata
          deviceMetadata[ip].role = 'unknown';
          deviceMetadata[ip].status = 'Active';
        }

        // Close modal using Bootstrap 5
        try {
          const modal = document.getElementById('device-metadata-modal');
          const modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          } else {
            // If no instance exists, create one and hide it
            const newModalInstance = new bootstrap.Modal(modal);
            newModalInstance.hide();
          }
          console.log('Bootstrap 5 Modal hidden successfully');
        } catch (error) {
          console.error('Error closing modal:', error);
          showAlert('Error closing device configuration dialog.', 'warning');
        }
        
        showAlert('Device configuration saved.', 'success');
      }

      async function onboardSelectedDevices() {
        const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
        const selectedIPs = Array.from(checkedBoxes).map(cb => cb.dataset.ip);

        if (selectedIPs.length === 0) {
          showAlert('Please select devices to onboard.', 'warning');
          return;
        }

        // Prepare device list with metadata
        const devices = selectedIPs.map(ip => {
          const metadata = deviceMetadata[ip];
          return {
            ip: metadata.ip,
            credential_id: metadata.credential_id,
            device_type: metadata.device_type,
            hostname: metadata.hostname,
            platform: metadata.platform,
            location: metadata.location,
            namespace: metadata.namespace,
            role: metadata.role,
            status: metadata.status,
            interface_status: metadata.interface_status,
            ip_status: metadata.ip_status
          };
        });

        try {
          document.getElementById('onboard-selected-btn').disabled = true;
          document.getElementById('onboard-selected-btn').innerHTML = '<i class="fa fa-spinner fa-spin"></i> Onboarding...';

          const response = await authManager.apiRequest(`/api/scan/${scanJob.job_id}/onboard`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ devices })
          });

          let message = `Onboarding completed: ${response.accepted} devices processed.`;
          if (response.cisco_queued > 0) {
            message += ` ${response.cisco_queued} Cisco devices queued for Nautobot.`;
          }
          if (response.linux_added > 0) {
            message += ` ${response.linux_added} Linux servers added to inventory.`;
          }
          if (response.inventory_path) {
            message += ` Inventory file: ${response.inventory_path}`;
          }

          showAlert(message, 'success');

        } catch (error) {
          console.error('Onboarding failed:', error);
          showAlert('Device onboarding failed. Please try again.', 'danger');
        } finally {
          document.getElementById('onboard-selected-btn').disabled = false;
          document.getElementById('onboard-selected-btn').innerHTML = '<i class="fa fa-upload"></i> Onboard Selected Devices';
        }
      }

      function isValidCIDR(cidr) {
        const cidrPattern = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;
        if (!cidrPattern.test(cidr)) return false;

        const [ip, prefix] = cidr.split('/');
        const prefixNum = parseInt(prefix);
        
        // Check prefix range and minimum /22
        if (prefixNum < 22 || prefixNum > 32) return false;

        // Validate IP octets
        const octets = ip.split('.');
        return octets.every(octet => {
          const num = parseInt(octet);
          return num >= 0 && num <= 255;
        });
      }

      function showAlert(message, type = 'info') {
        // Create and show Bootstrap alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible`;
        alertDiv.innerHTML = `
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          ${message}
        `;
        
        // Insert at top of page content
        const content = document.querySelector('.x_content');
        content.insertBefore(alertDiv, content.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          if (window.$ && window.$.fn.fadeOut) {
            $(alertDiv).fadeOut(() => alertDiv.remove());
          } else {
            // Fallback: simple fade
            alertDiv.style.transition = 'opacity 0.5s';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
          }
        }, 5000);
      }

      function logout() {
        authManager.logout();
      }
    </script>
</body>
</html>
