<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="images/favicon.ico" type="image/ico" />
  <title>Scan & Add - Cockpit</title>
  <script type="module" src="/src/main-minimal.js"></script>
  <script src="js/auth.js"></script>
</head>
<body class="nav-md">
  <div class="container body">
    <div class="main_container">
      <div class="col-md-3 left_col">
        <div class="left_col scroll-view">
          <div class="navbar nav_title" style="border:0;">
            <a href="index.html" class="site_title"><i class="fas fa-paw"></i> <span>Cockpit!</span></a>
          </div>
          <div class="clearfix"></div>
          <div class="profile clearfix">
            <div class="profile_pic"></div>
            <div class="profile_info">
              <span id="welcome-message">Welcome,</span>
              <h2 id="sidebar-username">Loading...</h2>
            </div>
          </div>
          <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
            <div class="menu_section">
              <h3>General</h3>
              <ul class="nav side-menu">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a><i class="fas fa-rocket"></i> Onboarding <span class="fas fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="onboard-device.html"><i class="fas fa-plus-circle"></i> Onboard Device</a></li>
                    <li><a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a></li>
                    <li><a href="scan-and-add.html" class="current-page"><i class="fas fa-search-plus"></i> Scan & Add</a></li>
                  </ul>
                </li>
                
                <li><a><i class="fas fa-cogs"></i> Ansible <span class="fas fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="ansible-inventory.html"><i class="fas fa-list"></i> Inventory</a></li>
                  </ul>
                </li>
                <li><a><i class="fas fa-wrench"></i> Settings <span class="fas fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a></li>
                    <li><a href="settings-templates.html"><i class="fas fa-file-code"></i> Templates</a></li>
                    <li><a href="settings-git.html"><i class="fab fa-git-alt"></i> Git Management</a></li>
                    <li><a href="settings-cache.html"><i class="fas fa-bolt"></i> Cache</a></li>
                    <li><a href="settings-credentials.html"><i class="fas fa-key"></i> Credentials</a></li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
          <div class="sidebar-footer hidden-small">
            <a href="settings-nautobot.html" title="Settings"><span class="fas fa-cog" aria-hidden="true"></span></a>
            <a title="FullScreen"><span class="fas fa-expand" aria-hidden="true"></span></a>
            <a title="Lock"><span class="fas fa-eye-slash" aria-hidden="true"></span></a>
            <a title="Logout" href="login.html"><span class="fas fa-power-off" aria-hidden="true"></span></a>
          </div>
        </div>
      </div>
      <div class="top_nav">
        <div class="nav_menu">
          <div class="nav toggle"><a id="menu_toggle"><i class="fas fa-bars"></i></a></div>
          <nav class="nav navbar-nav">
            <ul class=" navbar-right">
              <li class="nav-item dropdown open" style="padding-left:15px;">
                <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false">
                  <span id="topbar-username">User</span>
                </a>
                <div class="dropdown-menu dropdown-usermenu pull-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="javascript:;" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Log Out</a>
                </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>
      <div class="right_col" role="main">
        <span id="nav-username" style="display:none"></span>
        <div class="page-title" style="margin-top:10px;margin-bottom:15px;">
          <h3 style="margin:0;">Scan & Add Devices</h3>
        </div>
        <div class="x_panel" style="margin-top:0;">
          <div class="x_content">
            <div class="steps-container" style="display:flex;align-items:center;margin-bottom:25px;">
              <div class="step active" id="step1-indicator">
                <div class="step-number">1</div>
                <div class="step-title">Network Scanning</div>
              </div>
              <div class="step-divider" style="flex:1;height:2px;background:#e9ecef;margin:0 20px;"></div>
              <div class="step" id="step2-indicator">
                <div class="step-number">2</div>
                <div class="step-title">Device Onboarding</div>
              </div>
            </div>

            <!-- Step 1 -->
            <div id="step1-content" class="step-content">
              <div class="row">
                <div class="col-md-8 col-sm-12">
                  <h3>Network Discovery Configuration</h3>
                  <p class="text-muted">Scan network ranges to discover devices and test credentials.</p>
                  <form id="scan-form">
                    <div class="form-group">
                      <label class="control-label">Network Ranges (CIDR)</label>
                      <small class="help-block">Maximum /22 networks (up to ~1024 hosts). Up to 10 ranges.</small>
                      <div id="cidrs-container">
                        <div class="cidr-input-group">
                          <div class="input-group">
                            <input type="text" class="form-control cidr-input" placeholder="192.168.1.0/24" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$">
                            <span class="input-group-btn">
                              <button class="btn btn-danger remove-cidr" type="button" style="display:none;">
                                <i class="fa fa-minus"></i>
                              </button>
                              <button class="btn btn-primary add-cidr" type="button">
                                <i class="fa fa-plus"></i>
                              </button>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="control-label">Authentication Credentials</label>
                      <small class="help-block">Select credentials to test against discovered devices.</small>
                      <div id="credentials-container">
                        <div class="credential-select-group">
                          <div class="input-group">
                            <select class="form-control credential-select" required>
                              <option value="">Select credentials...</option>
                            </select>
                            <span class="input-group-btn">
                              <button class="btn btn-danger remove-credential" type="button" style="display:none;">
                                <i class="fa fa-minus"></i>
                              </button>
                              <button class="btn btn-primary add-credential" type="button">
                                <i class="fa fa-plus"></i>
                              </button>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="control-label">Network Discovery Mode</label>
                      <small class="help-block">Choose the method for device authentication and detection.</small>
                      <select class="form-control" id="discovery-mode" required>
                        <option value="napalm">Napalm (Default - Full device detection with platform identification)</option>
                        <option value="ssh-login">SSH Login (Command-based device detection)</option>
                      </select>
                      <div class="help-block" style="margin-top:8px;">
                        <strong>Napalm:</strong> Attempts Cisco (ios/nxos/iosxr) and Linux detection with full platform details.<br>
                        <strong>SSH Login:</strong> SSH connectivity with basic device detection using 'show version' (Cisco) and 'uname -a' (Linux).
                      </div>
                    </div>
                    <div class="form-group">
                      <button type="submit" class="btn btn-primary btn-lg" id="start-scan-btn"><i class="fa fa-search"></i> Start Network Scan</button>
                    </div>
                  </form>
                </div>
                <div class="col-md-4 col-sm-12">
                  <div id="scan-progress" style="display:none;">
                    <div class="x_panel">
                      <div class="x_title"><h2><i class="fa fa-pulse fa-spinner"></i> Scan Progress</h2><div class="clearfix"></div></div>
                      <div class="x_content">
                        <div class="progress-stats">
                          <div class="stat-item"><strong>Job ID:</strong> <span id="job-id">-</span></div>
                          <div class="stat-item"><strong>Status:</strong> <span id="scan-status">-</span></div>
                          <div class="stat-item"><strong>Progress:</strong>
                            <div class="progress"><div class="progress-bar" id="scan-progress-bar" style="width:0%"></div></div>
                            <small><span id="scan-progress-text">0 / 0</span></small>
                          </div>
                        </div>
                        <div class="scan-metrics">
                          <table class="table table-condensed"><tbody>
                            <tr><td><i class="fa fa-check text-success"></i> Alive</td><td><span id="metric-alive">0</span></td></tr>
                            <tr><td><i class="fa fa-key text-info"></i> Authenticated</td><td><span id="metric-authenticated">0</span></td></tr>
                            <tr><td><i class="fa fa-times text-danger"></i> Unreachable</td><td><span id="metric-unreachable">0</span></td></tr>
                            <tr><td><i class="fa fa-exclamation text-warning"></i> Auth Failed</td><td><span id="metric-auth-failed">0</span></td></tr>
                            <tr><td><i class="fa fa-question text-muted"></i> Driver N/A</td><td><span id="metric-driver-na">0</span></td></tr>
                          </tbody></table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 2 -->
            <div id="step2-content" class="step-content" style="display:none;">
              <h3>Device Onboarding</h3>
              <p class="text-muted">Configure and onboard discovered devices.</p>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th width="40"><input type="checkbox" id="select-all-devices"></th>
                      <th>IP</th>
                      <th>Hostname</th>
                      <th>Type</th>
                      <th>Platform</th>
                      <th>Role</th>
                      <th>Location</th>
                      <th>Credential</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="devices-tbody"></tbody>
                </table>
              </div>
              <div class="form-group" style="margin-top:15px; display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <button type="button" class="btn btn-success btn-lg" id="onboard-selected-btn" disabled><i class="fa fa-upload"></i> Onboard Selected Devices</button>
                  <button type="button" class="btn btn-default" id="back-to-scan-btn">Back to Scan</button>
                </div>
                <div>
                  <button type="button" class="btn btn-warning" id="assign-to-all-btn"><i class="fa fa-check-square-o"></i> Assign to All</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer><div class="pull-right">Cockpit Network Management Dashboard</div><div class="clearfix"></div></footer>
      </div>
    </div>
  </div>

  <!-- Assign to All Modal -->
  <div class="modal" id="assign-all-modal" tabindex="-1" aria-labelledby="assign-all-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assign-all-modal-label">Assign Settings to Selected Devices</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="assign-all-form">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group"><label>Hostname</label><input type="text" class="form-control" id="all-hostname" placeholder="Leave empty to keep" /></div>
                <div class="form-group"><label>Platform</label><input type="text" class="form-control" id="all-platform" placeholder="Leave empty to keep" /></div>
                <div class="form-group"><label>Role</label><select class="form-control" id="all-role"><option value="">— leave unchanged —</option></select></div>
                <div class="form-group"><label>Location</label>
                  <div class="location-selector-wrapper">
                    <input type="text" id="all-location-search" class="form-control" placeholder="Search locations... (leave empty to keep)" autocomplete="off">
                    <input type="hidden" id="all-location-hidden">
                    <div id="all-location-dropdown" class="location-dropdown" style="display:none;"><div class="dropdown-content"></div></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group"><label>IP-Address Namespace</label><select class="form-control" id="all-namespace"><option value="">— leave unchanged —</option></select></div>
                <div class="form-group"><label>Status</label><select class="form-control" id="all-status"><option value="">— leave unchanged —</option><option>Active</option><option>Planned</option><option>Staging</option><option>Retired</option><option>Failed</option></select></div>
                <div class="form-group"><label>Interface Status</label><select class="form-control" id="all-interface-status"><option value="">— leave unchanged —</option><option>Active</option><option>Provisioning</option><option>Error</option></select></div>
                <div class="form-group"><label>IP Status</label><select class="form-control" id="all-ip-status"><option value="">— leave unchanged —</option><option>Active</option><option>Provisioning</option><option>Error</option></select></div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="assign-all-confirm"><i class="fa fa-check"></i> Assign to All</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="parser-select-modal" tabindex="-1" aria-labelledby="parser-select-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="parser-select-label">Select Parser Templates</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead><tr><th width="40">Use</th><th>Name</th><th>Description</th></tr></thead>
              <tbody id="parser-templates-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="confirm-start-scan">Start Network Scan</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal" id="device-metadata-modal" tabindex="-1" aria-labelledby="device-metadata-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="device-metadata-modal-label">Device Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="device-metadata-form">
            <input type="hidden" id="device-ip">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group"><label>IP Address</label><input type="text" class="form-control" id="device-ip-display" readonly></div>
                <div class="form-group"><label>Hostname</label><input type="text" class="form-control" id="device-hostname" placeholder="Auto-detected or custom"></div>
                <div class="form-group"><label>Platform</label><input type="text" class="form-control" id="device-platform" placeholder="cisco_ios, cisco_nxos, linux"></div>
                <div class="form-group"><label>Device Type</label>
                  <select class="form-control" id="device-type" readonly>
                    <option value="cisco">Cisco Device</option>
                    <option value="linux">Linux Server</option>
                    <option value="unknown">Unknown Device</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6" id="cisco-fields">
                <div class="form-group"><label>Role</label><select class="form-control" id="device-role"></select></div>
                <div class="form-group"><label>Location</label>
                  <div class="location-selector-wrapper">
                    <input type="text" id="device-location-search" class="form-control" placeholder="Search locations..." autocomplete="off">
                    <input type="hidden" id="device-location">
                    <div id="device-location-dropdown" class="location-dropdown" style="display:none;"><div class="dropdown-content"></div></div>
                  </div>
                </div>
                <div class="form-group"><label>IP-Address Namespace</label><select class="form-control" id="device-namespace"></select></div>
                <div class="form-group"><label>Status</label><select class="form-control" id="device-status"><option>Active</option><option>Planned</option><option>Staging</option><option>Retired</option><option>Failed</option></select></div>
                <div class="form-group"><label>Interface Status</label><select class="form-control" id="device-interface-status"><option>Active</option><option>Provisioning</option><option>Error</option></select></div>
                <div class="form-group"><label>IP Status</label><select class="form-control" id="device-ip-status"><option>Active</option><option>Provisioning</option><option>Error</option></select></div>
              </div>
              <div class="col-md-6" id="linux-fields" style="display:none;">
                <div class="form-group"><label>Role</label><select class="form-control" id="linux-role"></select></div>
                <div class="form-group"><label>Location</label>
                  <div class="location-selector-wrapper">
                    <input type="text" id="linux-location-search" class="form-control" placeholder="Search locations..." autocomplete="off">
                    <input type="hidden" id="linux-location">
                    <div id="linux-location-dropdown" class="location-dropdown" style="display:none;"><div class="dropdown-content"></div></div>
                  </div>
                </div>
                <div class="form-group"><label>Status</label><select class="form-control" id="linux-status"><option>Active</option><option>Planned</option><option>Staging</option><option>Retired</option><option>Failed</option></select></div>
              </div>
            </div>
            <div class="form-group" style="margin-top:15px;">
              <button type="button" class="btn btn-primary" id="save-device-metadata">Save</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    #device-metadata-modal .modal-content{background:#fff!important;}
    .step.active .step-number{background:#337ab7;color:#fff;}
    .step-number{width:40px;height:40px;border-radius:50%;background:#e9ecef;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-bottom:8px;border:2px solid #e9ecef;}
    .step{display:flex;flex-direction:column;align-items:center;min-width:120px;}
  /* Location selector styles (reused) */
  .location-selector-wrapper{position:relative;}
  .location-dropdown{position:absolute;top:100%;left:0;right:0;z-index:1050;background:#fff;border:1px solid #d1d3e2;border-top:none;border-radius:0 0 6px 6px;max-height:300px;overflow-y:auto;box-shadow:0 0.15rem 1.75rem 0 rgba(58,59,69,.15);}
  .dropdown-content{padding:0;}
  .location-dropdown-item{padding:10px 15px;cursor:pointer;border-bottom:1px solid #f3f3f4;transition:background-color .15s ease-in-out;line-height:1.4;word-wrap:break-word;}
  .location-dropdown-item:hover{background-color:#f8f9fc;}
  .location-dropdown-item:last-child{border-bottom:none;border-radius:0 0 6px 6px;}
  .location-dropdown-item.no-results{color:#858796;font-style:italic;cursor:default;}
  .location-dropdown-item.no-results:hover{background-color:transparent;}
  .has-selection{background-color:#d1ecf1;border-color:#bee5eb;}
  </style>

  <script>
    // Auth redirect (simple)
    if(!localStorage.getItem('auth_token')){window.location.href='login.html';}

    // State
  let credentialsData=[]; let scanJob=null; let discoveredDevices=[]; let deviceMetadata={}; let deviceModalInstance=null; let namespacesList=[]; let rolesList=[]; let locationsData=[];

    document.addEventListener('DOMContentLoaded', () => {
      if(!window.authManager){ window.authManager = new AuthManager(); }
      initPage();
    });

    async function initPage(){
      try {
        // Populate username in sidebar/topbar
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const uname = userInfo.username || 'User';
        const sb = document.getElementById('sidebar-username'); if(sb) sb.textContent = uname;
        const tb = document.getElementById('topbar-username'); if(tb) tb.textContent = uname;
  await loadCredentials();
  await loadNamespaces();
  await loadRoles();
  await loadLocations();
        setupEventListeners();
  // Normalize initial CIDR button states
  updateCIDRButtons();
  // Normalize initial credential button states
  updateCredentialButtons();
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.addEventListener('click', e => { e.preventDefault(); if(window.authManager) window.authManager.logout(); });
      } catch(e){ console.error('Init failed', e); }
    }

    async function loadNamespaces(){
      try{
        const resp = await authManager.apiRequest('/api/nautobot/namespaces');
        namespacesList = (resp || []).map(n=>n.name);
      }catch(e){ console.warn('Failed to load namespaces', e); namespacesList=[]; }
    }

  async function loadRoles(){
      try{
    const resp = await authManager.apiRequest('/api/nautobot/roles/devices');
        // Prefer name as display/value; also allow slug fallback
        rolesList = (resp || []).map(r=>({ name: r.name || r.slug || '', slug: r.slug || r.name || '' })).filter(r=>r.name);
      }catch(e){ console.warn('Failed to load roles', e); rolesList=[]; }
    }

    async function loadLocations(){
      try{
        const resp = await authManager.apiRequest('/api/nautobot/locations');
        locationsData = Array.isArray(resp) ? resp : [];
        // Build hierarchical paths similar to onboard-device
        buildLocationHierarchy();
        initLocationSelectors();
      }catch(e){ console.warn('Failed to load locations', e); locationsData=[]; }
    }
    function buildLocationHierarchy(){
      const map=new Map();
      locationsData.forEach(l=>map.set(l.id,l));
      function pathFor(loc){
        const parts=[]; let cur=loc; const guard=new Set();
        while(cur && !guard.has(cur.id)){
          guard.add(cur.id); parts.unshift(cur.name);
          cur = (cur.parent && cur.parent.id) ? map.get(cur.parent.id) : null;
        }
        return parts.length>1? parts.join(' → '):parts[0];
      }
      locationsData.forEach(l=>{ l.hierarchicalPath = pathFor(l); });
      locationsData.sort((a,b)=> a.hierarchicalPath.localeCompare(b.hierarchicalPath));
    }
    function filterAndRenderLocations(inputId, dropdownId){
      const input=document.getElementById(inputId); const dd=document.getElementById(dropdownId); if(!input||!dd) return;
      const content=dd.querySelector('.dropdown-content'); if(!content) return;
      const term=(input.value||'').toLowerCase();
      const filtered = locationsData.filter(l=> (l.hierarchicalPath||'').toLowerCase().includes(term));
      content.innerHTML='';
      if(filtered.length===0){ const no=document.createElement('div'); no.className='location-dropdown-item no-results'; no.textContent='No locations found'; content.appendChild(no); }
      else {
        filtered.forEach(l=>{ const item=document.createElement('div'); item.className='location-dropdown-item'; item.textContent=l.hierarchicalPath; item.dataset.value=l.id; item.addEventListener('click',()=>{ selectLocationFor(inputId, l); }); content.appendChild(item); });
      }
      dd.style.display='block';
    }
    function selectLocationFor(inputId, loc){
      const map={
        'device-location-search':{hidden:'device-location'},
        'linux-location-search':{hidden:'linux-location'},
        'all-location-search':{hidden:'all-location-hidden'}
      };
      const cfg=map[inputId]; if(!cfg) return;
      const searchEl=document.getElementById(inputId); const hiddenEl=document.getElementById(cfg.hidden);
      if(searchEl) { searchEl.value = loc.hierarchicalPath; searchEl.classList.add('has-selection'); }
      if(hiddenEl) hiddenEl.value = loc.id;
      const dd = searchEl && searchEl.parentElement ? searchEl.parentElement.querySelector('.location-dropdown') : null;
      if(dd) dd.style.display='none';
    }
    function initLocationSelectors(){
      // Device modal
      ['device','linux'].forEach(prefix=>{
        const searchId=`${prefix}-location-search`; const ddId=`${prefix}-location-dropdown`;
        const input=document.getElementById(searchId); const dd=document.getElementById(ddId);
        if(!input||!dd) return;
        input.addEventListener('input', ()=> filterAndRenderLocations(searchId, ddId));
        input.addEventListener('focus', ()=> filterAndRenderLocations(searchId, ddId));
        document.addEventListener('click', (e)=>{ if(!input.contains(e.target) && !dd.contains(e.target)) dd.style.display='none'; });
      });
      // Assign-all modal
      const allInput=document.getElementById('all-location-search'); const allDd=document.getElementById('all-location-dropdown');
      if(allInput && allDd){
        allInput.addEventListener('input', ()=> filterAndRenderLocations('all-location-search','all-location-dropdown'));
        allInput.addEventListener('focus', ()=> filterAndRenderLocations('all-location-search','all-location-dropdown'));
        document.addEventListener('click', (e)=>{ if(!allInput.contains(e.target) && !allDd.contains(e.target)) allDd.style.display='none'; });
      }
    }

    async function loadCredentials(){
      try {
        credentialsData = await authManager.apiRequest('/api/credentials/');
        updateCredentialSelects();
      } catch(err){ console.error('Failed loading credentials', err); showAlert('Failed to load credentials','danger'); }
    }

    function updateCredentialSelects(){
      const selects=document.querySelectorAll('.credential-select');
      selects.forEach(sel=>populateCredentialSelect(sel));
    }

    function populateCredentialSelect(select){
      const current=select.value;
      select.innerHTML='<option value="">Select credentials...</option>' + credentialsData.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      if(current && [...select.options].some(o=>o.value===current)) select.value=current;
    }

    function setupEventListeners(){
      const scanForm=document.getElementById('scan-form'); if(scanForm){ scanForm.addEventListener('submit', startScan);}    
      const backBtn=document.getElementById('back-to-scan-btn'); if(backBtn){ backBtn.addEventListener('click',()=>showStep(1)); }
      const selectAll=document.getElementById('select-all-devices'); if(selectAll){ selectAll.addEventListener('change', toggleAllDevices);}  
      const onboardBtn=document.getElementById('onboard-selected-btn'); if(onboardBtn){ onboardBtn.addEventListener('click', onboardSelectedDevices);} 
      const assignAllBtn=document.getElementById('assign-to-all-btn'); if(assignAllBtn){ assignAllBtn.addEventListener('click', openAssignAllModal);} 
      const saveBtn=document.getElementById('save-device-metadata'); if(saveBtn){ saveBtn.addEventListener('click', saveDeviceMetadata);} 
      document.getElementById('devices-tbody').addEventListener('click', e=>{
        if(e.target.closest('.device-config-btn')){
          const ip=e.target.closest('button').dataset.ip;
          editDeviceMetadata(ip);
        }
      });
      // Delegated for dynamic add/remove
      document.getElementById('cidrs-container').addEventListener('click', cidrContainerHandler);
      document.getElementById('credentials-container').addEventListener('click', credentialContainerHandler);
    }

    function cidrContainerHandler(e){
      if(e.target.closest('.add-cidr')) addCIDR();
      else if(e.target.closest('.remove-cidr')) removeCIDR(e.target.closest('.cidr-input-group'));
    }
    function credentialContainerHandler(e){
      if(e.target.closest('.add-credential')) addCredential();
      else if(e.target.closest('.remove-credential')) removeCredential(e.target.closest('.credential-select-group'));
    }
    function addCIDR(){
      const container=document.getElementById('cidrs-container');
      const count=container.querySelectorAll('.cidr-input-group').length;
      if(count>=10){ showAlert('Maximum 10 CIDR ranges','warning'); return; }
      const div=document.createElement('div'); div.className='cidr-input-group';
      div.innerHTML=`<div class="input-group"><input type="text" class="form-control cidr-input" placeholder="192.168.2.0/24" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$"><span class="input-group-btn"><button class="btn btn-danger remove-cidr" type="button"><i class="fa fa-minus"></i></button><button class="btn btn-primary add-cidr" type="button"><i class="fa fa-plus"></i></button></span></div>`;
      container.appendChild(div); updateCIDRButtons();
    }
    function removeCIDR(group){ group.remove(); updateCIDRButtons(); }
    function updateCIDRButtons(){
      const groups=document.querySelectorAll('.cidr-input-group');
      groups.forEach((g,i)=>{
        const removeBtn=g.querySelector('.remove-cidr');
        const addBtn=g.querySelector('.add-cidr');
        if(removeBtn) removeBtn.style.display = groups.length>1 ? 'inline-block':'none';
        if(addBtn) addBtn.style.display = (i === groups.length -1) ? 'inline-block':'none';
      });
    }
    function addCredential(){
      if(credentialsData.length===0){ showAlert('No credentials available','warning'); return; }
      const container=document.getElementById('credentials-container');
      const groups=container.querySelectorAll('.credential-select-group');
      if(groups.length>=credentialsData.length){ showAlert('All credentials already added','warning'); return; }
      const div=document.createElement('div'); div.className='credential-select-group';
      div.innerHTML=`<div class="input-group"><select class="form-control credential-select" required><option value="">Select credentials...</option>${credentialsData.map(c=>`<option value='${c.id}'>${c.name}</option>`).join('')}</select><span class="input-group-btn"><button class="btn btn-danger remove-credential" type="button"><i class="fa fa-minus"></i></button><button class="btn btn-primary add-credential" type="button"><i class="fa fa-plus"></i></button></span></div>`;
      container.appendChild(div); updateCredentialButtons();
    }
    function removeCredential(group){ group.remove(); updateCredentialButtons(); }
    function updateCredentialButtons(){
      const groups=document.querySelectorAll('.credential-select-group');
      groups.forEach((g,i)=>{
        const removeBtn=g.querySelector('.remove-credential');
        const addBtn=g.querySelector('.add-credential');
        if(removeBtn) removeBtn.style.display = groups.length>1 ? 'inline-block':'none';
        if(addBtn){
          if(groups.length >= credentialsData.length){
            addBtn.style.display='none';
          } else {
            addBtn.style.display = (i === groups.length -1) ? 'inline-block':'none';
          }
        }
      });
    }

  let pendingScanPayload = null;

  async function startScan(e){
      e.preventDefault();
      const cidrs=[...document.querySelectorAll('.cidr-input')].map(i=>i.value.trim()).filter(v=>v);
      if(cidrs.length===0){ showAlert('Please enter at least one network range','warning'); return; }
      if(!cidrs.every(isValidCIDR)){ showAlert('Invalid CIDR format or prefix (/22-/32 only)','danger'); return; }
      const credentialIds=[...document.querySelectorAll('.credential-select')].map(s=>s.value).filter(v=>v);
      if(credentialIds.length===0){ showAlert('Select at least one credential','warning'); return; }
      const uniqueCredentials=[...new Set(credentialIds)]; if(uniqueCredentials.length!==credentialIds.length){ showAlert('Duplicate credentials selected','warning'); return; }
      const discoveryMode=document.getElementById('discovery-mode').value; if(!discoveryMode){ showAlert('Select discovery mode','warning'); return; }
      try {
        // If ssh-login, prompt for parser templates first
        if(discoveryMode==='ssh-login'){
          pendingScanPayload = { cidrs, credential_ids: uniqueCredentials, discovery_mode: discoveryMode };
          await openParserTemplateModal();
          return; // wait for confirm
        }
        document.getElementById('start-scan-btn').disabled=true; document.getElementById('scan-progress').style.display='block';
        const response=await authManager.apiRequest('/api/scan/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cidrs,credential_ids:uniqueCredentials,discovery_mode:discoveryMode})});
        scanJob=response; document.getElementById('job-id').textContent=response.job_id; document.getElementById('scan-status').textContent=response.state; pollScanProgress();
      } catch(err){ console.error('Scan start failed',err); showAlert('Failed to start scan','danger'); document.getElementById('start-scan-btn').disabled=false; document.getElementById('scan-progress').style.display='none'; }
    }

    async function openParserTemplateModal(){
      // Fetch templates with category=parser
      let templates=[];
      try{
        const resp = await authManager.apiRequest('/api/templates?category=parser');
        templates = resp.templates || [];
      }catch(e){ console.error('Failed to load parser templates', e); showAlert('Failed to load parser templates','danger'); }
      const tbody=document.getElementById('parser-templates-tbody');
      tbody.innerHTML='';
      if(!templates.length){
        tbody.innerHTML = '<tr><td colspan="3"><em>No parser templates available. You can still continue without selecting any.</em></td></tr>';
      } else {
        for(const t of templates){
          const tr=document.createElement('tr');
          tr.innerHTML = `<td><input type="checkbox" class="parser-template-checkbox" value="${t.id}" checked></td><td>${t.name}</td><td>${t.description||''}</td>`;
          tbody.appendChild(tr);
        }
      }
      const modalEl=document.getElementById('parser-select-modal');
      if(!window.parserModal){ window.parserModal = new bootstrap.Modal(modalEl,{backdrop:true}); }
      // Bind confirm
      document.getElementById('confirm-start-scan').onclick = confirmStartScanWithParsers;
      window.parserModal.show();
    }

    async function confirmStartScanWithParsers(){
      const selected=[...document.querySelectorAll('.parser-template-checkbox:checked')].map(cb=>parseInt(cb.value,10));
      const payload = { ...pendingScanPayload, parser_template_ids: selected };
      window.parserModal.hide();
      try{
        document.getElementById('start-scan-btn').disabled=true; document.getElementById('scan-progress').style.display='block';
        const response=await authManager.apiRequest('/api/scan/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        scanJob=response; document.getElementById('job-id').textContent=response.job_id; document.getElementById('scan-status').textContent=response.state; pollScanProgress();
      }catch(err){ console.error('Scan start failed',err); showAlert('Failed to start scan','danger'); document.getElementById('start-scan-btn').disabled=false; document.getElementById('scan-progress').style.display='none'; }
      finally{ pendingScanPayload=null; }
    }

    async function pollScanProgress(){ if(!scanJob) return; try { const status=await authManager.apiRequest(`/api/scan/${scanJob.job_id}/status`); updateProgressDisplay(status); if(status.state==='finished'){ discoveredDevices=status.results; showAlert('Network scan completed','success'); populateDevicesTable(); showStep(2);} else if(status.state==='failed'){ showAlert('Scan failed','danger'); resetScanForm(); } else { setTimeout(pollScanProgress,2000);} } catch(err){ console.error('Status poll failed',err); showAlert('Lost connection to scan job','danger'); resetScanForm(); }}

    function updateProgressDisplay(status){
      const p=status.progress; const pct=p.total>0?(p.scanned/p.total*100):0; document.getElementById('scan-progress-bar').style.width=`${pct}%`; document.getElementById('scan-progress-text').textContent=`${p.scanned} / ${p.total}`; document.getElementById('metric-alive').textContent=p.alive; document.getElementById('metric-authenticated').textContent=p.authenticated; document.getElementById('metric-unreachable').textContent=p.unreachable; document.getElementById('metric-auth-failed').textContent=p.auth_failed; document.getElementById('metric-driver-na').textContent=p.driver_not_supported; document.getElementById('scan-status').textContent=status.state; }

  function locationDisplay(val){
      if(!val) return 'unknown';
      const found = (locationsData||[]).find(l=>l.id===val || l.name===val);
      return found ? (found.hierarchicalPath || found.name) : val;
    }
  function populateDevicesTable(){
      const tbody=document.getElementById('devices-tbody');
      tbody.innerHTML='';
      discoveredDevices.forEach(d=>{
        const existing = deviceMetadata[d.ip] || {};
        // establish defaults once, then keep overrides
        const merged = {
          ip: d.ip,
          credential_id: d.credential_id,
          device_type: existing.device_type || d.device_type,
          hostname: (existing.hostname!==undefined? existing.hostname : d.hostname),
          platform: (existing.platform!==undefined? existing.platform : d.platform),
      location: (existing.location!==undefined ? existing.location : 'unknown'),
      namespace: existing.namespace || (namespacesList[0] || 'Global'),
      role: existing.role || (d.device_type==='cisco'?'network':d.device_type==='linux'?'server':'unknown'),
          status: existing.status || 'Active',
          interface_status: existing.interface_status || 'Active',
          ip_status: existing.ip_status || 'Active'
        };
        deviceMetadata[d.ip] = merged; // persist
        const cred=credentialsData.find(c=>c.id===merged.credential_id);
        const credName=cred?cred.name:'Unknown';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><input type='checkbox' class='device-checkbox' data-ip='${merged.ip}'></td>
                       <td>${merged.ip}</td>
                       <td>${merged.hostname||'Unknown'}</td>
                       <td>${merged.device_type}</td>
                       <td>${merged.platform||'Unknown'}</td>
             <td>${merged.role||'unknown'}</td>
             <td>${locationDisplay(merged.location)}</td>
                       <td>${credName}</td>
                       <td><button class='btn btn-sm btn-info device-config-btn' data-ip='${merged.ip}'><i class='fa fa-edit'></i> Configure</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.device-checkbox').forEach(cb=>cb.addEventListener('change', updateOnboardButton));
      updateOnboardButton();
    }

    function showStep(n){ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); document.getElementById(`step${n}-indicator`).classList.add('active'); document.querySelectorAll('.step-content').forEach(c=>c.style.display='none'); document.getElementById(`step${n}-content`).style.display='block'; if(n===1){ resetScanForm(); }}
    function resetScanForm(){ document.getElementById('start-scan-btn').disabled=false; document.getElementById('scan-progress').style.display='none'; scanJob=null; discoveredDevices=[]; deviceMetadata={}; }
    function toggleAllDevices(){ const master=document.getElementById('select-all-devices'); document.querySelectorAll('.device-checkbox').forEach(cb=>cb.checked=master.checked); updateOnboardButton(); }
    function updateOnboardButton(){ const cnt=document.querySelectorAll('.device-checkbox:checked').length; const btn=document.getElementById('onboard-selected-btn'); if(btn) btn.disabled=cnt===0; }

  function editDeviceMetadata(ip){ const d=deviceMetadata[ip]; if(!d) return; document.getElementById('device-ip').value=ip; document.getElementById('device-ip-display').value=ip; document.getElementById('device-hostname').value=d.hostname||''; document.getElementById('device-platform').value=d.platform||''; document.getElementById('device-type').value=d.device_type; toggleDeviceFields(); if(d.device_type==='cisco'){ const ds=document.getElementById('device-location-search'); const dh=document.getElementById('device-location'); if(ds){ ds.value=''; ds.classList.remove('has-selection'); } if(dh){ dh.value=''; } if(d.location){ // try to show display path if exists
        const found=locationsData.find(l=>l.id===d.location || l.name===d.location);
        if(found && ds){ ds.value=found.hierarchicalPath; ds.classList.add('has-selection'); } if(found && dh){ dh.value=found.id; }
      }
      populateNamespaceSelect('device-namespace', d.namespace);
      document.getElementById('device-role').value=d.role||'network'; document.getElementById('device-status').value=d.status||'Active'; document.getElementById('device-interface-status').value=d.interface_status||'Active'; document.getElementById('device-ip-status').value=d.ip_status||'Active'; } else if(d.device_type==='linux'){ const ls=document.getElementById('linux-location-search'); const lh=document.getElementById('linux-location'); if(ls){ ls.value=''; ls.classList.remove('has-selection'); } if(lh){ lh.value=''; } if(d.location){ const found=locationsData.find(l=>l.id===d.location || l.name===d.location); if(found && ls){ ls.value=found.hierarchicalPath; ls.classList.add('has-selection'); } if(found && lh){ lh.value=found.id; } }
      document.getElementById('linux-role').value=d.role||'server'; document.getElementById('linux-status').value=d.status||'Active'; }
      const modal=document.getElementById('device-metadata-modal'); if(!deviceModalInstance){ deviceModalInstance=new bootstrap.Modal(modal,{backdrop:true}); } deviceModalInstance.show(); }
    function populateRoleSelect(selectId, current, options={includeBlank:false}){
      const sel=document.getElementById(selectId);
      if(!sel) return;
      sel.innerHTML='';
      if(options.includeBlank){ const o=document.createElement('option'); o.value=''; o.textContent='— leave unchanged —'; sel.appendChild(o); }
      for(const r of rolesList){ const o=document.createElement('option'); o.value=r.name; o.textContent=r.name; sel.appendChild(o); }
      if(current && rolesList.some(r=>r.name===current)) sel.value=current;
      else if(!options.includeBlank && rolesList.length){ sel.value=rolesList[0].name; }
    }
    function initRoleSelectsForModal(d){
      // Cisco/Linux use different select IDs
      if(d.device_type==='cisco'){
        populateRoleSelect('device-role', d.role || (d.device_type==='linux'?'server':'network'));
      } else if(d.device_type==='linux'){
        populateRoleSelect('linux-role', d.role || 'server');
      }
    }
    // Hook into edit to populate selects
    const _origEditDeviceMetadata = editDeviceMetadata;
    editDeviceMetadata = function(ip){
      const d=deviceMetadata[ip];
      if(!d) return;
      _origEditDeviceMetadata.call(this, ip);
      // After elements exist, populate selects
      initRoleSelectsForModal(d);
    }
    function populateNamespaceSelect(selectId, current){
      const sel = document.getElementById(selectId);
      if(!sel) return;
      sel.innerHTML = '';
      // Optionally include a default if none
      const values = namespacesList && namespacesList.length ? namespacesList : ['Global'];
      for(const ns of values){
        const opt=document.createElement('option'); opt.value=ns; opt.textContent=ns; sel.appendChild(opt);
      }
      if(current && values.includes(current)) sel.value=current; else sel.value=values[0];
    }
    function toggleDeviceFields(){ const t=document.getElementById('device-type').value; document.getElementById('cisco-fields').style.display=t==='cisco'?'block':'none'; document.getElementById('linux-fields').style.display=t==='linux'?'block':'none'; }
  function saveDeviceMetadata(){ const ip=document.getElementById('device-ip').value; const type=document.getElementById('device-type').value; if(!deviceMetadata[ip]) return; deviceMetadata[ip].hostname=document.getElementById('device-hostname').value; deviceMetadata[ip].platform=document.getElementById('device-platform').value; if(type==='cisco'){ deviceMetadata[ip].location=document.getElementById('device-location').value; deviceMetadata[ip].namespace=document.getElementById('device-namespace').value; deviceMetadata[ip].role=document.getElementById('device-role').value; deviceMetadata[ip].status=document.getElementById('device-status').value; deviceMetadata[ip].interface_status=document.getElementById('device-interface-status').value; deviceMetadata[ip].ip_status=document.getElementById('device-ip-status').value; } else if(type==='linux'){ deviceMetadata[ip].role=document.getElementById('linux-role').value; deviceMetadata[ip].location=document.getElementById('linux-location').value; deviceMetadata[ip].status=document.getElementById('linux-status').value; } else { deviceMetadata[ip].role='unknown'; deviceMetadata[ip].status='Active'; } if(deviceModalInstance) deviceModalInstance.hide(); showAlert('Device configuration saved','success'); }

    // Assign to All
    let assignAllModalInstance=null;
    function openAssignAllModal(){
      const selected=[...document.querySelectorAll('.device-checkbox:checked')].map(cb=>cb.dataset.ip);
      if(selected.length===0){ showAlert('Select devices first','warning'); return; }
      const modal=document.getElementById('assign-all-modal');
      if(!assignAllModalInstance){ assignAllModalInstance=new bootstrap.Modal(modal,{backdrop:true}); }
      // reset form
      document.getElementById('assign-all-form').reset();
      document.getElementById('assign-all-confirm').onclick = confirmAssignAll;
      assignAllModalInstance.show();
    }
    function confirmAssignAll(){
      const selected=[...document.querySelectorAll('.device-checkbox:checked')].map(cb=>cb.dataset.ip);
      if(selected.length===0){ showAlert('Select devices first','warning'); return; }
      const updates={};
      const getVal=(id)=>document.getElementById(id).value.trim();
      const hn=getVal('all-hostname'); if(hn) updates.hostname=hn;
      const pf=getVal('all-platform'); if(pf) updates.platform=pf;
      const rl=getVal('all-role'); if(rl) updates.role=rl;
  const lcHidden=document.getElementById('all-location-hidden').value; if(lcHidden) updates.location=lcHidden;
      const ns=document.getElementById('all-namespace').value; if(ns) updates.namespace=ns;
      const st=document.getElementById('all-status').value; if(st) updates.status=st;
      const ist=document.getElementById('all-interface-status').value; if(ist) updates.interface_status=ist;
      const ipst=document.getElementById('all-ip-status').value; if(ipst) updates.ip_status=ipst;
      if(Object.keys(updates).length===0){ showAlert('No values to assign','warning'); return; }
      for(const ip of selected){ deviceMetadata[ip] = { ...(deviceMetadata[ip]||{}), ...updates }; }
      if(assignAllModalInstance) assignAllModalInstance.hide();
      populateDevicesTable();
      showAlert('Values assigned to selected devices','success');
    }

    // When opening Assign to All, populate namespace options
    const assignAllBtnHook = document.getElementById('assign-to-all-btn');
    if(assignAllBtnHook){ assignAllBtnHook.addEventListener('click', ()=>{
      const selNs=document.getElementById('all-namespace'); if(selNs){ selNs.innerHTML='<option value=\"\">— leave unchanged —</option>'; (namespacesList||[]).forEach(ns=>{ const o=document.createElement('option'); o.value=ns; o.textContent=ns; selNs.appendChild(o); }); }
      populateRoleSelect('all-role', null, {includeBlank:true});
      // Reset bulk location selector display/hidden
      const ai=document.getElementById('all-location-search'); const ah=document.getElementById('all-location-hidden'); const add=document.getElementById('all-location-dropdown'); if(ai){ ai.value=''; ai.classList.remove('has-selection'); } if(ah){ ah.value=''; } if(add){ const content=add.querySelector('.dropdown-content'); if(content) content.innerHTML=''; add.style.display='none'; }
    }); }

  async function onboardSelectedDevices(){ const ips=[...document.querySelectorAll('.device-checkbox:checked')].map(cb=>cb.dataset.ip); if(ips.length===0){ showAlert('Select devices to onboard','warning'); return;} const devices=ips.map(ip=>{ const m=deviceMetadata[ip]; return { ip:m.ip, credential_id:m.credential_id, device_type:m.device_type, hostname:m.hostname, platform:m.platform, location:m.location, namespace:m.namespace, role:m.role, status:m.status, interface_status:m.interface_status, ip_status:m.ip_status }; }); try { const btn=document.getElementById('onboard-selected-btn'); btn.disabled=true; btn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Onboarding...'; const resp=await authManager.apiRequest(`/api/scan/${scanJob.job_id}/onboard`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({devices})}); let msg=`Onboarding completed: ${resp.accepted} devices.`; if(resp.cisco_queued) msg+=` ${resp.cisco_queued} Cisco queued.`; if(resp.linux_added) msg+=` ${resp.linux_added} Linux added.`; if(resp.inventory_path) msg+=` Inventory: ${resp.inventory_path}`; showAlert(msg,'success'); } catch(err){ console.error('Onboard failed',err); showAlert('Onboarding failed','danger'); } finally { const btn=document.getElementById('onboard-selected-btn'); btn.disabled=false; btn.innerHTML='<i class="fa fa-upload"></i> Onboard Selected Devices'; } }

    function isValidCIDR(c){ const re=/(\d{1,3}\.){3}\d{1,3}\/\d{1,2}/; if(!re.test(c)) return false; const [ip,prefix]=c.split('/'); const pn=parseInt(prefix); if(pn<22||pn>32) return false; return ip.split('.').every(o=>{const n=parseInt(o); return n>=0&&n<=255;}); }
    function showAlert(msg,type='info'){ const div=document.createElement('div'); div.className=`alert alert-${type} alert-dismissible`; div.innerHTML=`<button type='button' class='close' data-dismiss='alert'>&times;</button>${msg}`; const content=document.querySelector('.x_content'); content.insertBefore(div, content.firstChild); setTimeout(()=>{ div.style.transition='opacity .5s'; div.style.opacity='0'; setTimeout(()=>div.remove(),500); },5000); }
  </script>
</body>
</html>
      }

      function logout() {
        authManager.logout();
      }
    </script>
</body>
</html>
