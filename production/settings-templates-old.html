<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Template Settings - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    
    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- Container configuration (if in container mode) -->
    <script>
      // Load container config if in container environment
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        const script = document.createElement('script');
        script.src = 'js/config-container.js';
        document.head.appendChild(script);
      }
    </script>
    <!-- API Manager -->
    <script src="js/api-manager.js"></script>
    <script>
      // Robust authentication check
      (function() {
        console.log('Checking authentication...');
        
        // Check if we have a valid token
        const token = localStorage.getItem('auth_token');
        console.log('Token found:', !!token);
        
        if (!token) {
          console.log('No token found, redirecting to login');
          // Use absolute path to ensure proper redirect
          window.location.href = '/login.html';
          return;
        }
        
        console.log('Token found, user authenticated');
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      // Initialize auth manager when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        window.authManager = new AuthManager();
        console.log('AuthManager initialized');
      });
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><i class="fas fa-paw"></i> <span>Cockpit!</span></a>
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
              </div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                  <li><a><i class="fas fa-rocket"></i> Onboarding <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="onboard-device.html"><i class="fas fa-plus-circle"></i> Onboard Device</a></li>
                      <li><a href="sync_devices.html"><i class="fas fa-sync"></i> Sync Devices</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-cogs"></i> Configs <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="backup.html"><i class="fas fa-save"></i> Backup</a></li>
                      <li><a href="compare.html"><i class="fas fa-exchange-alt"></i> Compare</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-wrench"></i> Settings <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a></li>
                      <li><a href="settings-git.html"><i class="fas fa-code-branch"></i> Configs</a></li>
                      <li><a href="settings-templates.html" class="current-page"><i class="fas fa-file-code"></i> Templates</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a href="settings-templates.html" data-bs-toggle="tooltip" data-bs-placement="top" title="Settings">
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px;">
                  <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <script>
                    // Immediate username update if user info is available
                    (function() {
                      const userInfo = localStorage.getItem('user_info');
                      if (userInfo) {
                        try {
                          const user = JSON.parse(userInfo);
                          const element = document.getElementById('navbar-username');
                          if (element && user) {
                            element.textContent = user.full_name || user.username || 'User';
                          }
                        } catch (e) {
                          console.log('Error parsing user info:', e);
                        }
                      }
                    })();
                  </script>
                  <div class="dropdown-menu dropdown-usermenu pull-right" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="javascript:;" onclick="logout()"><i class="fas fa-power-off pull-right"></i> Log Out</a>
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Template Configuration</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <!-- Settings Content -->
            <div class="row">
              <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>Template Settings <small>Configure template source and management</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  
                  <!-- Status Message Area -->
                  <div id="status-message" style="display: none;"></div>
                  
                  <div class="x_content">
                    
                    <!-- Template Source Selection -->
                    <div class="row">
                      <div class="col-md-12">
                        <h3 class="section-heading">
                          <i class="fas fa-file-code"></i> Template Source Configuration
                        </h3>
                        <hr class="section-divider">
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="template-source" class="control-label">Template Source <span class="required">*</span></label>
                          <select id="template-source" class="form-control" required>
                            <option value="">Select template source...</option>
                            <option value="git">Git Repository</option>
                            <option value="file">File Upload</option>
                            <option value="webeditor">Web Editor</option>
                          </select>
                          <small class="form-text text-muted">Choose how you want to manage your configuration templates</small>
                        </div>
                      </div>
                    </div>

                    <!-- Git Repository Configuration -->
                    <div id="git-config-section" class="template-config-section" style="display: none;">
                      <div class="row">
                        <div class="col-md-12">
                          <h4 class="subsection-heading">
                            <i class="fas fa-code-branch"></i> Git Repository Settings
                          </h4>
                          <hr class="subsection-divider">
                        </div>
                      </div>

                      <form id="template-git-form">
                        <div class="row">
                          <div class="col-md-8">
                            <div class="form-group">
                              <label for="template-git-repo-url" class="control-label">Git Repository URL <span class="required">*</span></label>
                              <input type="url" id="template-git-repo-url" class="form-control" placeholder="https://github.com/username/template-repo.git" required>
                              <small class="form-text text-muted">The Git repository containing your configuration templates</small>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="form-group">
                              <label for="template-git-branch" class="control-label">Branch</label>
                              <input type="text" id="template-git-branch" class="form-control" value="main" placeholder="main">
                              <small class="form-text text-muted">Branch to use for templates</small>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="template-git-username" class="control-label">Git Username</label>
                              <input type="text" id="template-git-username" class="form-control" placeholder="Enter Git username">
                              <small class="form-text text-muted">Username for Git authentication (if required)</small>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="template-git-token" class="control-label">Git Personal Access Token</label>
                              <input type="password" id="template-git-token" class="form-control" placeholder="Enter Git token">
                              <small class="form-text text-muted">Personal access token for Git authentication</small>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="template-path" class="control-label">Template Files Path</label>
                              <input type="text" id="template-path" class="form-control" value="templates/" placeholder="templates/">
                              <small class="form-text text-muted">Path within the repository where template files are stored</small>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="template-git-verify-ssl" class="control-label">SSL Certificate Verification</label>
                              <input type="checkbox" id="template-git-verify-ssl" class="form-check-input">
                              <label for="template-git-verify-ssl" class="form-check-label">Verify SSL certificates</label>
                              <small class="form-text text-muted">Verify SSL certificates when connecting to Git repository</small>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-12">
                            <button type="button" id="test-template-git-connection" class="btn btn-info btn-sm">
                              <i class="fas fa-code-branch"></i> Test Git Connection
                            </button>
                            <span id="template-git-connection-status" class="ml-3"></span>
                          </div>
                        </div>
                      </form>
                    </div>

                    <!-- File Upload Configuration -->
                    <div id="file-config-section" class="template-config-section" style="display: none;">
                      <div class="row">
                        <div class="col-md-12">
                          <h4 class="subsection-heading">
                            <i class="fas fa-file-upload"></i> File Upload Settings
                          </h4>
                          <hr class="subsection-divider">
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="template-file-upload" class="control-label">Upload Template File</label>
                            <input type="file" id="template-file-upload" class="form-control" accept=".txt,.conf,.cfg,.j2,.jinja2,.yaml,.yml,.json">
                            <small class="form-text text-muted">Upload a configuration template file (supports .txt, .conf, .cfg, .j2, .jinja2, .yaml, .yml, .json)</small>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="uploaded-template-preview" class="control-label">Template Preview</label>
                            <textarea id="uploaded-template-preview" class="form-control" rows="10" readonly placeholder="Upload a file to see its content here..."></textarea>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Web Editor Configuration -->
                    <div id="webeditor-config-section" class="template-config-section" style="display: none;">
                      <div class="row">
                        <div class="col-md-12">
                          <h4 class="subsection-heading">
                            <i class="fas fa-edit"></i> Web Editor
                          </h4>
                          <hr class="subsection-divider">
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="template-name" class="control-label">Template Name <span class="required">*</span></label>
                            <input type="text" id="template-name" class="form-control" placeholder="Enter template name (e.g., cisco-ios-base)">
                            <small class="form-text text-muted">A descriptive name for your template</small>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="template-type" class="control-label">Template Type</label>
                            <select id="template-type" class="form-control">
                              <option value="jinja2">Jinja2</option>
                              <option value="text">Plain Text</option>
                              <option value="yaml">YAML</option>
                              <option value="json">JSON</option>
                            </select>
                            <small class="form-text text-muted">Template format/type</small>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="template-category" class="control-label">Category</label>
                            <input type="text" id="template-category" class="form-control" placeholder="e.g., Network, Security, Base">
                            <small class="form-text text-muted">Optional category for organization</small>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="template-description" class="control-label">Description</label>
                            <textarea id="template-description" class="form-control" rows="3" placeholder="Describe what this template does..."></textarea>
                            <small class="form-text text-muted">Optional description of the template's purpose</small>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="editor-toolbar">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('{{ ', ' }}')">
                              <i class="fas fa-code"></i> Variable
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('{% for item in items %}', '{% endfor %}')">
                              <i class="fas fa-repeat"></i> For Loop
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('{% if condition %}', '{% endif %}')">
                              <i class="fas fa-question"></i> If Statement
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('{# ', ' #}')">
                              <i class="fas fa-comment"></i> Comment
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="formatTemplate()">
                              <i class="fas fa-magic"></i> Format
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="template-content" class="control-label">Template Content <span class="required">*</span></label>
                            <textarea id="template-content" class="form-control template-editor" rows="15" placeholder="Enter your configuration template here...

Example Jinja2 template:
!
hostname {{ hostname }}
!
interface {{ interface_name }}
 description {{ interface_description }}
 ip address {{ ip_address }} {{ subnet_mask }}
 no shutdown
!
{% for vlan in vlans %}
vlan {{ vlan.id }}
 name {{ vlan.name }}
{% endfor %}
!"></textarea>
                            <small class="form-text text-muted">Write your configuration template using Jinja2 syntax or plain text</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Save Button -->
                    <div class="row" style="margin-top: 40px;">
                      <div class="col-md-12">
                        <hr>
                        <button type="button" id="save-template-settings" class="btn btn-success">
                          <i class="fas fa-save"></i> Save Template Settings
                        </button>
                        <button type="button" id="reset-template-settings" class="btn btn-warning ml-3">
                          <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                        <button type="button" id="preview-template" class="btn btn-info ml-3" style="display: none;">
                          <i class="fas fa-eye"></i> Preview Template
                        </button>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            <!-- /Settings Content -->

          </div>
        </div>
        <!-- /page content -->
      </div>
    </div>

    <!-- Custom styles for current page indication -->
    <style>
      .current-page {
        background-color: #2A3F54 !important;
        color: #fff !important;
        border-radius: 3px;
      }
      
      .current-page:hover {
        background-color: #1e2b3a !important;
      }

      /* Top status message styling */
      #status-message {
        margin-top: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-weight: 500;
      }

      .section-heading {
        color: #2A3F54;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .subsection-heading {
        color: #5a5c69;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
      }

      .section-divider {
        border-top: 2px solid #e6e9ed;
        margin-bottom: 25px;
      }

      .subsection-divider {
        border-top: 1px solid #e6e9ed;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .required {
        color: red;
      }

      .template-config-section {
        margin-top: 30px;
        padding: 20px;
        border: 1px solid #e6e9ed;
        border-radius: 5px;
        background-color: #f8f9fa;
      }

      .template-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        min-height: 300px;
        resize: vertical;
      }

      .editor-toolbar {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f1f3f4;
        border-radius: 5px;
        border: 1px solid #e1e5e9;
      }

      .editor-toolbar .btn {
        margin-right: 5px;
        margin-bottom: 5px;
      }

      #uploaded-template-preview {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background-color: #f8f9fa;
        border: 1px solid #e1e5e9;
      }
    </style>

    <!-- JavaScript for Settings Functionality -->
    <script>
      class TemplateSettings {
        constructor() {
          this.init();
        }

        init() {
          // Wait for auth manager to be ready
          document.addEventListener('DOMContentLoaded', () => {
            this.setupEventListeners();
            this.loadSettings();
            this.updateUsernameDisplay();
          });
        }

        setupEventListeners() {
          document.getElementById('template-source').addEventListener('change', (e) => this.handleSourceChange(e.target.value));
          document.getElementById('test-template-git-connection').addEventListener('click', () => this.testTemplateGitConnection());
          document.getElementById('template-file-upload').addEventListener('change', (e) => this.handleFileUpload(e));
          document.getElementById('save-template-settings').addEventListener('click', () => this.saveSettings());
          document.getElementById('reset-template-settings').addEventListener('click', () => this.resetSettings());
          document.getElementById('preview-template').addEventListener('click', () => this.previewTemplate());
        }

        handleSourceChange(source) {
          // Hide all config sections
          document.querySelectorAll('.template-config-section').forEach(section => {
            section.style.display = 'none';
          });

          // Show selected config section
          if (source === 'git') {
            document.getElementById('git-config-section').style.display = 'block';
            document.getElementById('preview-template').style.display = 'none';
          } else if (source === 'file') {
            document.getElementById('file-config-section').style.display = 'block';
            document.getElementById('preview-template').style.display = 'none';
          } else if (source === 'webeditor') {
            document.getElementById('webeditor-config-section').style.display = 'block';
            document.getElementById('preview-template').style.display = 'inline-block';
          }
        }

        async loadSettings() {
          if (!window.authManager) {
            setTimeout(() => this.loadSettings(), 500);
            return;
          }

          try {
            const response = await window.authManager.apiRequest('/api/settings/templates');
            if (response.success) {
              this.populateForm(response.data);
            }
          } catch (error) {
            console.error('Error loading template settings:', error);
          }
        }

        populateForm(settings) {
          // Template source
          document.getElementById('template-source').value = settings.template_source || '';
          this.handleSourceChange(settings.template_source || '');

          // Git settings
          document.getElementById('template-git-repo-url').value = settings.template_git_repo_url || '';
          document.getElementById('template-git-branch').value = settings.template_git_branch || 'main';
          document.getElementById('template-git-username').value = settings.template_git_username || '';
          document.getElementById('template-git-token').value = settings.template_git_token || '';
          document.getElementById('template-path').value = settings.template_path || 'templates/';
          document.getElementById('template-git-verify-ssl').checked = settings.template_git_verify_ssl !== false;

          // Web editor settings
          document.getElementById('template-name').value = settings.template_name || '';
          document.getElementById('template-type').value = settings.template_type || 'jinja2';
          document.getElementById('template-category').value = settings.template_category || '';
          document.getElementById('template-description').value = settings.template_description || '';
          document.getElementById('template-content').value = settings.template_content || '';
        }

        async testTemplateGitConnection() {
          const statusElement = document.getElementById('template-git-connection-status');
          statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
          
          try {
            const response = await window.authManager.apiRequest('/api/templates/git/test');
            if (response.success) {
              statusElement.innerHTML = '<span class="text-success"><i class="fas fa-check"></i> Template Git connection successful!</span>';
            } else {
              statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times"></i> ${response.message}</span>`;
            }
          } catch (error) {
            statusElement.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> Template Git connection failed</span>';
          }
        }

        handleFileUpload(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('uploaded-template-preview').value = e.target.result;
            };
            reader.readAsText(file);
          }
        }

        async saveSettings() {
          const source = document.getElementById('template-source').value;
          if (!source) {
            this.showStatus('Please select a template source', 'error');
            return;
          }

          const settings = {
            template_source: source
          };

          // Add source-specific settings
          if (source === 'git') {
            settings.template_git_repo_url = document.getElementById('template-git-repo-url').value;
            settings.template_git_branch = document.getElementById('template-git-branch').value;
            settings.template_git_username = document.getElementById('template-git-username').value;
            settings.template_git_token = document.getElementById('template-git-token').value;
            settings.template_path = document.getElementById('template-path').value;
            settings.template_git_verify_ssl = document.getElementById('template-git-verify-ssl').checked;
          } else if (source === 'file') {
            const fileContent = document.getElementById('uploaded-template-preview').value;
            if (fileContent) {
              settings.template_file_content = fileContent;
            }
          } else if (source === 'webeditor') {
            settings.template_name = document.getElementById('template-name').value;
            settings.template_type = document.getElementById('template-type').value;
            settings.template_category = document.getElementById('template-category').value;
            settings.template_description = document.getElementById('template-description').value;
            settings.template_content = document.getElementById('template-content').value;
          }

          try {
            const response = await window.authManager.apiRequest('/api/settings/templates', {
              method: 'POST',
              body: JSON.stringify(settings)
            });

            if (response.success) {
              this.showStatus('Template settings saved successfully!', 'success');
            } else {
              this.showStatus('Failed to save settings: ' + response.message, 'error');
            }
          } catch (error) {
            this.showStatus('Error saving settings: ' + error.message, 'error');
          }
        }

        resetSettings() {
          document.getElementById('template-source').value = '';
          this.handleSourceChange('');
          
          // Reset git settings
          document.getElementById('template-git-repo-url').value = '';
          document.getElementById('template-git-branch').value = 'main';
          document.getElementById('template-git-username').value = '';
          document.getElementById('template-git-token').value = '';
          document.getElementById('template-path').value = 'templates/';
          document.getElementById('template-git-verify-ssl').checked = true;
          
          // Reset file settings
          document.getElementById('template-file-upload').value = '';
          document.getElementById('uploaded-template-preview').value = '';
          
          // Reset web editor settings
          document.getElementById('template-name').value = '';
          document.getElementById('template-type').value = 'jinja2';
          document.getElementById('template-category').value = '';
          document.getElementById('template-description').value = '';
          document.getElementById('template-content').value = '';
          
          this.showStatus('Template settings reset to defaults', 'info');
        }

        previewTemplate() {
          const content = document.getElementById('template-content').value;
          if (!content.trim()) {
            this.showStatus('Please enter template content first', 'error');
            return;
          }

          // Simple preview - in a real implementation, this would render the template
          const previewWindow = window.open('', '_blank', 'width=800,height=600');
          previewWindow.document.write(`
            <html>
              <head>
                <title>Template Preview</title>
                <style>
                  body { font-family: monospace; margin: 20px; }
                  pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; }
                </style>
              </head>
              <body>
                <h2>Template Preview</h2>
                <pre>${content}</pre>
              </body>
            </html>
          `);
        }

        showStatus(message, type) {
          const statusDiv = document.getElementById('status-message');
          const alertClass = type === 'success' ? 'alert-success' : 
                           type === 'error' ? 'alert-danger' : 'alert-info';
          
          statusDiv.className = `alert ${alertClass}`;
          statusDiv.innerHTML = message;
          statusDiv.style.display = 'block';
          
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        }

        updateUsernameDisplay() {
          // Update username in sidebar and navbar
          const userInfo = localStorage.getItem('user_info');
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              const sidebarElement = document.getElementById('sidebar-username');
              const navbarElement = document.getElementById('navbar-username');
              
              const displayName = user.full_name || user.username || 'User';
              
              if (sidebarElement) sidebarElement.textContent = displayName;
              if (navbarElement) navbarElement.textContent = displayName;
            } catch (e) {
              console.log('Error parsing user info:', e);
            }
          }
        }
      }

      // Helper functions for web editor
      function insertText(before, after = '') {
        const textarea = document.getElementById('template-content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        const newText = before + selectedText + after;
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        
        // Move cursor to end of inserted text
        const newCursorPos = start + newText.length;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
      }

      function formatTemplate() {
        const textarea = document.getElementById('template-content');
        let content = textarea.value;
        
        // Basic formatting - add proper indentation and line breaks
        content = content.replace(/({%[^%]+%})/g, '\n$1\n');
        content = content.replace(/(\n\s*\n)/g, '\n');
        content = content.trim();
        
        textarea.value = content;
      }

      // Initialize settings when page loads
      const templateSettings = new TemplateSettings();

      function logout() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login.html';
      }
    </script>
  </body>
</html>
