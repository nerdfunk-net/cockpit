<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Template Management - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    
    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- Container configuration (if in container mode) -->
    <script>
      // Load container config if in container environment
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        const script = document.createElement('script');
        script.src = 'js/config-container.js';
        document.head.appendChild(script);
      }
    </script>
    <!-- API Manager -->
    <script src="js/api-manager.js"></script>
    <script>
      // Robust authentication check
      (function() {
        console.log('Checking authentication...');
        
        // Check if we have a valid token
        const token = localStorage.getItem('auth_token');
        console.log('Token found:', !!token);
        
        if (!token) {
          console.log('No token found, redirecting to login');
          // Use absolute path to ensure proper redirect
          window.location.href = '/login.html';
          return;
        }
        
        console.log('Token found, user authenticated');
      })();
    </script>
    <script src="js/auth.js"></script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><i class="fas fa-tachometer-alt"></i> <span>Cockpit</span></a>
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic">
                <img src="images/img.jpg" alt="..." class="img-circle profile_img">
              </div>
              <div class="profile_info">
                <span>Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li><a><i class="fas fa-home"></i> Home <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="index.html">Dashboard</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-cogs"></i> Operations <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="onboard-device.html"><i class="fas fa-plus-circle"></i> Onboard Device</a></li>
                      <li><a href="compare.html"><i class="fas fa-balance-scale"></i> Compare Configs</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-wrench"></i> Settings <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="settings-nautobot.html"><i class="fas fa-server"></i> Nautobot</a></li>
                      <li><a href="settings-configs.html"><i class="fas fa-code-branch"></i> Configs</a></li>
                      <li><a href="settings-templates.html" class="current-page"><i class="fas fa-file-code"></i> Templates</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a href="settings-templates.html" data-bs-toggle="tooltip" data-bs-placement="top" title="Settings">
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="FullScreen">
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Logout" href="login.html">
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px;">
                  <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <div class="dropdown-menu dropdown-usermenu pull-right" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="javascript:;" onclick="logout()"> Logout</a>
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Template Management</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <!-- Template Management Content -->
            <div class="row">
              <div class="col-md-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2><i class="fas fa-file-code"></i> Template Management</h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">

                    <!-- Status Message -->
                    <div id="status-message" class="alert" style="display: none;"></div>

                    <!-- Template Management Tabs -->
                    <div class="x_panel">
                      <div class="x_title">
                        <ul class="nav nav-tabs bar_tabs" id="templateTabs" role="tablist">
                          <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="templates-list-tab" data-bs-toggle="tab" href="#templates-list" role="tab">
                              <i class="fas fa-list"></i> Templates List
                            </a>
                          </li>
                          <li class="nav-item" role="presentation">
                            <a class="nav-link" id="create-template-tab" data-bs-toggle="tab" href="#create-template" role="tab">
                              <i class="fas fa-plus"></i> Create Template
                            </a>
                          </li>
                          <li class="nav-item" role="presentation">
                            <a class="nav-link" id="import-templates-tab" data-bs-toggle="tab" href="#import-templates" role="tab">
                              <i class="fas fa-download"></i> Import Templates
                            </a>
                          </li>
                        </ul>
                        <div class="clearfix"></div>
                      </div>
                      <div class="x_content">
                        <div class="tab-content" id="templateTabsContent">
                          
                          <!-- Templates List Tab -->
                          <div class="tab-pane fade show active" id="templates-list" role="tabpanel">
                            <div class="row">
                              <div class="col-md-12">
                                <div class="row mb-3">
                                  <div class="col-md-4">
                                    <input type="text" id="template-search" class="form-control" placeholder="Search templates...">
                                  </div>
                                  <div class="col-md-3">
                                    <select id="filter-category" class="form-control">
                                      <option value="">All Categories</option>
                                    </select>
                                  </div>
                                  <div class="col-md-3">
                                    <select id="filter-source" class="form-control">
                                      <option value="">All Sources</option>
                                      <option value="git">Git Repository</option>
                                      <option value="file">File Upload</option>
                                      <option value="webeditor">Web Editor</option>
                                    </select>
                                  </div>
                                  <div class="col-md-2">
                                    <button type="button" id="refresh-templates" class="btn btn-primary btn-block">
                                      <i class="fas fa-sync"></i> Refresh
                                    </button>
                                  </div>
                                </div>
                                
                                <div class="table-responsive">
                                  <table class="table table-striped table-bordered">
                                    <thead>
                                      <tr>
                                        <th>Name</th>
                                        <th>Source</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Updated</th>
                                        <th>Actions</th>
                                      </tr>
                                    </thead>
                                    <tbody id="templates-table-body">
                                      <!-- Templates will be loaded here -->
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Create Template Tab -->
                          <div class="tab-pane fade" id="create-template" role="tabpanel">
                            <form id="create-template-form">
                              <div class="row">
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label for="new-template-name" class="control-label">Template Name <span class="required">*</span></label>
                                    <input type="text" id="new-template-name" class="form-control" required placeholder="e.g., cisco-ios-base">
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label for="new-template-source" class="control-label">Source <span class="required">*</span></label>
                                    <select id="new-template-source" class="form-control" required>
                                      <option value="">Select source...</option>
                                      <option value="git">Git Repository</option>
                                      <option value="file">File Upload</option>
                                      <option value="webeditor">Web Editor</option>
                                    </select>
                                  </div>
                                </div>
                              </div>

                              <div class="row">
                                <div class="col-md-4">
                                  <div class="form-group">
                                    <label for="new-template-type" class="control-label">Template Type</label>
                                    <select id="new-template-type" class="form-control">
                                      <option value="jinja2">Jinja2</option>
                                      <option value="text">Plain Text</option>
                                      <option value="yaml">YAML</option>
                                      <option value="json">JSON</option>
                                    </select>
                                  </div>
                                </div>
                                <div class="col-md-4">
                                  <div class="form-group">
                                    <label for="new-template-category" class="control-label">Category</label>
                                    <input type="text" id="new-template-category" class="form-control" placeholder="e.g., Network, Security">
                                  </div>
                                </div>
                                <div class="col-md-4">
                                  <div class="form-group">
                                    <label for="new-template-description" class="control-label">Description</label>
                                    <input type="text" id="new-template-description" class="form-control" placeholder="Brief description">
                                  </div>
                                </div>
                              </div>

                              <!-- Source-specific sections -->
                              <div id="new-git-config" class="source-config-section" style="display: none;">
                                <h4><i class="fas fa-code-branch"></i> Git Repository Configuration</h4>
                                <div class="row">
                                  <div class="col-md-6">
                                    <div class="form-group">
                                      <label for="new-git-repo-url" class="control-label">Repository URL <span class="required">*</span></label>
                                      <input type="url" id="new-git-repo-url" class="form-control" placeholder="https://github.com/user/repo.git">
                                    </div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="form-group">
                                      <label for="new-git-branch" class="control-label">Branch</label>
                                      <input type="text" id="new-git-branch" class="form-control" value="main">
                                    </div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="form-group">
                                      <label for="new-git-path" class="control-label">File Path</label>
                                      <input type="text" id="new-git-path" class="form-control" placeholder="templates/config.j2">
                                    </div>
                                  </div>
                                </div>
                                <div class="row">
                                  <div class="col-md-6">
                                    <div class="form-group">
                                      <label for="new-git-username" class="control-label">Username</label>
                                      <input type="text" id="new-git-username" class="form-control">
                                    </div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="form-group">
                                      <label for="new-git-token" class="control-label">Token</label>
                                      <input type="password" id="new-git-token" class="form-control">
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <div id="new-file-config" class="source-config-section" style="display: none;">
                                <h4><i class="fas fa-file-upload"></i> File Upload</h4>
                                <div class="form-group">
                                  <label for="new-template-file" class="control-label">Template File</label>
                                  <input type="file" id="new-template-file" class="form-control" accept=".txt,.conf,.cfg,.j2,.jinja2,.yaml,.yml,.json">
                                </div>
                              </div>

                              <div id="new-webeditor-config" class="source-config-section" style="display: none;">
                                <h4><i class="fas fa-edit"></i> Web Editor</h4>
                                <div class="form-group">
                                  <label for="new-template-content" class="control-label">Template Content <span class="required">*</span></label>
                                  <textarea id="new-template-content" class="form-control template-editor" rows="15" placeholder="Enter your template content here..."></textarea>
                                </div>
                              </div>

                              <div class="row">
                                <div class="col-md-12">
                                  <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Create Template
                                  </button>
                                  <button type="button" id="reset-create-form" class="btn btn-secondary ml-2">
                                    <i class="fas fa-undo"></i> Reset
                                  </button>
                                </div>
                              </div>
                            </form>
                          </div>

                          <!-- Import Templates Tab -->
                          <div class="tab-pane fade" id="import-templates" role="tabpanel">
                            <div class="row">
                              <div class="col-md-12">
                                <h4><i class="fas fa-download"></i> Bulk Import Templates</h4>
                                <p class="text-muted">Import multiple templates from Git repositories or file uploads.</p>
                                
                                <div class="form-group">
                                  <label for="import-source-type" class="control-label">Import Source</label>
                                  <select id="import-source-type" class="form-control">
                                    <option value="">Select import source...</option>
                                    <option value="git_bulk">Git Repository (Bulk)</option>
                                    <option value="file_bulk">Multiple Files</option>
                                  </select>
                                </div>

                                <div id="import-git-config" class="import-config-section" style="display: none;">
                                  <h5>Git Repository Bulk Import</h5>
                                  <div class="row">
                                    <div class="col-md-8">
                                      <div class="form-group">
                                        <label for="import-git-repo" class="control-label">Repository URL</label>
                                        <input type="url" id="import-git-repo" class="form-control" placeholder="https://github.com/user/templates.git">
                                      </div>
                                    </div>
                                    <div class="col-md-4">
                                      <div class="form-group">
                                        <label for="import-git-branch" class="control-label">Branch</label>
                                        <input type="text" id="import-git-branch" class="form-control" value="main">
                                      </div>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-md-6">
                                      <div class="form-group">
                                        <label for="import-git-path" class="control-label">Templates Path</label>
                                        <input type="text" id="import-git-path" class="form-control" value="templates/" placeholder="templates/">
                                      </div>
                                    </div>
                                    <div class="col-md-6">
                                      <div class="form-group">
                                        <label for="import-default-category" class="control-label">Default Category</label>
                                        <input type="text" id="import-default-category" class="form-control" placeholder="Imported">
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <div id="import-file-config" class="import-config-section" style="display: none;">
                                  <h5>Multiple Files Import</h5>
                                  <div class="form-group">
                                    <label for="import-template-files" class="control-label">Template Files</label>
                                    <input type="file" id="import-template-files" class="form-control" multiple accept=".txt,.conf,.cfg,.j2,.jinja2,.yaml,.yml,.json">
                                    <small class="form-text text-muted">Select multiple template files to import</small>
                                  </div>
                                </div>

                                <div class="row">
                                  <div class="col-md-6">
                                    <div class="form-group">
                                      <div class="form-check">
                                        <input type="checkbox" id="import-overwrite" class="form-check-input">
                                        <label for="import-overwrite" class="form-check-label">Overwrite existing templates</label>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <button type="button" id="start-import" class="btn btn-primary">
                                  <i class="fas fa-download"></i> Start Import
                                </button>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            <!-- /Template Management Content -->

          </div>
        </div>
        <!-- /page content -->
      </div>
    </div>

    <!-- Template Edit Modal -->
    <div class="modal fade" id="editTemplateModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="editTemplateModalLabel">Edit Template</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="edit-template-form">
              <input type="hidden" id="edit-template-id">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="edit-template-name" class="control-label">Template Name</label>
                    <input type="text" id="edit-template-name" class="form-control" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="edit-template-category" class="control-label">Category</label>
                    <input type="text" id="edit-template-category" class="form-control">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="edit-template-description" class="control-label">Description</label>
                <input type="text" id="edit-template-description" class="form-control">
              </div>
              <div class="form-group">
                <label for="edit-template-content" class="control-label">Template Content</label>
                <textarea id="edit-template-content" class="form-control template-editor" rows="20"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="save-template-edit">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom styles for current page indication -->
    <style>
      .current-page {
        background-color: #2A3F54 !important;
        color: #fff !important;
        border-radius: 3px;
      }
      
      .current-page:hover {
        background-color: #1e2b3a !important;
      }

      /* Top status message styling */
      #status-message {
        margin-top: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-weight: 500;
      }

      .template-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        min-height: 300px;
        resize: vertical;
      }

      .source-config-section, .import-config-section {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #e6e9ed;
        border-radius: 5px;
        background-color: #f8f9fa;
      }

      .required {
        color: red;
      }

      .nav-tabs .nav-link {
        color: #73879C;
      }

      .nav-tabs .nav-link.active {
        color: #2A3F54;
        font-weight: 600;
      }

      .table-responsive {
        margin-top: 20px;
      }

      .btn-group-sm > .btn, .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }
    </style>

    <!-- JavaScript for Template Management -->
    <script>
      class TemplateManager {
        constructor() {
          this.templates = [];
          this.categories = [];
          this.currentEditId = null;
          this.init();
        }

        init() {
          // Wait for auth manager to be ready
          document.addEventListener('DOMContentLoaded', () => {
            this.setupEventListeners();
            this.loadTemplates();
            this.loadCategories();
            this.updateUsernameDisplay();
          });
        }

        setupEventListeners() {
          // Search and filters
          document.getElementById('template-search').addEventListener('input', () => this.filterTemplates());
          document.getElementById('filter-category').addEventListener('change', () => this.filterTemplates());
          document.getElementById('filter-source').addEventListener('change', () => this.filterTemplates());
          document.getElementById('refresh-templates').addEventListener('click', () => this.loadTemplates());

          // Create template form
          document.getElementById('new-template-source').addEventListener('change', (e) => this.handleSourceChange(e.target.value, 'new'));
          document.getElementById('create-template-form').addEventListener('submit', (e) => this.handleCreateTemplate(e));
          document.getElementById('reset-create-form').addEventListener('click', () => this.resetCreateForm());

          // Import
          document.getElementById('import-source-type').addEventListener('change', (e) => this.handleImportSourceChange(e.target.value));
          document.getElementById('start-import').addEventListener('click', () => this.handleImport());

          // Edit modal
          document.getElementById('save-template-edit').addEventListener('click', () => this.saveTemplateEdit());
        }

        async loadTemplates() {
          if (!window.authManager) {
            setTimeout(() => this.loadTemplates(), 500);
            return;
          }

          try {
            const response = await window.authManager.apiRequest('/api/templates');
            if (response.templates) {
              this.templates = response.templates;
              this.renderTemplatesTable();
            }
          } catch (error) {
            console.error('Error loading templates:', error);
            this.showStatus('Error loading templates: ' + error.message, 'error');
          }
        }

        async loadCategories() {
          if (!window.authManager) {
            setTimeout(() => this.loadCategories(), 500);
            return;
          }

          try {
            const categories = await window.authManager.apiRequest('/api/templates/categories');
            this.categories = categories;
            this.updateCategoryFilters();
          } catch (error) {
            console.error('Error loading categories:', error);
          }
        }

        updateCategoryFilters() {
          const filterSelect = document.getElementById('filter-category');
          const existingOptions = filterSelect.querySelectorAll('option:not([value=""])');
          existingOptions.forEach(option => option.remove());

          this.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            filterSelect.appendChild(option);
          });
        }

        renderTemplatesTable() {
          const tbody = document.getElementById('templates-table-body');
          tbody.innerHTML = '';

          if (this.templates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No templates found</td></tr>';
            return;
          }

          this.templates.forEach(template => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${template.name}</strong></td>
              <td><span class="badge badge-${this.getSourceBadgeClass(template.source)}">${template.source}</span></td>
              <td>${template.template_type}</td>
              <td>${template.category || '-'}</td>
              <td>${template.description || '-'}</td>
              <td>${new Date(template.updated_at).toLocaleDateString()}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-info btn-sm" onclick="templateManager.viewTemplate(${template.id})" title="View">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-warning btn-sm" onclick="templateManager.editTemplate(${template.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="templateManager.deleteTemplate(${template.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                  ${template.source === 'git' ? `<button class="btn btn-success btn-sm" onclick="templateManager.syncTemplate(${template.id})" title="Sync"><i class="fas fa-sync"></i></button>` : ''}
                </div>
              </td>
            `;
            tbody.appendChild(row);
          });
        }

        getSourceBadgeClass(source) {
          switch (source) {
            case 'git': return 'success';
            case 'file': return 'info';
            case 'webeditor': return 'warning';
            default: return 'secondary';
          }
        }

        filterTemplates() {
          const search = document.getElementById('template-search').value.toLowerCase();
          const category = document.getElementById('filter-category').value;
          const source = document.getElementById('filter-source').value;

          const filtered = this.templates.filter(template => {
            const matchesSearch = template.name.toLowerCase().includes(search) ||
                                (template.description && template.description.toLowerCase().includes(search));
            const matchesCategory = !category || template.category === category;
            const matchesSource = !source || template.source === source;
            
            return matchesSearch && matchesCategory && matchesSource;
          });

          // Temporarily store original templates and render filtered
          const originalTemplates = this.templates;
          this.templates = filtered;
          this.renderTemplatesTable();
          this.templates = originalTemplates;
        }

        handleSourceChange(source, prefix = '') {
          // Hide all config sections
          document.querySelectorAll('.source-config-section').forEach(section => {
            section.style.display = 'none';
          });

          // Show selected config section
          if (source === 'git') {
            document.getElementById(prefix + '-git-config').style.display = 'block';
          } else if (source === 'file') {
            document.getElementById(prefix + '-file-config').style.display = 'block';
          } else if (source === 'webeditor') {
            document.getElementById(prefix + '-webeditor-config').style.display = 'block';
          }
        }

        async handleCreateTemplate(event) {
          event.preventDefault();
          
          const source = document.getElementById('new-template-source').value;
          if (!source) {
            this.showStatus('Please select a template source', 'error');
            return;
          }

          const templateData = {
            name: document.getElementById('new-template-name').value,
            source: source,
            template_type: document.getElementById('new-template-type').value,
            category: document.getElementById('new-template-category').value,
            description: document.getElementById('new-template-description').value
          };

          // Add source-specific data
          if (source === 'git') {
            templateData.git_repo_url = document.getElementById('new-git-repo-url').value;
            templateData.git_branch = document.getElementById('new-git-branch').value;
            templateData.git_path = document.getElementById('new-git-path').value;
            templateData.git_username = document.getElementById('new-git-username').value;
            templateData.git_token = document.getElementById('new-git-token').value;
          } else if (source === 'webeditor') {
            templateData.content = document.getElementById('new-template-content').value;
          } else if (source === 'file') {
            const fileInput = document.getElementById('new-template-file');
            if (fileInput.files.length > 0) {
              const file = fileInput.files[0];
              templateData.filename = file.name;
              templateData.content = await this.readFileContent(file);
            }
          }

          try {
            const response = await window.authManager.apiRequest('/api/templates', {
              method: 'POST',
              body: JSON.stringify(templateData)
            });

            if (response.id) {
              this.showStatus('Template created successfully!', 'success');
              this.resetCreateForm();
              this.loadTemplates();
              // Switch to templates list tab
              document.getElementById('templates-list-tab').click();
            }
          } catch (error) {
            this.showStatus('Error creating template: ' + error.message, 'error');
          }
        }

        resetCreateForm() {
          document.getElementById('create-template-form').reset();
          document.querySelectorAll('.source-config-section').forEach(section => {
            section.style.display = 'none';
          });
        }

        handleImportSourceChange(sourceType) {
          document.querySelectorAll('.import-config-section').forEach(section => {
            section.style.display = 'none';
          });

          if (sourceType === 'git_bulk') {
            document.getElementById('import-git-config').style.display = 'block';
          } else if (sourceType === 'file_bulk') {
            document.getElementById('import-file-config').style.display = 'block';
          }
        }

        async handleImport() {
          const sourceType = document.getElementById('import-source-type').value;
          if (!sourceType) {
            this.showStatus('Please select an import source', 'error');
            return;
          }

          const importData = {
            source_type: sourceType,
            overwrite_existing: document.getElementById('import-overwrite').checked
          };

          if (sourceType === 'git_bulk') {
            importData.git_repo_url = document.getElementById('import-git-repo').value;
            importData.git_branch = document.getElementById('import-git-branch').value;
            importData.git_templates_path = document.getElementById('import-git-path').value;
            importData.default_category = document.getElementById('import-default-category').value;
          } else if (sourceType === 'file_bulk') {
            const fileInput = document.getElementById('import-template-files');
            if (fileInput.files.length === 0) {
              this.showStatus('Please select files to import', 'error');
              return;
            }

            importData.file_contents = [];
            for (const file of fileInput.files) {
              const content = await this.readFileContent(file);
              importData.file_contents.push({
                filename: file.name,
                content: content
              });
            }
            importData.default_category = document.getElementById('import-default-category').value;
          }

          try {
            const response = await window.authManager.apiRequest('/api/templates/import', {
              method: 'POST',
              body: JSON.stringify(importData)
            });

            this.showStatus(response.message, 'success');
            this.loadTemplates();
            this.loadCategories();
          } catch (error) {
            this.showStatus('Error importing templates: ' + error.message, 'error');
          }
        }

        readFileContent(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
          });
        }

        async viewTemplate(templateId) {
          try {
            const response = await window.authManager.apiRequest(`/api/templates/${templateId}/content`);
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
              <html>
                <head>
                  <title>Template Preview</title>
                  <style>
                    body { font-family: monospace; margin: 20px; }
                    pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; }
                  </style>
                </head>
                <body>
                  <h2>Template Preview</h2>
                  <pre>${response.content}</pre>
                </body>
              </html>
            `);
          } catch (error) {
            this.showStatus('Error viewing template: ' + error.message, 'error');
          }
        }

        async editTemplate(templateId) {
          try {
            const template = await window.authManager.apiRequest(`/api/templates/${templateId}`);
            const content = await window.authManager.apiRequest(`/api/templates/${templateId}/content`);
            
            this.currentEditId = templateId;
            document.getElementById('edit-template-id').value = templateId;
            document.getElementById('edit-template-name').value = template.name;
            document.getElementById('edit-template-category').value = template.category || '';
            document.getElementById('edit-template-description').value = template.description || '';
            document.getElementById('edit-template-content').value = content.content || '';
            
            $('#editTemplateModal').modal('show');
          } catch (error) {
            this.showStatus('Error loading template for edit: ' + error.message, 'error');
          }
        }

        async saveTemplateEdit() {
          if (!this.currentEditId) return;

          const templateData = {
            name: document.getElementById('edit-template-name').value,
            category: document.getElementById('edit-template-category').value,
            description: document.getElementById('edit-template-description').value,
            content: document.getElementById('edit-template-content').value
          };

          try {
            await window.authManager.apiRequest(`/api/templates/${this.currentEditId}`, {
              method: 'PUT',
              body: JSON.stringify(templateData)
            });

            this.showStatus('Template updated successfully!', 'success');
            $('#editTemplateModal').modal('hide');
            this.loadTemplates();
          } catch (error) {
            this.showStatus('Error updating template: ' + error.message, 'error');
          }
        }

        async deleteTemplate(templateId) {
          if (!confirm('Are you sure you want to delete this template?')) return;

          try {
            await window.authManager.apiRequest(`/api/templates/${templateId}`, {
              method: 'DELETE'
            });

            this.showStatus('Template deleted successfully!', 'success');
            this.loadTemplates();
          } catch (error) {
            this.showStatus('Error deleting template: ' + error.message, 'error');
          }
        }

        async syncTemplate(templateId) {
          try {
            const response = await window.authManager.apiRequest('/api/templates/sync', {
              method: 'POST',
              body: JSON.stringify({ template_id: templateId })
            });

            this.showStatus(response.message, 'success');
            this.loadTemplates();
          } catch (error) {
            this.showStatus('Error syncing template: ' + error.message, 'error');
          }
        }

        showStatus(message, type) {
          const statusDiv = document.getElementById('status-message');
          const alertClass = type === 'success' ? 'alert-success' : 
                           type === 'error' ? 'alert-danger' : 'alert-info';
          
          statusDiv.className = `alert ${alertClass}`;
          statusDiv.innerHTML = message;
          statusDiv.style.display = 'block';
          
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        }

        updateUsernameDisplay() {
          // Update username in sidebar and navbar
          const userInfo = localStorage.getItem('user_info');
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              const sidebarElement = document.getElementById('sidebar-username');
              const navbarElement = document.getElementById('navbar-username');
              
              const displayName = user.full_name || user.username || 'User';
              
              if (sidebarElement) sidebarElement.textContent = displayName;
              if (navbarElement) navbarElement.textContent = displayName;
            } catch (e) {
              console.log('Error parsing user info:', e);
            }
          }
        }
      }

      // Initialize template manager when page loads
      const templateManager = new TemplateManager();

      function logout() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login.html';
      }
    </script>
  </body>
</html>
