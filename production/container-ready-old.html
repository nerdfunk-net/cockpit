<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Cockpit - Network Management</title>

    <!-- Static CSS (offline-ready) -->
    <link rel="stylesheet" href="static/css/fontawesome.min.css">
    
    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>
    
    <!-- Configuration (offline-ready) -->
    <script src="js/config.js"></script>
    <!-- Container configuration (automatically loaded in container mode) -->
    <script src="js/config-container.js"></script>
    <!-- API Manager -->
    <script src="js/api-manager.js"></script>
    
    <script>
      // Container mode authentication check
      (function() {
        console.log('ðŸ” Container mode - Checking authentication...');
        
        const token = localStorage.getItem('auth_token');
        if (!token) {
          console.log('No token found, redirecting to login');
          window.location.href = '/login.html';
          return;
        }
        
        // Verify token is still valid
        window.offlineFetch('/auth/verify', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }).then(response => {
          if (!response.ok) {
            console.log('Token invalid, redirecting to login');
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
          }
        }).catch(error => {
          console.warn('Token verification failed (offline mode):', error);
          // In offline mode, allow access if token exists
        });
      })();
    </script>
    
    <style>
      /* Container mode specific styles */
      body.container-mode {
        font-family: "Helvetica Neue", Roboto, Arial, "Droid Sans", sans-serif;
      }
      
      /* Offline indicator */
      .offline-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #f39c12;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 9999;
        display: none;
      }
      
      .offline-indicator.offline {
        display: block;
        background: #e74c3c;
      }
      
      .offline-indicator.online {
        display: block;
        background: #27ae60;
        animation: fadeOut 3s forwards;
      }
      
      @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; display: none; }
      }
    </style>
  </head>

  <body class="nav-md">
    <!-- Offline indicator -->
    <div id="offline-indicator" class="offline-indicator">
      <span id="offline-text">ðŸ”´ Offline Mode</span>
    </div>

    <div class="container body">
      <div class="main_container">
        <!-- Main content will be loaded here -->
        <div id="main-content">
          <div class="right_col" role="main">
            <div class="row">
              <div class="col-md-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>Cockpit - Container Mode</h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p>Welcome to Cockpit running in container mode.</p>
                    <p><strong>Status:</strong> <span id="connection-status">Checking...</span></p>
                    <p><strong>Backend:</strong> <span id="backend-url"></span></p>
                    <p><strong>Mode:</strong> <span id="app-mode"></span></p>
                    
                    <div class="btn-group" role="group">
                      <a href="onboard-device.html" class="btn btn-primary">
                        <i class="fa fa-plus"></i> Onboard Device
                      </a>
                      <a href="sync_devices.html" class="btn btn-info">
                        <i class="fa fa-sync"></i> Sync Devices
                      </a>
                      <button onclick="clearOfflineCache()" class="btn btn-warning">
                        <i class="fa fa-trash"></i> Clear Cache
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize container mode interface
      document.addEventListener('DOMContentLoaded', () => {
        // Update status information
        document.getElementById('backend-url').textContent = CockpitConfig.api.baseUrl;
        document.getElementById('app-mode').textContent = 
          CockpitConfig.environment.isContainer ? 'Container' : 
          CockpitConfig.environment.isDevelopment ? 'Development' : 'Production';
        
        updateConnectionStatus();
        
        // Listen for connection status changes
        window.addEventListener('connectionStatusChanged', (event) => {
          updateConnectionStatus(event.detail);
        });
        
        // Update status every 30 seconds
        setInterval(updateConnectionStatus, 30000);
      });
      
      function updateConnectionStatus(detail = null) {
        const statusEl = document.getElementById('connection-status');
        const indicatorEl = document.getElementById('offline-indicator');
        const textEl = document.getElementById('offline-text');
        
        const isOffline = detail ? detail.isOffline : !navigator.onLine;
        
        if (isOffline) {
          statusEl.innerHTML = '<span style="color: #e74c3c;"><i class="fa fa-times-circle"></i> Offline</span>';
          indicatorEl.className = 'offline-indicator offline';
          textEl.textContent = 'ðŸ”´ Offline Mode';
        } else {
          statusEl.innerHTML = '<span style="color: #27ae60;"><i class="fa fa-check-circle"></i> Online</span>';
          indicatorEl.className = 'offline-indicator online';
          textEl.textContent = 'ðŸŸ¢ Online';
        }
      }
      
      function clearOfflineCache() {
        if (confirm('Clear all offline cache data?')) {
          window.OfflineManager.clearCache();
          alert('Cache cleared successfully!');
        }
      }
    </script>
  </body>
</html>
